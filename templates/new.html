<!doctype html>
<html lang="ru" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>explAiner — Legal AI Assistant</title>
  <meta name="description" content="explAiner — Legal AI: чат, документы, комплаенс и видео/аудио объяснения. Не является юридической консультацией." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg width='120' height='120' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='120' height='120' rx='24' fill='%231a56db'/%3E%3Ctext x='50%' y='54%' text-anchor='middle' font-size='64' font-family='Arial' fill='white'%3Ee%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: ['class', '[data-theme="dark"]'],
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#eef5ff',
              100: '#d9e8ff',
              200: '#b7d2ff',
              300: '#86b3ff',
              400: '#4b86ff',
              500: '#1a56db',
              600: '#153fb0',
              700: '#133790',
              800: '#132f73',
              900: '#112758'
            }
          }
        }
      }
    }
  </script>
  <!-- Mermaid for flowcharts -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" onerror="window.mermaid = {initialize: function() {}, run: function() { return Promise.resolve(); }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.mermaid && typeof window.mermaid.initialize === 'function') {
        window.mermaid.initialize({ startOnLoad: false, theme: "neutral" });
      }
    });
  </script>
  <!-- Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" onerror="window.marked = {parse: function(text) { 
    let html = text || '';
    // Заменяем переносы строк
    html = html.replace(/\n\n/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    // Обрабатываем базовый markdown
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    html = html.replace(/`(.*?)`/g, '<code>$1</code>');
    // Обрабатываем списки
    html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    // Оборачиваем в параграфы если нужно
    if (!html.includes('<p>') && !html.includes('<ul>')) {
      html = '<p>' + html + '</p>';
    }
    return html;
  }}"></script>
  <!-- Syntax highlight -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css" onerror="this.remove()">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js" onerror="window.hljs = {highlightElement: function() {}}"></script>
  <!-- Diff for contract comparison -->
  <script>
    // Simple diff implementation fallback
    window.diff_match_patch = function() {
      this.diff_main = function(text1, text2) {
        // Simple word-based diff for fallback
        const words1 = text1.split(/\s+/);
        const words2 = text2.split(/\s+/);
        const result = [];
        
        let i = 0, j = 0;
        while (i < words1.length || j < words2.length) {
          if (i >= words1.length) {
            result.push([1, words2[j] + ' ']);
            j++;
          } else if (j >= words2.length) {
            result.push([-1, words1[i] + ' ']);
            i++;
          } else if (words1[i] === words2[j]) {
            result.push([0, words1[i] + ' ']);
            i++;
            j++;
          } else {
            result.push([-1, words1[i] + ' ']);
            result.push([1, words2[j] + ' ']);
            i++;
            j++;
          }
        }
        return result;
      };
      
      this.diff_cleanupSemantic = function(diffs) {
        // Simple cleanup - just return as is for fallback
        return diffs;
      };
    };
  </script>
  <!-- PDF.js (optional extract text from PDFs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>
  <style>
    /* Улучшенные скроллбары */
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { 
      background: linear-gradient(45deg, #6366f1, #8b5cf6); 
      border-radius: 9999px; 
      transition: all 0.3s ease;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { 
      background: linear-gradient(45deg, #4f46e5, #7c3aed); 
    }
    
    /* Анимация печати */
    .typing-dot { 
      width: 6px; height: 6px; 
      border-radius: 9999px; 
      background: linear-gradient(45deg, #6366f1, #8b5cf6);
      display: inline-block; 
      margin-right: 4px; 
      animation: bounce 1.3s infinite; 
    }
    .typing-dot:nth-child(2) { animation-delay: .2s }
    .typing-dot:nth-child(3) { animation-delay: .4s }
    @keyframes bounce { 
      0%,80%,100%{transform:translateY(0);} 
      40%{transform:translateY(-4px);} 
    }
    
    /* Улучшенная типография */
    .prose p { margin: .5rem 0; }
    .prose code { 
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0); 
      padding: .12rem .34rem; 
      border-radius: .3rem; 
      border: 1px solid #e2e8f0;
    }
    
    /* Красивые теги */
    .tag { 
      font-size: .7rem; 
      padding: .15rem .4rem; 
      border-radius: .375rem; 
      background: linear-gradient(135deg, #eef2ff, #ddd6fe); 
      color: #4338ca; 
      border: 1px solid #c7d2fe;
      animation: tagGlow 3s ease-in-out infinite;
    }
    
    @keyframes tagGlow {
      0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.3); }
      50% { box-shadow: 0 0 15px rgba(99, 102, 241, 0.6); }
    }
    
    /* Современные кнопки */
    .btn { 
      display: inline-flex; 
      align-items: center; 
      gap: .5rem; 
      padding: .56rem .8rem; 
      border-radius: .6rem; 
      background: linear-gradient(135deg, #1f2937, #111827); 
      color: #fff; 
      font-weight: 600; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      position: relative;
      overflow: hidden;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-secondary { 
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb); 
      color: #111827; 
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #e5e7eb, #d1d5db);
    }
    
    /* Шрифты и основные стили */
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #fdf4ff 0%, #f0f9ff 25%, #f0fdfa 50%, #fefce8 75%, #fef7ed 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      transition: all 0.3s ease;
      min-height: 100vh;
      color: #1f2937;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 50% 0%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 50% 100%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Анимация эмодзи */
    .emoji-highlight { 
      display: inline-block; 
      margin: 0 2px; 
      animation: emojiPulse 2s infinite; 
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }
    
    @keyframes emojiPulse { 
      0% { transform: scale(1) rotate(0deg); } 
      25% { transform: scale(1.1) rotate(2deg); }
      50% { transform: scale(1.2) rotate(0deg); } 
      75% { transform: scale(1.1) rotate(-2deg); }
      100% { transform: scale(1) rotate(0deg); } 
    }
    
    /* Анимации появления */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* Плавные переходы для карточек */
    .card-animate {
      animation: fadeInUp 0.6s ease-out;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-animate:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* Анимация для сайдбара */
    .sidebar-item {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .sidebar-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 3px;
      background: linear-gradient(180deg, #6366f1, #8b5cf6);
      border-radius: 0 3px 3px 0;
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }
    
    .sidebar-item:hover::before,
    .sidebar-item.active::before {
      transform: scaleY(1);
    }
    
    /* Градиентные фоны */
    .gradient-bg-1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-bg-2 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .gradient-bg-3 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .gradient-bg-4 {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    /* Анимация загрузки */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Улучшенные тени */
    .shadow-elegant {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                  0 4px 6px -2px rgba(0, 0, 0, 0.05),
                  0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    
    .shadow-elegant-hover:hover {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 
                  0 10px 10px -5px rgba(0, 0, 0, 0.04),
                  0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    
    /* Задержки анимации */
    .animation-delay-2000 {
      animation-delay: 2s;
    }
    
    .animation-delay-4000 {
      animation-delay: 4s;
    }
    
    /* Плавающие частицы */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    
    .float-animation {
      animation: float 3s ease-in-out infinite;
    }
    
    /* Эффект свечения */
    .glow-effect {
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
      to { box-shadow: 0 0 30px rgba(99, 102, 241, 0.6); }
    }
    :root [data-theme="dark"] {
      --bg: #111827;
      --text: #f9fafb;
      --accent: #6366f1;
      --secondary: #1f2937;
      --border: #374151;
    }

    [data-theme="dark"] {
      background-color: var(--bg);
      color: var(--text);
    }

    [data-theme="dark"] .bg-white { background-color: var(--secondary); }
    [data-theme="dark"] .bg-gray-50 { background-color: #374151; }
    [data-theme="dark"] .bg-gray-100 { background-color: #4b5563; }
    [data-theme="dark"] .bg-gray-200 { background-color: #6b7280; }
    [data-theme="dark"] .bg-blue-50 { background-color: rgba(59, 130, 246, 0.2); }
    [data-theme="dark"] .bg-green-50 { background-color: rgba(34, 197, 94, 0.2); }
    [data-theme="dark"] .bg-yellow-50 { background-color: rgba(234, 179, 8, 0.2); }
    [data-theme="dark"] .bg-purple-50 { background-color: rgba(147, 51, 234, 0.2); }
    [data-theme="dark"] .bg-red-50 { background-color: rgba(239, 68, 68, 0.2); }
    [data-theme="dark"] .bg-brand-50 { background-color: rgba(26, 86, 219, 0.2); }
    
    [data-theme="dark"] .text-gray-900 { color: var(--text); }
    [data-theme="dark"] .text-gray-800 { color: var(--text); }
    [data-theme="dark"] .text-gray-700 { color: #d1d5db; }
    [data-theme="dark"] .text-gray-600 { color: #d1d5db; }
    [data-theme="dark"] .text-gray-500 { color: #9ca3af; }
    [data-theme="dark"] .text-gray-400 { color: #9ca3af; }
    [data-theme="dark"] .text-gray-300 { color: #d1d5db; }
    
    [data-theme="dark"] .bg-indigo-50\/60 { background-color: rgba(67,56,202,0.3); }
    [data-theme="dark"] .border-gray-200 { border-color: var(--border); }
    [data-theme="dark"] .border-gray-300 { border-color: #6b7280; }
    [data-theme="dark"] .border { border-color: var(--border); }
    
    [data-theme="dark"] .btn { background: #f3f4f6; color: #111827; }
    [data-theme="dark"] .btn-secondary { background: #4b5563; color: #f3f4f6; }
    
    /* Дополнительные стили для темной темы */
    [data-theme="dark"] .bg-white { background-color: #1f2937 !important; }
    [data-theme="dark"] .border { border-color: #374151 !important; }
    [data-theme="dark"] .text-gray-900 { color: #f9fafb !important; }
    [data-theme="dark"] .text-gray-800 { color: #f9fafb !important; }
    [data-theme="dark"] .text-gray-700 { color: #d1d5db !important; }
    [data-theme="dark"] .text-gray-600 { color: #9ca3af !important; }
    [data-theme="dark"] .text-gray-500 { color: #9ca3af !important; }
    [data-theme="dark"] .text-gray-400 { color: #9ca3af !important; }
    [data-theme="dark"] .text-gray-300 { color: #d1d5db !important; }
    [data-theme="dark"] .text-gray-200 { color: #e5e7eb !important; }
    [data-theme="dark"] .text-gray-100 { color: #f3f4f6 !important; }
    
    [data-theme="dark"] .bg-gray-50 { background-color: #374151 !important; }
    [data-theme="dark"] .bg-gray-100 { background-color: #4b5563 !important; }
    [data-theme="dark"] .bg-gray-200 { background-color: #6b7280 !important; }
    [data-theme="dark"] .bg-gray-300 { background-color: #9ca3af !important; }
    [data-theme="dark"] .bg-gray-400 { background-color: #d1d5db !important; }
    [data-theme="dark"] .bg-gray-500 { background-color: #6b7280 !important; }
    [data-theme="dark"] .bg-gray-600 { background-color: #4b5563 !important; }
    [data-theme="dark"] .bg-gray-700 { background-color: #374151 !important; }
    [data-theme="dark"] .bg-gray-800 { background-color: #1f2937 !important; }
    [data-theme="dark"] .bg-gray-900 { background-color: #111827 !important; }
    
    [data-theme="dark"] .border-gray-200 { border-color: #374151 !important; }
    [data-theme="dark"] .border-gray-300 { border-color: #4b5563 !important; }
    [data-theme="dark"] .border-gray-400 { border-color: #6b7280 !important; }
    [data-theme="dark"] .border-gray-500 { border-color: #6b7280 !important; }
    
    [data-theme="dark"] .hover\:bg-gray-50:hover { background-color: #4b5563 !important; }
    [data-theme="dark"] .hover\:bg-gray-100:hover { background-color: #6b7280 !important; }
    [data-theme="dark"] .hover\:bg-gray-200:hover { background-color: #9ca3af !important; }
    [data-theme="dark"] .hover\:text-gray-700:hover { color: #d1d5db !important; }
    [data-theme="dark"] .hover\:text-gray-900:hover { color: #f9fafb !important; }
    

    
    [data-theme="dark"] .prose code { background: #374151; }
    [data-theme="dark"] .tag { background: rgba(67,56,202,0.2); color: #a5b4fc; }
    
    [data-theme="dark"] input, [data-theme="dark"] textarea, [data-theme="dark"] select {
      background-color: #374151;
      border-color: #4b5563;
      color: var(--text);
    }
    
    [data-theme="dark"] input:focus, [data-theme="dark"] textarea:focus, [data-theme="dark"] select:focus {
      border-color: #6366f1;
      outline-color: #6366f1;
    }
    
    /* Стили для модальных окон в темной теме */
    [data-theme="dark"] #loginModal .bg-white,
    [data-theme="dark"] #demoModal .bg-white {
      background-color: #1f2937 !important;
      color: #f9fafb !important;
    }
    
    [data-theme="dark"] #loginModal .text-gray-500,
    [data-theme="dark"] #demoModal .text-gray-500 {
      color: #9ca3af !important;
    }
    
    [data-theme="dark"] #loginModal .text-gray-600,
    [data-theme="dark"] #demoModal .text-gray-600 {
      color: #d1d5db !important;
    }
    
    [data-theme="dark"] #loginModal .border,
    [data-theme="dark"] #demoModal .border {
      border-color: #374151 !important;
    }
    
    /* Градиенты в темной теме для демо карточек */
    [data-theme="dark"] #demoModal .bg-gradient-to-r {
      background: #374151 !important;
    }
    
    [data-theme="dark"] #demoModal .border-blue-200,
    [data-theme="dark"] #demoModal .border-green-200,
    [data-theme="dark"] #demoModal .border-yellow-200,
    [data-theme="dark"] #demoModal .border-purple-200 {
      border-color: #4b5563 !important;
    }
    
    /* 🌙 ОСНОВНЫЕ СВЕТЛЫЕ СТИЛИ (по умолчанию) */
    
    /* 🌙 ДОПОЛНИТЕЛЬНАЯ ТЕМНАЯ ТЕМА (для совместимости) */
    
    /* Основной фон с анимированным градиентом */
    [data-theme="dark"] body {
      background: linear-gradient(135deg, #0c0a1a 0%, #1a0f2e 25%, #2d1b3d 50%, #1e293b 75%, #0f172a 100%) !important;
      background-size: 400% 400%;
      animation: darkGradientShift 20s ease infinite;
    }
    
    @keyframes darkGradientShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 50% 0%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 50% 100%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Заголовок в темной теме */
    [data-theme="dark"] header {
      background: rgba(15, 23, 42, 0.9) !important;
      backdrop-filter: blur(20px);
      border-color: rgba(99, 102, 241, 0.2) !important;
      box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1), 
                  0 2px 4px -1px rgba(99, 102, 241, 0.06);
    }
    
    /* Карточки с стеклянным эффектом */
    [data-theme="dark"] .bg-white\/90,
    [data-theme="dark"] .bg-white\/80,
    [data-theme="dark"] .bg-white {
      background: rgba(15, 23, 42, 0.8) !important;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(99, 102, 241, 0.2) !important;
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    /* Текст в темной теме */
    [data-theme="dark"] .text-gray-900,
    [data-theme="dark"] .text-gray-800,
    [data-theme="dark"] .text-gray-700 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .text-gray-600 {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .text-gray-500 {
      color: #94a3b8 !important;
    }
    
    /* Градиентные кнопки в темной теме */
    [data-theme="dark"] .bg-gradient-to-r.from-gray-100 {
      background: linear-gradient(135deg, rgba(51, 65, 85, 0.8), rgba(71, 85, 105, 0.8)) !important;
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .hover\:from-gray-200:hover {
      background: linear-gradient(135deg, rgba(71, 85, 105, 0.9), rgba(99, 102, 241, 0.3)) !important;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }
    
    /* Сайдбар в темной теме */
    [data-theme="dark"] .sidebar-item:not(.bg-gradient-to-r.from-brand-500) {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.8)) !important;
      border: 1px solid rgba(99, 102, 241, 0.2);
      color: #e2e8f0 !important;
      backdrop-filter: blur(10px);
    }
    
    [data-theme="dark"] .sidebar-item:not(.bg-gradient-to-r.from-brand-500):hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)) !important;
      color: #f8fafc !important;
      box-shadow: 0 0 25px rgba(99, 102, 241, 0.4);
      transform: translateY(-2px);
    }
    
    /* Специальные эффекты для темной темы */
    [data-theme="dark"] .gradient-bg-1 {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.8)) !important;
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
    }
    
    [data-theme="dark"] .gradient-bg-2 {
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.8), rgba(239, 68, 68, 0.8)) !important;
      box-shadow: 0 0 30px rgba(236, 72, 153, 0.3);
    }
    
    [data-theme="dark"] .gradient-bg-3 {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.8), rgba(34, 197, 94, 0.8)) !important;
      box-shadow: 0 0 30px rgba(6, 182, 212, 0.3);
    }
    
    [data-theme="dark"] .gradient-bg-4 {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.8), rgba(163, 230, 53, 0.8)) !important;
      box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
    }
    
    /* Плавающие элементы на фоне в темной теме */
    [data-theme="dark"] .bg-purple-300 {
      background: rgba(139, 92, 246, 0.3) !important;
    }
    
    [data-theme="dark"] .bg-yellow-300 {
      background: rgba(251, 191, 36, 0.3) !important;
    }
    
    [data-theme="dark"] .bg-pink-300 {
      background: rgba(236, 72, 153, 0.3) !important;
    }
    
    /* Скроллбары в темной теме */
    [data-theme="dark"] .scrollbar-thin::-webkit-scrollbar-thumb {
      background: linear-gradient(45deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.8)) !important;
    }
    
    [data-theme="dark"] .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(45deg, rgba(79, 70, 229, 0.9), rgba(124, 58, 237, 0.9)) !important;
    }
    
    /* Теги в темной теме */
    [data-theme="dark"] .tag {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)) !important;
      color: #a5b4fc !important;
      border: 1px solid rgba(99, 102, 241, 0.4) !important;
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.2);
    }
    
    /* Анимация свечения для темной темы */
    [data-theme="dark"] .glow-effect {
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
    }
    
    /* Улучшенные тени в темной теме */
    [data-theme="dark"] .shadow-elegant {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 
                  0 4px 6px -2px rgba(0, 0, 0, 0.2),
                  0 0 0 1px rgba(99, 102, 241, 0.2),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="dark"] .shadow-elegant:hover {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 
                  0 10px 10px -5px rgba(0, 0, 0, 0.3),
                  0 0 0 1px rgba(99, 102, 241, 0.4),
                  0 0 30px rgba(99, 102, 241, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    /* Дополнительные стили для темной темы */
    
    /* Чат в темной теме */
    [data-theme="dark"] #chatMessages {
      background: rgba(15, 23, 42, 0.6) !important;
      border: 1px solid rgba(99, 102, 241, 0.2);
      backdrop-filter: blur(15px);
    }
    
    /* Сообщения в чате */
    [data-theme="dark"] .message {
      background: rgba(30, 41, 59, 0.8) !important;
      border: 1px solid rgba(99, 102, 241, 0.1);
      backdrop-filter: blur(10px);
    }
    
    [data-theme="dark"] .message.user {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3)) !important;
      border: 1px solid rgba(99, 102, 241, 0.4);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
    }
    
    /* Поля ввода в темной теме */
    [data-theme="dark"] input,
    [data-theme="dark"] textarea,
    [data-theme="dark"] select {
      background: rgba(30, 41, 59, 0.8) !important;
      border: 1px solid rgba(99, 102, 241, 0.3) !important;
      color: #e2e8f0 !important;
      backdrop-filter: blur(10px);
    }
    
    [data-theme="dark"] input:focus,
    [data-theme="dark"] textarea:focus,
    [data-theme="dark"] select:focus {
      border-color: rgba(99, 102, 241, 0.6) !important;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 
                  0 0 20px rgba(99, 102, 241, 0.3) !important;
    }
    
    /* Кнопки файлов в темной теме */
    [data-theme="dark"] .file-chip {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.8)) !important;
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: #e2e8f0 !important;
      backdrop-filter: blur(10px);
    }
    
    [data-theme="dark"] .file-chip:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)) !important;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }
    
    /* Модальные окна в темной теме */
    [data-theme="dark"] .modal-overlay {
      background: rgba(0, 0, 0, 0.8) !important;
      backdrop-filter: blur(5px);
    }
    
    /* Анимированные индикаторы */
    [data-theme="dark"] .animate-pulse {
      animation: darkPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes darkPulse {
      0%, 100% { 
        opacity: 1;
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
      }
      50% { 
        opacity: 0.7;
        box-shadow: 0 0 25px rgba(139, 92, 246, 0.7);
      }
    }
    
    /* Улучшенные границы */
    [data-theme="dark"] .border {
      border-color: rgba(99, 102, 241, 0.2) !important;
    }
    
    [data-theme="dark"] .border-gray-200,
    [data-theme="dark"] .border-gray-300 {
      border-color: rgba(99, 102, 241, 0.3) !important;
    }
    
    /* Загрузочные индикаторы */
    [data-theme="dark"] .loading-spinner {
      border-color: rgba(51, 65, 85, 0.3);
      border-top-color: #6366f1;
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
    }
    
    /* Эффект для главной кнопки */
    [data-theme="dark"] .btn:not(.btn-secondary) {
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="dark"] .btn:not(.btn-secondary):hover {
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6),
                  inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    /* Стили для аутентификации */
    .auth-form {
      transition: all 0.3s ease;
    }
    
    .auth-form.hidden {
      opacity: 0;
      transform: translateX(20px);
    }
    
    .auth-form:not(.hidden) {
      opacity: 1;
      transform: translateX(0);
    }
    
    .user-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    
    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    /* Анимации для форм */
    @keyframes slideInFromRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .slide-in-right {
      animation: slideInFromRight 0.3s ease-out;
    }
    
    .slide-in-left {
      animation: slideInFromLeft 0.3s ease-out;
    }
  </style>
</head>
<body class="h-full text-gray-900">
  <!-- Navbar -->
  <header class="sticky top-0 z-40 border-b bg-white/90 backdrop-blur-xl shadow-elegant">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="logoBtn" class="flex items-center gap-3 hover:opacity-80 transition-all duration-300 hover:transform hover:scale-105">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 flex items-center justify-center text-white font-bold shadow-lg hover:shadow-xl transition-all duration-300">
            <span class="animate-pulse">e</span>
          </div>
          <div class="card-animate">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-lg bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">explAiner</span>
              <span class="tag">Legal AI</span>
              <span class="tag bg-gradient-to-r from-green-50 to-emerald-50 text-green-700 border-green-200">beta</span>
            </div>
            <p class="text-xs text-gray-500 hover:text-gray-700 transition-colors">Является юридической консультацией</p>
          </div>
        </button>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#features" class="text-gray-600 hover:text-brand-600 transition-all duration-300 hover:transform hover:scale-105 relative group">
          Возможности
          <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gradient-to-r from-brand-500 to-brand-600 group-hover:w-full transition-all duration-300"></span>
        </a>
        <a href="#security" class="text-gray-600 hover:text-brand-600 transition-all duration-300 hover:transform hover:scale-105 relative group">
          Безопасность
          <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gradient-to-r from-brand-500 to-brand-600 group-hover:w-full transition-all duration-300"></span>
        </a>
        <a href="#app" class="text-gray-600 hover:text-brand-600 transition-all duration-300 hover:transform hover:scale-105 relative group">
          Дашборд
          <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gradient-to-r from-brand-500 to-brand-600 group-hover:w-full transition-all duration-300"></span>
        </a>
        <a href="#" class="text-gray-300 cursor-not-allowed opacity-50">Документация</a>
      </nav>
      <div class="flex items-center gap-2">
        <button id="langToggle" class="px-3 py-2 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-sm transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md">
          🌍 RU/EN
        </button>
        <button id="loginBtn" class="px-4 py-2 rounded-lg bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white text-sm transition-all duration-300 hover:transform hover:scale-105 shadow-lg hover:shadow-xl">
          ✨ Войти
        </button>
        <div id="userMenu" class="hidden items-center gap-3">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-brand-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold">
              <span id="userInitial"></span>
            </div>
            <div class="text-right">
              <div id="userEmail" class="text-sm text-gray-600 font-medium"></div>
              <div class="text-xs text-gray-500">Пользователь</div>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="showStatsBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 hover:from-blue-200 hover:to-blue-300 text-blue-700 text-sm transition-all duration-300 hover:transform hover:scale-105" title="Показать статистику">
              📊
            </button>
            <button id="exportHistoryBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-green-100 to-green-200 hover:from-green-200 hover:to-green-300 text-green-700 text-sm transition-all duration-300 hover:transform hover:scale-105" title="Экспорт истории">
              📥
            </button>
            <button id="importHistoryBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-indigo-100 to-indigo-200 hover:from-indigo-200 hover:to-indigo-300 text-indigo-700 text-sm transition-all duration-300 hover:transform hover:scale-105" title="Импорт истории">
              📤
            </button>
            <button id="clearHistoryBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-yellow-100 to-yellow-200 hover:from-yellow-200 hover:to-yellow-300 text-yellow-700 text-sm transition-all duration-300 hover:transform hover:scale-105" title="Очистить историю">
              🗑️
            </button>
            <button id="logoutBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 hover:from-red-200 hover:to-red-300 text-red-700 text-sm transition-all duration-300 hover:transform hover:scale-105">
              👋 Выйти
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Landing -->
  <main id="landing" class="relative overflow-hidden">
    <!-- Декоративные элементы фона -->
    <div class="absolute inset-0 -z-10">
      <div class="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse"></div>
      <div class="absolute top-0 -right-4 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse animation-delay-2000"></div>
      <div class="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse animation-delay-4000"></div>
    </div>
    
    <section class="mx-auto max-w-7xl px-4 py-16">
      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div class="card-animate">
          <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight leading-tight">
            <span class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 bg-clip-text text-transparent">
              ExplAiner, которое понятно.
            </span>
            <br>
            <span class="bg-gradient-to-r from-brand-600 via-purple-600 to-brand-700 bg-clip-text text-transparent animate-pulse">
              explAiner
            </span>
            <span class="bg-gradient-to-r from-gray-700 to-gray-900 bg-clip-text text-transparent">
              объясняет, сравнивает и проверяет.
            </span>
          </h1>
          <p class="mt-6 text-gray-600 text-lg leading-relaxed">
            Загружайте договоры, задавайте вопросы, получайте разъяснения в чате, аудио и видео. 
            Поддержка RAG, комплаенс‑чекера, сравнения контрактов и what‑if сценариев с диаграммами.
          </p>
          <div class="mt-8 flex gap-4">
            <button class="btn shadow-elegant hover:shadow-xl" onclick="showLoginModal(true)">
              🚀 Начать работу
            </button>
            <button id="playDemo" class="btn btn-secondary shadow-elegant hover:shadow-xl">
              ▶️ Смотреть демо
            </button>
          </div>
          <div class="mt-6 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg">
            <div class="flex items-center gap-2">
              <span class="text-amber-600">⚠️</span>
              <span class="text-sm text-amber-800 font-medium">Дисклеймер</span>
          </div>
            <p class="text-xs text-amber-700 mt-1">
              Сервис носит информационный характер и не является юридической консультацией.
            </p>
        </div>
          </div>
        <div class="bg-white/80 backdrop-blur-sm border rounded-2xl p-6 shadow-elegant hover:shadow-xl transition-all duration-500 card-animate">
          <div class="text-sm text-gray-600 mb-4 font-medium flex items-center gap-2">
            <span class="w-2 h-2 bg-gradient-to-r from-green-400 to-green-500 rounded-full animate-pulse"></span>
            Интерфейс explAiner
          </div>
          <div class="rounded-xl overflow-hidden border shadow-lg">
            <div class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 h-64 flex items-center justify-center relative overflow-hidden">
              <!-- Анимированные элементы интерфейса -->
              <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
              <div class="text-center text-white z-10">
                <div class="text-4xl mb-4 animate-bounce">💬</div>
                <div class="text-lg font-semibold mb-2">ИИ Ассистент</div>
                <div class="text-sm opacity-90">Анализирует документы в реальном времени</div>
              </div>
              <!-- Плавающие элементы -->
              <div class="absolute top-4 left-4 w-3 h-3 bg-white/30 rounded-full animate-ping"></div>
              <div class="absolute bottom-4 right-4 w-2 h-2 bg-white/40 rounded-full animate-pulse"></div>
              <div class="absolute top-1/2 left-8 w-1 h-1 bg-white/50 rounded-full animate-bounce"></div>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-3 gap-3 text-xs">
            <div class="p-3 rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 hover:from-blue-100 hover:to-indigo-100 transition-all duration-300 cursor-pointer group">
              <div class="text-blue-600 group-hover:scale-110 transition-transform duration-300">📚</div>
              <div class="mt-1 text-blue-800 font-medium">RAG из документов</div>
            </div>
            <div class="p-3 rounded-lg bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-100 hover:from-purple-100 hover:to-pink-100 transition-all duration-300 cursor-pointer group">
              <div class="text-purple-600 group-hover:scale-110 transition-transform duration-300">🎬</div>
              <div class="mt-1 text-purple-800 font-medium">Аудио/Видео объяснения</div>
            </div>
            <div class="p-3 rounded-lg bg-gradient-to-br from-green-50 to-emerald-50 border border-green-100 hover:from-green-100 hover:to-emerald-100 transition-all duration-300 cursor-pointer group">
              <div class="text-green-600 group-hover:scale-110 transition-transform duration-300">📊</div>
              <div class="mt-1 text-green-800 font-medium">What‑if диаграммы</div>
            </div>
          </div>
        </div>
      </div>

      <section id="features" class="mt-20">
        <div class="text-center mb-12 card-animate">
          <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent mb-4">
            Возможности explAiner
          </h2>
          <p class="text-gray-600 max-w-2xl mx-auto">
            Мощные инструменты для работы с юридическими документами, основанные на современных технологиях ИИ
          </p>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate gradient-bg-1 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">💬</div>
            <h3 class="font-semibold mb-3 text-lg">Чат + Жаргон‑объяснитель</h3>
            <p class="text-sm opacity-90">Автоподсказки простым языком с контекстным пониманием</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              Умные подсказки
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate gradient-bg-2 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">📄</div>
            <h3 class="font-semibold mb-3 text-lg">Загрузка документов</h3>
            <p class="text-sm opacity-90">PDF/DOC/TXT файлы с RAG-анализом и извлечением смысла</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              OCR поддержка
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate gradient-bg-3 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">🔍</div>
            <h3 class="font-semibold mb-3 text-lg">Комплаенс‑чекер</h3>
            <p class="text-sm opacity-90">GDPR/CCPA проверка с подсказками по исправлениям</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              Автоматические рекомендации
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate gradient-bg-4 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">⚖️</div>
            <h3 class="font-semibold mb-3 text-lg">Сравнение договоров</h3>
            <p class="text-sm opacity-90">Подсветка различий и анализ юридических рисков</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              Визуальный diff
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate bg-gradient-to-br from-indigo-600 to-purple-700 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">🎧</div>
            <h3 class="font-semibold mb-3 text-lg">Аудио/Видео</h3>
            <p class="text-sm opacity-90">Озвучка ответов и интерактивный аватар</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              TTS синтез речи
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate bg-gradient-to-br from-pink-600 to-red-700 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">🎯</div>
            <h3 class="font-semibold mb-3 text-lg">What‑if симулятор</h3>
            <p class="text-sm opacity-90">Mermaid-диаграммы юридических сценариев</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              Интерактивные схемы
            </div>
          </div>
        </div>
      </section>

      <section id="security" class="mt-16">
        <h2 class="text-2xl font-bold mb-4">Безопасность и приватность</h2>
        <ul class="list-disc pl-6 text-gray-600">
          <li>Шифрование файлов на клиенте (опционально, AES‑GCM demo).</li>
          <li>Приватность: только вы видите свои документы и историю (локально; сервер — при подключении Supabase).</li>
          <li>Прозрачность: цитирование источников и ссылки на Google Scholar.</li>
        </ul>
      </section>
    </section>
  </main>

  <!-- App -->
  <section id="app" class="hidden">
    <div class="mx-auto max-w-7xl px-4 py-6 grid grid-cols-12 gap-4">
      <!-- Sidebar -->
      <aside class="col-span-12 md:col-span-3 space-y-4 card-animate">
        <div class="border rounded-xl bg-white/90 backdrop-blur-sm p-4 shadow-elegant hover:shadow-xl transition-all duration-300">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-800 flex items-center gap-2">
              <span class="w-2 h-2 bg-gradient-to-r from-green-400 to-green-500 rounded-full animate-pulse"></span>
              Сессии
            </h3>
            <button id="newChatBtn" class="text-sm px-3 py-2 rounded-lg bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md">
              ✨ Новая
            </button>
          </div>
          <div id="sessionsList" class="mt-3 space-y-2 max-h-72 overflow-auto scrollbar-thin"></div>
        </div>

        <div class="border rounded-xl bg-white/90 backdrop-blur-sm p-4 shadow-elegant hover:shadow-xl transition-all duration-300">
          <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-2 h-2 bg-gradient-to-r from-blue-400 to-blue-500 rounded-full animate-pulse"></span>
            Инструменты
          </h3>
          <div class="mt-2 space-y-3 text-sm">
            <button id="toolChat" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-brand-500 to-brand-600 text-white text-left transition-all duration-300 hover:transform hover:scale-105 shadow-lg flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">💬</span>
              <span class="font-medium">ИИ Чат</span>
            </button>
            <button id="toolCompliance" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-emerald-100 hover:to-emerald-200 text-gray-700 hover:text-emerald-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">🔎</span>
              <span class="font-medium">Комплаенс‑чекер</span>
            </button>
            <button id="toolCompare" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-amber-100 hover:to-amber-200 text-gray-700 hover:text-amber-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">⚖️</span>
              <span class="font-medium">Сравнение договоров</span>
            </button>
            <button id="toolTranslate" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-cyan-100 hover:to-cyan-200 text-gray-700 hover:text-cyan-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">🌐</span>
              <span class="font-medium">Переводы</span>
            </button>
            <button id="toolWhatIf" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-purple-100 hover:to-purple-200 text-gray-700 hover:text-purple-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">🧭</span>
              <span class="font-medium">What‑if симулятор</span>
            </button>
            <button id="toolSettings" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-blue-100 hover:to-blue-200 text-gray-700 hover:text-blue-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">⚙️</span>
              <span class="font-medium">Настройки</span>
            </button>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="col-span-12 md:col-span-9 space-y-4">

        <!-- Panels -->
        <div id="panelChat" class="border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">Expl<span id="modelLabel" class="font-medium">Ai</span>ner<span id="ragStatus" class="font-medium"></span></div>
            <div class="flex items-center gap-2">
              <button id="exportChat" class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">📥 Экспорт</button>
              <div class="text-xs text-gray-500">Не является юридической консультацией</div>
            </div>
          </div>
          <div id="chatStream" class="mt-3 h-[52vh] overflow-auto scrollbar-thin pr-2"></div>
          <div id="uploadedFiles" class="mt-2 flex flex-wrap gap-2 hidden"></div>
          <div class="mt-3 border rounded-lg p-2">
            <div class="flex items-center gap-2 mb-2">
              <button id="attachBtn" class="text-sm px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 flex items-center gap-1">
                <span>📎</span> Прикрепить
              </button>
              <button id="voiceBtn" class="text-sm px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">🎙️ Голос</button>
              <div class="flex items-center gap-3 ml-auto text-xs">
                <label class="flex items-center gap-1"><input id="toggleJargon" type="checkbox" checked class="rounded"> Жаргон</label>
                <label class="flex items-center gap-1"><input id="toggleFact" type="checkbox" checked class="rounded"> Факт‑чек</label>
                <label class="flex items-center gap-1"><input id="toggleLang" type="checkbox" checked class="rounded"> Мультиязык</label>
              </div>
            </div>
            <textarea id="chatInput" rows="2" placeholder="Спросите: Проверьте NDA на риски по GDPR..."
              class="w-full resize-y rounded-md border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500"></textarea>
            <div class="mt-2 flex items-center justify-between">
              <div id="inputHint" class="text-xs text-gray-500">Enter — отправить, Shift+Enter — перенос строки</div>
              <div class="flex gap-2">
                <button id="stopBtn" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm hidden">⏹️ Стоп</button>
                <button id="sendBtn" class="px-3 py-2 rounded bg-brand-500 hover:bg-brand-600 text-white text-sm">Отправить</button>
              </div>
            </div>
          </div>
          <!-- Скрытый input для загрузки файлов -->
          <input id="fileInput" type="file" class="hidden" multiple />
        </div>

        <div id="panelCompliance" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Комплаенс‑чекер</h3>
            <div class="text-xs text-gray-500">GDPR • CCPA • ISO/IEC 27001 (демо)</div>
          </div>
          <div class="mt-2 grid md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <textarea id="complianceText" rows="5" placeholder="Вставьте текст политики/соглашения или выберите документ слева" class="w-full border rounded-md p-2"></textarea>
              <div class="mt-2 flex gap-2">
                <button id="runCompliance" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm">Анализ</button>
                <button id="fixCompliance" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm">Предложить правки</button>
              </div>
            </div>
            <div>
              <div class="text-sm font-medium">Профили</div>
              <div class="mt-2 space-y-1 text-sm">
                <label class="flex items-center gap-2"><input id="profileGDPR" type="checkbox" class="rounded" checked> GDPR</label>
                <label class="flex items-center gap-2"><input id="profileCCPA" type="checkbox" class="rounded"> CCPA</label>
                <label class="flex items-center gap-2"><input id="profileHIPAA" type="checkbox" class="rounded"> HIPAA</label>
              </div>
              <div class="mt-3 text-xs text-gray-500">Анализ локальный/мок. Для прод — подключите /api/chat агент.</div>
            </div>
          </div>
          <div id="complianceResult" class="mt-3 text-sm"></div>
        </div>

        <div id="panelCompare" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Сравнение договоров</h3>
            <div class="text-xs text-gray-500">Загрузите 2 документа для сравнения</div>
          </div>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <!-- Документ A -->
            <div class="border rounded-lg p-3">
              <div class="text-sm font-medium mb-2">Документ A</div>
              <div id="docAStatus" class="text-xs text-gray-500 mb-2">Документ не загружен</div>
              <input id="fileInputA" type="file" class="hidden" accept=".pdf,.doc,.docx,.txt">
              <button id="uploadDocA" class="w-full px-3 py-2 rounded bg-blue-100 hover:bg-blue-200 text-blue-700 text-sm flex items-center justify-center gap-2">
                <span>📄</span> Загрузить документ A
              </button>
              <div id="docAPreview" class="mt-2 hidden">
                <div class="text-xs font-medium text-gray-600">Загружен:</div>
                <div id="docAName" class="text-xs text-gray-800"></div>
                <div id="docASize" class="text-xs text-gray-500"></div>
          </div>
          </div>
            
            <!-- Документ B -->
            <div class="border rounded-lg p-3">
              <div class="text-sm font-medium mb-2">Документ B</div>
              <div id="docBStatus" class="text-xs text-gray-500 mb-2">Документ не загружен</div>
              <input id="fileInputB" type="file" class="hidden" accept=".pdf,.doc,.docx,.txt">
              <button id="uploadDocB" class="w-full px-3 py-2 rounded bg-green-100 hover:bg-green-200 text-green-700 text-sm flex items-center justify-center gap-2">
                <span>📄</span> Загрузить документ B
              </button>
              <div id="docBPreview" class="mt-2 hidden">
                <div class="text-xs font-medium text-gray-600">Загружен:</div>
                <div id="docBName" class="text-xs text-gray-800"></div>
                <div id="docBSize" class="text-xs text-gray-500"></div>
              </div>
            </div>
        </div>

          <div class="mt-4 flex items-center justify-between">
            <div class="text-xs text-gray-500">
              <span id="compareStatus">Загрузите оба документа для сравнения</span>
            </div>
            <button id="runCompare" class="px-4 py-2 rounded bg-brand-500 hover:bg-brand-600 text-white text-sm disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
              Сравнить документы
            </button>
          </div>
          
          <div id="compareResult" class="mt-4 text-sm"></div>
        </div>

        <div id="panelTranslate" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold flex items-center gap-2">
              <span class="text-xl">🌐</span>
              Переводы документов
            </h3>
            <div class="text-xs text-gray-500 flex items-center gap-2">
              <span>Перевод через Google Translate</span>
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">Powered by Google</span>
            </div>
          </div>
          
          <!-- Загрузка файла для перевода -->
          <div class="mb-4 p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 transition-colors">
            <div class="text-center">
              <div class="mb-2">📄</div>
              <div class="text-sm font-medium mb-1">Загрузите документ для перевода</div>
              <div class="text-xs text-gray-500 mb-3">PDF, DOCX, TXT файлы</div>
              <input type="file" id="translateFileInput" accept=".pdf,.docx,.txt" class="hidden">
              <button id="uploadTranslateBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition-colors">
                📁 Выбрать файл
              </button>
            </div>
            <div id="translateFilePreview" class="hidden mt-3 p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-sm">📄</span>
                  <div>
                    <div id="translateFileName" class="text-sm font-medium"></div>
                    <div id="translateFileSize" class="text-xs text-gray-500"></div>
                  </div>
                </div>
                <button id="removeTranslateFile" class="text-red-500 hover:text-red-700 text-sm">✕</button>
              </div>
            </div>
          </div>

          <!-- Выбор языков -->
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium mb-2">Исходный язык</label>
              <select id="sourceLanguage" class="w-full border rounded-lg p-2 text-sm">
                <option value="auto">🔍 Автоопределение</option>
                <option value="ru">🇷🇺 Русский</option>
                <option value="en">🇺🇸 Английский</option>
                <option value="zh">🇨🇳 Китайский</option>
                <option value="es">🇪🇸 Испанский</option>
                <option value="fr">🇫🇷 Французский</option>
                <option value="de">🇩🇪 Немецкий</option>
                <option value="ja">🇯🇵 Японский</option>
                <option value="ko">🇰🇷 Корейский</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Целевой язык</label>
              <select id="targetLanguage" class="w-full border rounded-lg p-2 text-sm">
                <option value="ru">🇷🇺 Русский</option>
                <option value="en">🇺🇸 Английский</option>
                <option value="zh">🇨🇳 Китайский</option>
                <option value="es">🇪🇸 Испанский</option>
                <option value="fr">🇫🇷 Французский</option>
                <option value="de">🇩🇪 Немецкий</option>
                <option value="ja">🇯🇵 Японский</option>
                <option value="ko">🇰🇷 Корейский</option>
              </select>
            </div>
          </div>

          <!-- Настройки перевода -->
          <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium">⚙️ Настройки перевода</span>
            </div>
            <div class="grid grid-cols-2 gap-3 text-xs">
              <label class="flex items-center gap-2">
                <input type="checkbox" id="preserveFormatting" checked class="rounded">
                <span>Сохранить форматирование</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" id="legalTerms" checked class="rounded">
                <span>Юридическая терминология</span>
              </label>
            </div>
          </div>

          <!-- Кнопка перевода -->
          <div class="flex gap-3 mb-4">
            <button id="startTranslation" class="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg font-medium transition-all duration-300 hover:transform hover:scale-105 shadow-lg hover:shadow-xl disabled:opacity-50" disabled>
              🚀 Начать перевод
            </button>
          </div>

          <!-- Статус перевода -->
          <div id="translationStatus" class="hidden mb-4 p-3 rounded-lg">
            <div class="flex items-center gap-2">
              <div class="loading-spinner"></div>
              <span class="text-sm">Перевод документа...</span>
            </div>
            <div class="mt-2 bg-gray-200 rounded-full h-2">
              <div id="translationProgress" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>

          <!-- Результат перевода -->
          <div id="translationResult" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-medium">📋 Результат перевода</h4>
              <div class="flex gap-2">
                <button id="downloadTranslated" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm">
                  📥 Скачать
                </button>
                <button id="copyTranslated" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded text-sm">
                  📋 Копировать
                </button>
              </div>
            </div>
            <div id="translatedContent" class="max-h-96 overflow-auto border rounded-lg p-4 bg-gray-50 text-sm whitespace-pre-wrap font-mono leading-relaxed"></div>
          </div>
        </div>

        <div id="panelWhatIf" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold flex items-center gap-2">
              <span class="text-xl">🧭</span>
              What‑if симулятор
            </h3>
            <div class="text-xs text-gray-500">Генерация Mermaid диаграмм</div>
          </div>

          <!-- Загрузка файла для анализа -->
          <div class="mb-4 p-3 border border-dashed border-gray-300 rounded-lg hover:border-purple-400 transition-colors">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-sm">📄</span>
                <div>
                  <div class="text-sm font-medium">Документ для анализа</div>
                  <div class="text-xs text-gray-500">Опционально: загрузите контракт</div>
          </div>
              </div>
              <div class="flex gap-2">
                <input type="file" id="whatIfFileInput" accept=".pdf,.docx,.txt" class="hidden">
                <button id="uploadWhatIfBtn" class="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white rounded text-sm">
                  📁 Загрузить
                </button>
              </div>
            </div>
            <div id="whatIfFilePreview" class="hidden mt-2 p-2 bg-purple-50 rounded">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-xs">📄</span>
                  <div>
                    <div id="whatIfFileName" class="text-xs font-medium"></div>
                    <div id="whatIfFileSize" class="text-xs text-gray-500"></div>
                  </div>
                </div>
                <button id="removeWhatIfFile" class="text-red-500 hover:text-red-700 text-xs">✕</button>
              </div>
            </div>
          </div>

          <textarea id="whatIfInput" rows="4" placeholder="Что если я нарушу пункт о неконкуренции в договоре на 6 месяцев? Какие могут быть последствия?" class="w-full border rounded-md p-3 mt-2 resize-none"></textarea>
          
          <div class="mt-3 flex gap-2">
            <button id="genFlow" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white rounded-lg font-medium transition-all duration-300 hover:transform hover:scale-105 shadow-lg hover:shadow-xl text-sm">
              🎯 Сгенерировать сценарий
            </button>
          </div>
          
          <div id="flowWrap" class="mt-4 overflow-auto border rounded-lg p-3 bg-gray-50 min-h-[200px] hidden">
            <div class="text-center text-gray-500 text-sm py-8">
              Диаграмма сценария появится здесь
            </div>
          </div>
        </div>

        <div id="panelDocAnalysis" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Анализ документа</h3>
            <div class="text-xs text-gray-500"><span id="docAnalysisName"></span></div>
          </div>
          <div class="mt-3 grid md:grid-cols-3 gap-3">
            <div class="md:col-span-3">
              <div class="text-sm font-medium">Тип анализа</div>
              <div class="mt-2 flex gap-2">
                <button id="analysisGeneral" class="px-3 py-1 rounded bg-brand-500 text-white text-sm">Общий</button>
                <button id="analysisLegal" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-sm">Юридический</button>
                <button id="analysisRisks" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-sm">Риски</button>
              </div>
            </div>
          </div>
          <div id="docAnalysisResult" class="mt-3"></div>
        </div>
        
        <div id="panelSettings" class="hidden border rounded-xl bg-white p-4">
          <h3 class="font-semibold">Настройки</h3>
          <div class="grid md:grid-cols-2 gap-4 mt-2">
            <div>
              <label class="text-sm font-medium">Модель</label>
              <select id="modelSelect" class="w-full border rounded-md p-2 mt-1">
                <option value="gpt-4o">OpenAI GPT‑4o</option>
                <option value="o1">OpenAI o1 (reasoning)</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">Голос (TTS)</label>
              <select id="voiceSelect" class="w-full border rounded-md p-2 mt-1"></select>
            </div>
            <div>
              <label class="text-sm font-medium">Видео‑аватар</label>
              <select id="avatarSelect" class="w-full border rounded-md p-2 mt-1">
                <option value="none">Отключено</option>
                <option value="heygen">HeyGen (через /api/video)</option>
                <option value="synthesia">Synthesia (через /api/video)</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">RAG источник</label>
              <select id="ragSource" class="w-full border rounded-md p-2 mt-1">
                <option value="off">Выкл</option>
                <option value="local">Локальная библиотека</option>
                <option value="vector">Векторное хранилище</option>
              </select>
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-500">Для прод‑режима укажите ключи в .env и подключите Next.js API.</div>
        </div>
      </main>
    </div>
  </section>

  <!-- Login/Register Modal -->
  <div id="loginModal" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full">
              <!-- Login Form -->
        <div id="loginFormContainer" class="auth-form">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">🚀 Вход в explAiner</h3>
          <button id="loginClose" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
      </div>
        
        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Email</label>
            <input type="email" id="loginEmail" required class="w-full border rounded-lg p-3" placeholder="your@email.com">
      </div>
          <div>
            <label class="block text-sm font-medium mb-2">Пароль</label>
            <input type="password" id="loginPassword" required class="w-full border rounded-lg p-3" placeholder="Введите пароль">
          </div>
          <button type="submit" class="w-full btn">🚀 Войти</button>
        </form>
        
        <div class="mt-4 text-center text-sm text-gray-500">
          Нет аккаунта? <button id="showRegister" class="text-brand-500 hover:underline font-medium">Зарегистрироваться</button>
        </div>
      </div>

              <!-- Register Form -->
        <div id="registerFormContainer" class="hidden auth-form">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">✨ Регистрация в explAiner</h3>
          <button id="registerClose" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>
        
        <form id="registerForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Имя</label>
            <input type="text" id="registerName" required class="w-full border rounded-lg p-3" placeholder="Ваше имя">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Email</label>
            <input type="email" id="registerEmail" required class="w-full border rounded-lg p-3" placeholder="your@email.com">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Пароль</label>
            <input type="password" id="registerPassword" required class="w-full border rounded-lg p-3" placeholder="Минимум 6 символов" minlength="6">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Подтвердите пароль</label>
            <input type="password" id="registerPasswordConfirm" required class="w-full border rounded-lg p-3" placeholder="Повторите пароль">
          </div>
          <button type="submit" class="w-full btn">✨ Создать аккаунт</button>
        </form>
        
        <div class="mt-4 text-center text-sm text-gray-500">
          Уже есть аккаунт? <button id="showLogin" class="text-brand-500 hover:underline font-medium">Войти</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Demo Modal -->
  <div id="demoModal" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">🎬 Демо возможностей explAiner</h3>
        <button id="demoClose" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      </div>
      
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Чат с ИИ -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">💬 ИИ Чат</h4>
          <div class="space-y-2 text-sm">
            <div class="p-3 bg-gray-50 rounded-lg">
              <strong>Примеры запросов:</strong>
              <ul class="mt-2 space-y-1">
                <li>• "Проверьте этот NDA на риски по GDPR"</li>
                <li>• "Объясните простыми словами пункт о неконкуренции"</li>
                <li>• "Какие риски в этом договоре аренды?"</li>
                <li>• "Сравните два варианта договора"</li>
              </ul>
            </div>
            <div class="p-3 bg-blue-50 rounded-lg">
              <strong>Возможности:</strong>
              <ul class="mt-2 space-y-1">
                <li>• Автообъяснение юридических терминов</li>
                <li>• Факт-чек с источниками</li>
                <li>• Мультиязычная поддержка</li>
                <li>• Аудио и видео объяснения</li>
              </ul>
            </div>
            <div class="mt-2 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
              <div class="text-center text-blue-600">
                <div class="text-2xl mb-2">💬</div>
                <div class="text-sm font-medium">ИИ Чат Демо</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Комплаенс-чекер -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">🔎 Комплаенс-чекер</h4>
          <div class="space-y-2 text-sm">
            <div class="p-3 bg-gray-50 rounded-lg">
              <strong>Проверяемые стандарты:</strong>
              <ul class="mt-2 space-y-1">
                <li>• GDPR (ЕС)</li>
                <li>• CCPA (Калифорния)</li>
                <li>• HIPAA (медицина)</li>
                <li>• ISO/IEC 27001</li>
              </ul>
            </div>
            <div class="p-3 bg-green-50 rounded-lg">
              <strong>Что проверяется:</strong>
              <ul class="mt-2 space-y-1">
                <li>• Правовые основания обработки</li>
                <li>• Права субъектов данных</li>
                <li>• Сроки хранения</li>
                <li>• Меры безопасности</li>
              </ul>
            </div>
            <div class="mt-2 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
              <div class="text-center text-green-600">
                <div class="text-2xl mb-2">🔎</div>
                <div class="text-sm font-medium">Комплаенс-чекер Демо</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Сравнение документов -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">⚖️ Сравнение договоров</h4>
          <div class="space-y-2 text-sm">
            <div class="p-3 bg-gray-50 rounded-lg">
              <strong>Поддерживаемые форматы:</strong>
              <ul class="mt-2 space-y-1">
                <li>• PDF документы</li>
                <li>• Word (.docx)</li>
                <li>• Текстовые файлы</li>
                <li>• Markdown</li>
              </ul>
            </div>
            <div class="p-3 bg-yellow-50 rounded-lg">
              <strong>Анализ различий:</strong>
              <ul class="mt-2 space-y-1">
                <li>• Подсветка изменений</li>
                <li>• Оценка рисков</li>
                <li>• Ключевые отличия</li>
                <li>• Рекомендации</li>
              </ul>
            </div>
            <div class="mt-2 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200">
              <div class="text-center text-yellow-600">
                <div class="text-2xl mb-2">⚖️</div>
                <div class="text-sm font-medium">Сравнение Договоров Демо</div>
              </div>
            </div>
          </div>
        </div>

        <!-- What-if симулятор -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">🧭 What-if симулятор</h4>
          <div class="space-y-2 text-sm">
            <div class="p-3 bg-gray-50 rounded-lg">
              <strong>Примеры сценариев:</strong>
              <ul class="mt-2 space-y-1">
                <li>• "Что если нарушу NDA?"</li>
                <li>• "Последствия задержки платежа"</li>
                <li>• "Риски расторжения договора"</li>
                <li>• "GDPR нарушения"</li>
              </ul>
            </div>
            <div class="p-3 bg-purple-50 rounded-lg">
              <strong>Визуализация:</strong>
              <ul class="mt-2 space-y-1">
                <li>• Mermaid диаграммы</li>
                <li>• Пошаговые сценарии</li>
                <li>• Оценка вероятностей</li>
                <li>• Рекомендации действий</li>
              </ul>
            </div>
            <div class="mt-2 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
              <div class="text-center text-purple-600">
                <div class="text-2xl mb-2">🧭</div>
                <div class="text-sm font-medium">What-If Симулятор Демо</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 p-4 bg-brand-50 rounded-xl">
        <h4 class="font-semibold mb-2">🚀 Начните прямо сейчас!</h4>
        <p class="text-sm text-gray-600 mb-3">Нажмите "Попробовать демо" чтобы увидеть все возможности в действии</p>
        <div class="flex gap-4">
        <button id="startDemo" class="px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white rounded-lg font-medium">
          Попробовать демо
        </button>
          <button id="watchVideoDemo" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium flex items-center gap-2">
            <span>▶️</span> Смотреть видео
        </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm shadow-lg"></div>
  </div>

  <!-- Scripts -->
  <script>
    // Utilities
    const $ = (sel, parent=document) => parent.querySelector(sel);
    const $$ = (sel, parent=document) => Array.from(parent.querySelectorAll(sel));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const API = { chat:'/api/chat', upload:'/api/upload', audio:'/api/audio', video:'/api/video', compliance:'/api/compliance', compare:'/api/compare', whatif:'/api/whatif', analyze:'/api/analyze' };
    const LOCAL_KEY = 'explAiner_state_v1';

    const state = {
      user: null,
      settings: { 
        model:'gpt-4o', 
        voice:'', 
        avatar:'none', 
        rag:'off', 
        explainJargon:true, 
        factCheck:true, 
        multilingual:true, 
        encryption:false,
        language: 'ru' // ru или en
      },
      sessions: [],
      docs: [],
      activeSessionId: null,
      busy: false,
      recorder: { media: null, chunks: [], active: false },
      crypto: { key: null }, // AES-GCM demo
      compare: { docA: null, docB: null }, // Документы для сравнения
      autoSaveTimeout: null // Таймер для автоматического сохранения истории
    };
    
    // Словарь для интерфейса
    const translations = {
      ru: {
        app_title: 'explAiner — Legal AI Assistant',
        disclaimer: 'Не является юридической консультацией',
        btn_audio: '🔊 Аудио',
        btn_video: '🎬 Видео',
        btn_sources: '📚 Источники',
        btn_attach: '📎 Прикрепить',
        btn_voice: '🎙️ Голос',
        btn_send: 'Отправить',
        btn_stop: '⏹️ Стоп',
        btn_export: '📥 Экспорт',
        btn_login: 'Войти',
        btn_logout: 'Выйти',
        btn_theme: '🌓 Тема',
        user_name: 'Вы',
        chat_placeholder: 'Спросите: Проверьте NDA на риски по GDPR...',
        new_session: 'Новая сессия',
        upload_file: '⬆️ Загрузить',
        drop_files: 'Перетащите файлы сюда',
        encrypt_local: 'Шифровать локально (AES‑GCM demo)',
        compliance_checker: '🔎 Комплаенс‑чекер',
        contract_compare: '⚖️ Сравнение договоров',
        whatif: '🧭 What‑if симулятор',
        settings: '⚙️ Настройки'
      },
      en: {
        app_title: 'explAiner — Legal AI Assistant',
        disclaimer: 'Not legal advice',
        btn_audio: '🔊 Audio',
        btn_video: '🎬 Video',
        btn_sources: '📚 Sources',
        btn_attach: '📎 Attach',
        btn_voice: '🎙️ Voice',
        btn_send: 'Send',
        btn_stop: '⏹️ Stop',
        btn_export: '📥 Export',
        btn_login: 'Login',
        btn_logout: 'Logout',
        btn_theme: '🌓 Theme',
        user_name: 'You',
        chat_placeholder: 'Ask: Check this NDA for GDPR risks...',
        new_session: 'New session',
        upload_file: '⬆️ Upload',
        drop_files: 'Drop files here',
        encrypt_local: 'Encrypt locally (AES‑GCM demo)',
        compliance_checker: '🔎 Compliance checker',
        contract_compare: '⚖️ Contract comparison',
        whatif: '🧭 What‑if simulator',
        settings: '⚙️ Settings'
      }
    };

    // Функция для получения текущего перевода
    const t = (key) => {
      const lang = state.settings.language || 'ru';
      return translations[lang][key] || translations['ru'][key] || key;
    };
    
    // Функция для обновления языка интерфейса
    const updateLanguage = (lang) => {
      state.settings.language = lang;
      saveState();
      
      // Обновляем текстовые элементы
      document.title = t('app_title');
      $('#chatInput').placeholder = t('chat_placeholder');
      $('#sendBtn').textContent = t('btn_send');
      $('#stopBtn').textContent = t('btn_stop');
      $('#exportChat').textContent = t('btn_export');
      $('#attachBtn').textContent = t('btn_attach');
      $('#voiceBtn').textContent = t('btn_voice');
      $('#loginBtn').textContent = t('btn_login');
      $('#logoutBtn').textContent = t('btn_logout');
      $('#themeToggle').textContent = t('btn_theme');
      $('#newChatBtn').textContent = '+ ' + t('new_session');
      
      // Перерисовываем интерфейс
      renderSessions();
      renderChat();
    };
    
    const saveState = () => {
      try {
        const { user, settings, sessions, docs, activeSessionId } = state;
        localStorage.setItem(LOCAL_KEY, JSON.stringify({ user, settings, sessions, docs, activeSessionId }));
        
        // Автоматически сохраняем историю пользователя если он авторизован
        if (user) {
          autoSaveUserHistory();
        }
      } catch {}
    };
    const loadState = () => {
      try {
        const data = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
        Object.assign(state, data, { 
          busy: false, 
          recorder: { media:null, chunks:[], active:false },
          autoSaveTimeout: null // Сбрасываем таймер при загрузке
        });
      } catch {}
    };

    // Theme
    const setTheme = (mode) => {
      document.body.dataset.theme = mode;
      document.documentElement.classList.toggle('dark', mode === 'dark');
      
      // Обновляем стили для темной темы
      if (mode === 'dark') {
        document.body.classList.add('bg-gray-900', 'text-white');
        document.body.classList.remove('bg-gray-50', 'text-gray-900');
      } else {
        document.body.classList.add('bg-gray-50', 'text-gray-900');
        document.body.classList.remove('bg-gray-900', 'text-white');
      }
      
      // Обновляем все карточки и панели
      const cards = document.querySelectorAll('.bg-white');
      cards.forEach(card => {
        if (mode === 'dark') {
          card.classList.remove('bg-white');
          card.classList.add('bg-gray-800');
        } else {
          card.classList.remove('bg-gray-800');
          card.classList.add('bg-white');
        }
      });
      
      // Обновляем кнопки в сайдбаре только если приложение открыто
      if (!$('#app').classList.contains('hidden')) {
        updateSidebarButtons();
      }
      
      // Обновляем цвета для загруженных файлов
      const fileChips = document.querySelectorAll('#uploadedFiles > div');
      fileChips.forEach(chip => {
        if (mode === 'dark') {
          chip.classList.remove('bg-gray-100');
          chip.classList.add('bg-gray-700');
        } else {
          chip.classList.remove('bg-gray-700');
          chip.classList.add('bg-gray-100');
        }
      });
      
      // Обновляем цвета кнопок
      const buttons = document.querySelectorAll('button.bg-gray-100, button.bg-gray-200');
      buttons.forEach(button => {
        if (mode === 'dark') {
          if (button.classList.contains('bg-gray-100')) {
            button.classList.remove('bg-gray-100');
            button.classList.add('bg-gray-700');
          }
          if (button.classList.contains('bg-gray-200')) {
            button.classList.remove('bg-gray-200');
            button.classList.add('bg-gray-600');
          }
          if (button.classList.contains('hover:bg-gray-200')) {
            button.classList.remove('hover:bg-gray-200');
            button.classList.add('hover:bg-gray-600');
          }
        } else {
          if (button.classList.contains('bg-gray-700')) {
            button.classList.remove('bg-gray-700');
            button.classList.add('bg-gray-100');
          }
          if (button.classList.contains('bg-gray-600')) {
            button.classList.remove('bg-gray-600');
            button.classList.add('bg-gray-200');
          }
          if (button.classList.contains('hover:bg-gray-600')) {
            button.classList.remove('hover:bg-gray-600');
            button.classList.add('hover:bg-gray-200');
          }
        }
      });
      
      // Принудительно обновляем стили для темной темы
      if (mode === 'dark') {
        document.body.style.backgroundColor = '#111827';
        document.body.style.color = '#f9fafb';
      } else {
        document.body.style.backgroundColor = '#f9fafb';
        document.body.style.color = '#111827';
      }
    };

    // Toast
    function toast(msg, type='info') {
      const wrap = $('#toast'); const box = wrap.firstElementChild;
      box.textContent = msg;
      wrap.classList.remove('hidden');
      box.className = 'px-4 py-2 rounded-lg text-sm shadow-lg ' + (type==='error'?'bg-red-600 text-white':type==='success'?'bg-green-600 text-white':'bg-gray-900 text-white');
      setTimeout(()=>wrap.classList.add('hidden'), 2200);
    }

    // Sessions
    function newSession(title='Новая сессия') {
      const id = 's_' + Math.random().toString(36).slice(2,9);
      const session = { id, title, createdAt: Date.now(), messages: [] };
      state.sessions.unshift(session);
      state.activeSessionId = id;
      renderSessions();
      renderChat();
      saveState();
      
      // Сохраняем историю пользователя если он авторизован
      if (state.user) {
        saveUserHistory(state.user.id);
      }
      
      return session;
    }
    const getActive = () => state.sessions.find(s => s.id === state.activeSessionId);

    function renderSessions() {
      const list = $('#sessionsList');
      list.innerHTML = '';
      state.sessions.forEach(s => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-gray-50 ' + (s.id===state.activeSessionId?'bg-gray-100':'');
        div.innerHTML = `
          <div class="h-7 w-7 rounded bg-gray-100 flex items-center justify-center">💬</div>
          <div class="flex-1">
            <div class="text-sm font-medium">${s.title}</div>
            <div class="text-xs text-gray-500">${new Date(s.createdAt).toLocaleString()}</div>
          </div>
          <button class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="rename">✏️</button>
          <button class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="del">🗑️</button>
        `;
        div.onclick = (e) => {
          if (e.target.dataset.act === 'rename') {
            const name = prompt('Название сессии', s.title) || s.title;
            s.title = name; renderSessions(); saveState(); 
            
            // Сохраняем историю пользователя если он авторизован
            if (state.user) {
              saveUserHistory(state.user.id);
            }
            return;
          }
          if (e.target.dataset.act === 'del') {
            state.sessions = state.sessions.filter(x => x.id !== s.id);
            if (state.activeSessionId === s.id) state.activeSessionId = state.sessions[0]?.id || null;
            renderSessions(); renderChat(); saveState(); 
            
            // Сохраняем историю пользователя если он авторизован
            if (state.user) {
              saveUserHistory(state.user.id);
            }
            return;
          }
          state.activeSessionId = s.id; renderSessions(); renderChat();
          
          // Сохраняем историю пользователя если он авторизован
          if (state.user) {
            saveUserHistory(state.user.id);
          }
        };
        list.appendChild(div);
      });
    }



    // Chat
    function renderChat() {
      const stream = $('#chatStream');
      stream.innerHTML = '';
      const s = getActive(); if (!s) return;
      s.messages.forEach(m => appendMessage(m.role, m.content, m.meta));
      stream.scrollTop = stream.scrollHeight;
    }

    function appendMessage(role, content, meta={}) {
      const stream = $('#chatStream');
      const wrap = document.createElement('div');
      wrap.className = 'flex items-start gap-3 mb-3';
      
      let avatar, bg, name;
      
      if (role === 'user') {
        avatar = '🧑';
        bg = 'bg-gray-50';
        name = t('user_name');
      } else if (role === 'system') {
        avatar = '📎';
        bg = 'bg-blue-50';
        name = 'Система';
      } else {
        avatar = '🤖';
        bg = 'bg-indigo-50/60';
        name = 'explAiner';
      }
      
      const formattedContent = formatText(content);
      const md = state.settings.explainJargon && role!=='user' && role!=='system' ? renderWithJargon(formattedContent) : marked.parse(formattedContent);
      
      wrap.innerHTML = `
        <div class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-lg">${avatar}</div>
        <div class="flex-1 min-w-0">
          <div class="text-xs text-gray-500">${name}</div>
          <div class="mt-1 p-3 rounded-lg ${bg} prose prose-sm max-w-none">${md}</div>
          ${role === 'assistant' ? `
          <div class="mt-1 flex items-center gap-2 text-xs">
            <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="tts">${t('btn_audio')}</button>
            <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="vid">${t('btn_video')}</button>
            <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="src">${t('btn_sources')}</button>
          </div>
          <div class="mt-2 hidden text-xs text-gray-600" data-role="sources"></div>
          `:''}
        </div>
      `;
      
      // Настраиваем обработчики событий только для сообщений ассистента
      if (role === 'assistant') {
        setupMessageEventHandlers(wrap, content, meta);
      }
      
      stream.appendChild(wrap);
      stream.scrollTop = stream.scrollHeight;
      // highlight code
      wrap.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
    }

    function setupMessageEventHandlers(wrap, content, meta={}) {
      const el = wrap.querySelector('[data-role="sources"]');
      wrap.addEventListener('click', async (e) => {
        if (!(e.target instanceof HTMLElement)) return;
        if (e.target.dataset.act === 'tts') {
          const text = stripHtml(content || '');
          await tts(text);
        }
        if (e.target.dataset.act === 'vid') {
          const text = stripHtml(content || '');
          await videoExplain(text);
        }
        if (e.target.dataset.act === 'src') {
          if (el) {
            if (el.classList.contains('hidden')) {
              el.classList.remove('hidden');
              el.innerHTML = renderSources(meta.sources || mockSources(textKeywords(content)));
            } else el.classList.add('hidden');
          }
        }
      });
    }
    
    function stripHtml(html) { const d = document.createElement('div'); d.innerHTML = html; return d.textContent || ''; }

    function renderWithJargon(text) {
      // простая подсветка терминов RU/EN
      const dict = {
        'GDPR': 'Общий регламент ЕС по защите данных. Требует законность, ограничение целей, минимизацию и права субъектов.',
        'CCPA': 'Закон Калифорнии о конфиденциальности потребителей.',
        'NDA': 'Соглашение о неразглашении — договор о конфиденциальности.',
        'Force majeure': 'Форс-мажор — обстоятельства непреодолимой силы.',
        'Indemnity': 'Индемнити — возмещение убытков и ответственность за риски.',
        'Non-compete': 'Неконкуренция — запрет работать на конкурентов в течение срока.',
        'Personal data': 'Персональные данные — любая информация об идентифицируемом лице.'
      };
      let safe = text || '';
      for (const [term, explain] of Object.entries(dict)) {
        const re = new RegExp(`\\b(${term})\\b`, 'gi');
        safe = safe.replace(re, `<span title="${explain}" class="underline decoration-dotted cursor-help">$1</span>`);
      }
      return marked.parse(safe);
    }

    function textKeywords(text='') {
      return (text.toLowerCase().match(/[a-zа-я]{4,}/gi) || []).slice(0,8);
    }

    function renderSources(sources=[]) {
      const items = sources.map(s => `<li class="mb-1"><a class="text-brand-600 hover:underline" target="_blank" href="${s.url}">${s.title}</a> <span class="text-gray-400">(${s.snippet})</span></li>`).join('');
      return `<div><div class="font-medium mb-1">Источники (факт‑чек)</div><ul class="list-disc pl-5">${items}</ul></div>`;
    }

    function mockSources(keywords=[]) {
      const q = encodeURIComponent(keywords.join(' '));
      return [
        { title: 'Google Scholar поиск', url: `https://scholar.google.com/scholar?q=${q}`, snippet: 'Быстрый поиск по правовым публикациям' },
        { title: 'EUR-Lex GDPR', url: 'https://eur-lex.europa.eu/eli/reg/2016/679/oj', snippet: 'Текст GDPR (официальный)' }
      ];
    }

    async function sendMessage() {
      const input = $('#chatInput'); const text = input.value.trim();
      if (!text) return;
      const s = getActive() || newSession();
      s.messages.push({ role:'user', content: text, meta:{} });
      appendMessage('user', text);
      input.value = '';

      const controller = new AbortController();
      $('#stopBtn').classList.remove('hidden');
      $('#sendBtn').disabled = true;
      state.busy = true;

      // AI placeholder / stream
      try {
        // Подготавливаем контекст с документами для анализа
        let contextMessage = text;
        if (state.docs && state.docs.length > 0) {
          const doc = state.docs[state.docs.length - 1];
          
          // Проверяем различные типы запросов к документу
          if (/анализ|проанализ|разбер|изуч|рассмотр/i.test(text)) {
            contextMessage = `Проанализируй следующий документ "${doc.name}":\n\n${doc.content}\n\nПользователь просит: ${text}`;
          } else if (/риск|опасност|проблем|недостат/i.test(text)) {
            contextMessage = `Найди риски и проблемы в документе "${doc.name}":\n\n${doc.content}\n\nПользователь просит: ${text}`;
          } else if (/ключев|важн|основн|главн/i.test(text)) {
            contextMessage = `Выдели ключевые моменты документа "${doc.name}":\n\n${doc.content}\n\nПользователь просит: ${text}`;
          } else if (/что|где|когда|как|почему|зачем/i.test(text)) {
            contextMessage = `Ответь на вопрос по документу "${doc.name}":\n\n${doc.content}\n\nВопрос: ${text}`;
          } else if (text.length < 50) {
            // Короткий запрос - вероятно, просто "проанализируй" или что-то подобное
            contextMessage = `Проанализируй документ "${doc.name}":\n\n${doc.content}`;
          }
        }

        const body = {
          model: state.settings.model,
          message: contextMessage,
          rag: state.settings.rag !== 'off' ? { source: state.settings.rag, docs: state.docs.map(d => ({ id:d.id, name:d.name, content: d.content })) } : null,
          multilingual: state.settings.multilingual,
          factCheck: state.settings.factCheck,
        };

        // Try real API; if fails — mock
        let reply = '';
        let messageElement = null;
        const res = await fetch(API.chat, { method:'POST', body: JSON.stringify(body), headers: { 'Content-Type':'application/json' }, signal: controller.signal });
        if (res.ok && res.body?.getReader) {
          // stream chunks if server streams
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          const result = await streamOut(reader, decoder);
          reply = result.text;
          messageElement = result.element;
        } else {
          reply = await res.text();
          if (!reply || !res.ok) throw new Error('No server');
        }
        if (!reply) reply = mockAnswer(text);
        const meta = { sources: state.settings.factCheck ? mockSources(textKeywords(text)) : [] };
        s.messages.push({ role:'assistant', content: reply, meta });
        
        // Если элемент сообщения уже создан в streamOut, обновим его, иначе создадим новый
        if (!messageElement) {
          appendMessage('assistant', reply, meta);
        }
        saveState();
        
        // Сохраняем историю пользователя если он авторизован
        if (state.user) {
          saveUserHistory(state.user.id);
        }
      } catch (e) {
        // mock
        const reply = mockAnswer(text);
        const meta = { sources: state.settings.factCheck ? mockSources(textKeywords(text)) : [] };
        s.messages.push({ role:'assistant', content: reply, meta });
        appendMessage('assistant', reply, meta);
        saveState();
        
        // Сохраняем историю пользователя если он авторизован
        if (state.user) {
          saveUserHistory(state.user.id);
        }
      } finally {
        state.busy = false;
        $('#stopBtn').classList.add('hidden');
        $('#sendBtn').disabled = false;
        $('#chatStream').scrollTop = $('#chatStream').scrollHeight;
      }
    }

    async function streamOut(reader, decoder) {
      let done = false, acc = '';
      // render typing placeholder
      const stream = $('#chatStream');
      const wrap = document.createElement('div');
      wrap.className = 'flex items-start gap-3 mb-3';
      wrap.innerHTML = `
        <div class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-lg">🤖</div>
        <div class="flex-1 min-w-0">
          <div class="text-xs text-gray-500">explAiner</div>
          <div class="mt-1 p-3 rounded-lg bg-indigo-50/60"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>
        </div>
      `;
      stream.appendChild(wrap);
      stream.scrollTop = stream.scrollHeight;

      while (!done) {
        const { value, done: d } = await reader.read();
        done = d;
        const chunk = decoder.decode(value || new Uint8Array(), { stream: true });
        if (chunk) acc += chunk;
      }
      // replace typing with real content
      const contentDiv = wrap.querySelector('.mt-1');
      contentDiv.innerHTML = `<div class="prose prose-sm max-w-none">${marked.parse(acc)}</div>`;
      wrap.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
      
      // Добавляем кнопки управления
      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'mt-1 flex items-center gap-2 text-xs';
      controlsDiv.innerHTML = `
        <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="tts">🔊 Аудио</button>
        <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="vid">🎬 Видео</button>
        <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="src">📚 Источники</button>
      `;
      wrap.querySelector('.flex-1').appendChild(controlsDiv);
      
      // Добавляем контейнер для источников
      const sourcesDiv = document.createElement('div');
      sourcesDiv.className = 'mt-2 hidden text-xs text-gray-600';
      sourcesDiv.dataset.role = 'sources';
      wrap.querySelector('.flex-1').appendChild(sourcesDiv);
      
      // Настраиваем обработчики событий для кнопок
      const meta = { sources: state.settings.factCheck ? mockSources(textKeywords(acc)) : [] };
      setupMessageEventHandlers(wrap, acc, meta);
      
      return { text: acc, element: wrap };
    }

    function mockAnswer(question) {
      // Проверяем, есть ли загруженные документы
      const hasDocuments = state.docs && state.docs.length > 0;
      
      // Если есть документы и пользователь просит анализ или задает вопросы
      if (hasDocuments && (/анализ|проанализ|разбер|изуч|рассмотр|риск|ключев|что|где|когда|как|почему|зачем/i.test(question) || question.length < 50)) {
        const doc = state.docs[state.docs.length - 1]; // Берем последний загруженный документ
        const content = doc.content || '';
        const wordCount = content.split(/\s+/).length;
        
        // Определяем тип запроса и формируем соответствующий ответ
        let analysis = '';
        
        if (/риск|опасност|проблем|недостат/i.test(question)) {
          analysis = `**Анализ рисков в документе "${doc.name}":**\n\n`;
        } else if (/ключев|важн|основн|главн/i.test(question)) {
          analysis = `**Ключевые моменты документа "${doc.name}":**\n\n`;
        } else if (/что|где|когда|как|почему|зачем/i.test(question)) {
          analysis = `**Ответ по документу "${doc.name}":**\n\n`;
        } else {
          analysis = `**Анализ документа "${doc.name}":**\n\n`;
        }
        
        // Основная информация
        analysis += `📄 **Общая информация:**\n`;
        analysis += `- Размер документа: ${(doc.size/1024).toFixed(1)} КБ\n`;
        analysis += `- Количество слов: ~${wordCount}\n`;
        analysis += `- Тип файла: ${doc.type || 'неизвестен'}\n\n`;
        
        // Анализ ключевых слов
        const legalKeywords = {
          'договор': /договор|соглашение|контракт/gi,
          'стороны': /сторона|сторон[аы]|заказчик|исполнитель|продавец|покупатель/gi,
          'обязательства': /обязательств|обязанност|должен|обязуется/gi,
          'ответственность': /ответственност|штраф|неустойк|санкц/gi,
          'сроки': /срок|период|время|дата|до|после/gi,
          'оплата': /оплат|платеж|стоимост|цена|сумм/gi,
          'конфиденциальность': /конфиденциальн|тайн|разглашен|NDA/gi,
          'персональные данные': /персональн.*данн|GDPR|обработк.*данн/gi,
          'форс-мажор': /форс.мажор|непреодолим.*сил|обстоятельств/gi
        };
        
        analysis += `🔍 **Ключевые элементы документа:**\n`;
        let foundElements = 0;
        
        for (const [category, regex] of Object.entries(legalKeywords)) {
          const matches = content.match(regex);
          if (matches && matches.length > 0) {
            analysis += `- ${category}: найдено ${matches.length} упоминаний\n`;
            foundElements++;
          }
        }
        
        if (foundElements === 0) {
          analysis += `- Документ содержит общий текст без явных юридических конструкций\n`;
        }
        
        // Специализированные разделы в зависимости от типа запроса
        if (/риск|опасност|проблем|недостат/i.test(question)) {
          analysis += `\n⚠️ **Выявленные риски:**\n`;
          
          if (content.match(/персональн.*данн|GDPR|обработк.*данн/gi)) {
            analysis += `- **Высокий риск**: Обработка персональных данных без явного соответствия GDPR\n`;
          }
          
          if (content.match(/штраф|неустойк|санкц/gi)) {
            analysis += `- **Финансовый риск**: Штрафные санкции - проверьте размер и обоснованность\n`;
          }
          
          if (content.match(/срок/gi) && !content.match(/продлен|пролонг/gi)) {
            analysis += `- **Временной риск**: Жесткие сроки без возможности продления\n`;
          }
          
          if (!content.match(/форс.мажор|непреодолим.*сил/gi)) {
            analysis += `- **Правовой риск**: Отсутствует защита от форс-мажорных обстоятельств\n`;
          }
          
          if (!content.match(/расторж|отказ/gi)) {
            analysis += `- **Контрактный риск**: Неясные условия расторжения\n`;
          }
          
        } else if (/ключев|важн|основн|главн/i.test(question)) {
          analysis += `\n🔑 **Ключевые положения:**\n`;
          
          if (content.match(/сторона|сторон[аы]/gi)) {
            analysis += `- Определены стороны договора и их роли\n`;
          }
          
          if (content.match(/обязательств|обязанност/gi)) {
            analysis += `- Прописаны взаимные обязательства сторон\n`;
          }
          
          if (content.match(/оплат|платеж|стоимост/gi)) {
            analysis += `- Указаны условия оплаты и стоимость\n`;
          }
          
          if (content.match(/срок/gi)) {
            analysis += `- Определены временные рамки исполнения\n`;
          }
          
          if (content.match(/ответственност/gi)) {
            analysis += `- Распределена ответственность между сторонами\n`;
          }
          
        } else {
          // Общий анализ рисков
          analysis += `\n⚠️ **Потенциальные области внимания:**\n`;
          
          if (content.match(/персональн.*данн|GDPR|обработк.*данн/gi)) {
            analysis += `- Обработка персональных данных - требуется проверка соответствия GDPR\n`;
          }
          
          if (content.match(/штраф|неустойк|санкц/gi)) {
            analysis += `- Штрафные санкции - проверьте размер и обоснованность\n`;
          }
          
          if (content.match(/срок/gi) && !content.match(/продлен|пролонг/gi)) {
            analysis += `- Сроки исполнения - убедитесь в реалистичности\n`;
          }
          
          if (!content.match(/форс.мажор|непреодолим.*сил/gi)) {
            analysis += `- Отсутствует оговорка о форс-мажоре\n`;
          }
        }
        
        analysis += `\n💡 **Рекомендации:**\n`;
        analysis += `- Внимательно изучите все условия и сроки\n`;
        analysis += `- При необходимости проконсультируйтесь с юристом\n`;
        analysis += `- Убедитесь в соответствии применимому законодательству\n`;
        
        analysis += `\n*Это автоматический анализ в демо-режиме и не является юридической консультацией.*`;
        
        return analysis;
      }
      
      // Стандартные ответы для разных типов вопросов
      const base = `Вот анализ вашего запроса:

1) Ключевые моменты: лицензия, ответственность, защита данных.
2) Риски по GDPR: минимизация, правовые основания, DPA, трансграничная передача.
3) Рекомендации: уточнить цели обработки, прописать сроки хранения, добавить права субъекта.

Это не является юридической консультацией.`;

      // немного разнообразия
      if (/сравн/i.test(question)) return `Для сравнения договоров загрузите два файла и нажмите "Сравнить". Мы подсветим расхождения (условия, сроки, штрафы) и выделим риски.`;
      if (/gdpr/i.test(question)) return `Для соответствия GDPR проверьте: законность обработки (Art.6), DPIA при высоких рисках, назначение DPO при необходимости, договор с процессором (Art.28).`;
      if (/что если|what if|нарушу/i.test(question)) return `Смоделируем сценарий: уведомление контрагента, возможные штрафы, судебный порядок, шанс медиации. Нажмите "What‑if симулятор" для диаграммы.`;
      
      // Если есть документы, но запрос не про анализ
      if (hasDocuments) {
        return base + `\n\n📎 У вас загружен документ "${state.docs[state.docs.length - 1].name}". Вы можете попросить проанализировать его или задать конкретные вопросы по содержанию.`;
      }
      
      return base;
    }

    // TTS (fallback: Web Speech API)
    async function tts(text) {
      try {
        // Try backend first
        const resp = await fetch(API.audio, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, voice: state.settings.voice }) });
        if (resp.ok) {
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url); audio.play();
          return;
        }
        throw new Error('No server');
      } catch {
        // Fallback
        if ('speechSynthesis' in window) {
          const utter = new SpeechSynthesisUtterance(text);
          if (state.settings.voice) {
            const voice = speechSynthesis.getVoices().find(v => v.name === state.settings.voice);
            if (voice) utter.voice = voice;
          }
          speechSynthesis.speak(utter);
          toast('Озвучка через SpeechSynthesis', 'info');
        } else {
          toast('TTS недоступен в браузере', 'error');
        }
      }
    }

    // Video (fallback: static avatar + audio)
    async function videoExplain(text) {
      try {
        const resp = await fetch(API.video, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, avatar: state.settings.avatar, voice: state.settings.voice }) });
        if (resp.ok) {
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const w = window.open('', '_blank');
          w.document.write(`<video controls autoplay style="width:100%"><source src="${url}" type="video/mp4"></video>`);
          return;
        }
        throw new Error('No server');
      } catch {
        // Fallback: audio + placeholder
        const w = window.open('', '_blank');
        const escaped = text.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        w.document.write(`
          <div style="font-family: system-ui; padding: 16px">
            <div style="display:flex; align-items:center; gap:12px">
              <div style="width:64px;height:64px;border-radius:50%;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-size:28px">🎬</div>
              <div><b>Видео‑объяснение (демо)</b><div style="color:#6b7280;font-size:12px">Фоллбэк: статичное изображение + аудио</div></div>
            </div>
            <p style="margin-top:12px;color:#374151">${escaped}</p>
            <audio id="a" controls autoplay></audio>
          </div>
        `);
        // generate audio via TTS fallback
        setTimeout(()=> {
          if (w && 'speechSynthesis' in w) {
            const u = new w.SpeechSynthesisUtterance(text);
            w.speechSynthesis.speak(u);
          }
        }, 300);
      }
    }

    // Voice input (SpeechRecognition fallback)
    async function toggleVoice() {
      try {
        if ('webkitSpeechRecognition' in window) {
          const rec = new webkitSpeechRecognition();
          rec.lang = 'ru-RU';
          rec.interimResults = false;
          rec.onresult = (e) => {
            const t = Array.from(e.results).map(r => r[0].transcript).join(' ');
            $('#chatInput').value = t;
            toast('Распознано голосом', 'success');
          };
          rec.onerror = (e) => {
            console.error('Speech recognition error:', e);
            toast('Ошибка распознавания: ' + (e.error || 'unknown'), 'error');
          };
          rec.start();
          toast('Говорите...', 'info');
        } else if ('SpeechRecognition' in window) {
          // Стандартный API (Firefox и другие)
          const rec = new SpeechRecognition();
          rec.lang = 'ru-RU';
          rec.interimResults = false;
          rec.onresult = (e) => {
            const t = Array.from(e.results).map(r => r[0].transcript).join(' ');
            $('#chatInput').value = t;
            toast('Распознано голосом', 'success');
          };
          rec.onerror = (e) => {
            console.error('Speech recognition error:', e);
            toast('Ошибка распознавания: ' + (e.error || 'unknown'), 'error');
          };
          rec.start();
          toast('Говорите...', 'info');
        } else {
          toast('SpeechRecognition недоступен. Проверьте разрешения микрофона в браузере.', 'error');
          console.error('SpeechRecognition API не поддерживается');
        }
      } catch (err) {
        console.error('Error initializing speech recognition:', err);
        toast('Ошибка инициализации распознавания речи: ' + err.message, 'error');
      }
    }

    // Upload
    function bindDropzone() {
      // Добавляем drag & drop на всю область чата
      const chatArea = $('#panelChat');
      ['dragenter','dragover'].forEach(ev => chatArea.addEventListener(ev, e => { 
        e.preventDefault(); 
        chatArea.classList.add('bg-blue-50'); 
      }));
      ['dragleave','drop'].forEach(ev => chatArea.addEventListener(ev, e => { 
        e.preventDefault(); 
        chatArea.classList.remove('bg-blue-50'); 
      }));
      chatArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
      $('#fileInput').addEventListener('change', e => handleFiles(e.target.files));
    }

    async function handleFiles(fileList) {
      const files = Array.from(fileList || []);
      for (const file of files) {
        const id = 'd_' + Math.random().toString(36).slice(2,9);
        let content = '';
        try {
          content = await readFileContent(file);
          // optional encrypt
          let payload = content;
          if (state.settings.encryption) {
            payload = await encryptText(content);
          }
          // Try backend upload
          try {
            const form = new FormData();
            form.append('file', file);
            form.append('encrypted', state.settings.encryption ? '1':'0');
            const resp = await fetch(API.upload, { method:'POST', body: form });
            if (!resp.ok) throw new Error('upload fail');
          } catch {}
          state.docs.push({ id, name:file.name, size:file.size, type:file.type || 'text/plain', content, createdAt: Date.now() });
          
          // Показываем уведомление о загруженном файле
          toast(`📎 Файл "${file.name}" загружен и готов к анализу`, 'success');
          
          // Добавляем сообщение в чат о загруженном файле
          const s = getActive() || newSession();
          const fileMessage = {
            role: 'system',
            content: `📎 Файл "${file.name}" (${(file.size/1024).toFixed(1)} KB) загружен и доступен для анализа. Вы можете задать вопросы о содержимом этого документа.`,
            meta: { fileId: id, fileName: file.name }
          };
          s.messages.push(fileMessage);
          appendMessage('system', fileMessage.content, fileMessage.meta);
          
          // Добавляем файл в контейнер загруженных файлов
          addFileToUploadedFiles(id, file.name, file.size);
          
        } catch (e) {
          toast(`❌ Ошибка загрузки файла "${file.name}": ${e.message}`, 'error');
        }
      }
      saveState();
      
      // Сохраняем историю пользователя если он авторизован
      if (state.user) {
        saveUserHistory(state.user.id);
      }
    }
    
    // Функция для отображения загруженных файлов в контейнере
    function addFileToUploadedFiles(id, fileName, fileSize) {
      const container = $('#uploadedFiles');
      container.classList.remove('hidden');
      
      const fileElement = document.createElement('div');
      // Проверяем текущую тему и применяем соответствующие стили
      const isDarkMode = document.body.dataset.theme === 'dark';
      fileElement.className = `px-2 py-1 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg flex items-center gap-2 text-xs cursor-pointer hover:opacity-90`;
      fileElement.dataset.fileId = id;
      
      // Определяем иконку в зависимости от типа файла
      let fileIcon = '📄';
      if (fileName.toLowerCase().endsWith('.pdf')) fileIcon = '📕';
      else if (fileName.toLowerCase().endsWith('.doc') || fileName.toLowerCase().endsWith('.docx')) fileIcon = '📘';
      else if (fileName.toLowerCase().endsWith('.txt')) fileIcon = '📝';
      
      fileElement.innerHTML = `
        <span>${fileIcon}</span>
        <span class="truncate max-w-[150px]">${fileName}</span>
        <span class="text-gray-500">(${(fileSize/1024).toFixed(1)} KB)</span>
        <button class="ml-1 text-gray-400 hover:text-gray-600" data-action="remove-file">×</button>
      `;
      
      // Добавляем обработчик для удаления файла
      fileElement.querySelector('[data-action="remove-file"]').addEventListener('click', (e) => {
        e.stopPropagation();
        // Удаляем файл из state.docs
        state.docs = state.docs.filter(d => d.id !== id);
        // Удаляем элемент из DOM
        fileElement.remove();
        // Если больше нет файлов, скрываем контейнер
        if (!state.docs.length) {
          container.classList.add('hidden');
        }
        saveState();
        toast(`Файл "${fileName}" удален`, 'info');
      });
      
      // Добавляем обработчик для просмотра содержимого файла
      fileElement.addEventListener('click', () => {
        const doc = state.docs.find(d => d.id === id);
        if (doc) {
          // Создаем модальное окно для просмотра содержимого
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4';
          const isDarkMode = document.body.dataset.theme === 'dark';
          modal.innerHTML = `
            <div class="${isDarkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold">${doc.name}</h3>
                <button class="${isDarkMode ? 'text-gray-300 hover:text-gray-100' : 'text-gray-500 hover:text-gray-700'} text-xl" data-action="close-modal">&times;</button>
              </div>
              <div class="${isDarkMode ? 'border-gray-600' : 'border'} rounded-lg p-4 max-h-[60vh] overflow-auto ${isDarkMode ? 'bg-gray-700' : ''}">
                <pre class="whitespace-pre-wrap text-sm">${escapeHtml(doc.content.slice(0, 10000))}${doc.content.length > 10000 ? '...' : ''}</pre>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          
          // Добавляем обработчик для закрытия модального окна
          modal.querySelector('[data-action="close-modal"]').addEventListener('click', () => {
            modal.remove();
          });
          
          // Закрытие по клику вне содержимого
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }
      });
      
      container.appendChild(fileElement);
    }

    async function readFileContent(file) {
      if (file.type === 'application/pdf' && window['pdfjsLib']) {
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        let text = '';
        for (let i=1;i<=pdf.numPages;i++){
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(it => it.str).join(' ') + '\n';
        }
        return text;
      }
      if (file.type.startsWith('text/') || /\.(txt|md|csv|json)$/i.test(file.name)) {
        return await file.text();
      }
      // simple fallback: base64
      const b = await file.arrayBuffer();
      return btoa(String.fromCharCode(...new Uint8Array(b)));
    }

    // AES-GCM demo
    async function getCryptoKey() {
      if (state.crypto.key) return state.crypto.key;
      const key = await crypto.subtle.generateKey({ name:'AES-GCM', length:256 }, true, ['encrypt','decrypt']);
      state.crypto.key = key; return key;
    }
    async function encryptText(plain) {
      const key = await getCryptoKey();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = new TextEncoder().encode(plain);
      const ct = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, enc);
      return JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(ct)) });
    }

    // Compliance checker (mock local)
    async function runComplianceCheck() {
      const txt = $('#complianceText').value || '';
      if (!txt.trim()) return toast('Вставьте текст для анализа', 'error');
      
      // Получаем выбранные профили
      const profiles = [];
      if ($('#profileGDPR').checked) profiles.push('GDPR');
      if ($('#profileCCPA').checked) profiles.push('CCPA');
      if ($('#profileHIPAA').checked) profiles.push('HIPAA');
      
      try {
        // Отправляем запрос на сервер
        const res = await fetch(API.compliance, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text: txt, profiles })
        });
        
        if (res.ok) {
          const data = await res.json();
          $('#complianceResult').innerHTML = `
            <div class="p-3 rounded bg-gray-50">
              <div><b>Оценка соответствия:</b> ${data.score}/100</div>
              <ul class="list-disc pl-5 mt-2">${data.issues.map(i=>`<li>${i}</li>`).join('') || '<li>Критичных замечаний не выявлено.</li>'}</ul>
            </div>`;
        } else {
          throw new Error('Ошибка сервера');
        }
      } catch (e) {
        // Локальный фолбэк
        const issues = [];
        if (!/consent|соглас/i.test(txt)) issues.push('Нет явного основания обработки (consent/contract).');
        if (/third.?party|треть/i.test(txt)) issues.push('Указана передача третьим лицам — требуется DPA и SCC при трансграничной передаче.');
        if (!/retention|срок/i.test(txt)) issues.push('Не указан срок хранения.');
        if (!/rights|права субъекта/i.test(txt)) issues.push('Нет описания прав субъекта (доступ, удаление, перенос).');
        const score = Math.max(0, 100 - issues.length*20);
        $('#complianceResult').innerHTML = `
          <div class="p-3 rounded bg-gray-50">
            <div><b>Оценка соответствия:</b> ${score}/100</div>
            <ul class="list-disc pl-5 mt-2">${issues.map(i=>`<li>${i}</li>`).join('') || '<li>Критичных замечаний не выявлено (локальный режим)</li>'}</ul>
          </div>`;
        toast('Используется локальный анализ', 'info');
      }
    }
    async function suggestComplianceFixes() {
      const txt = $('#complianceText').value || '';
      if (!txt.trim()) return toast('Вставьте текст для анализа', 'error');
      
      // Получаем выбранные профили
      const profiles = [];
      if ($('#profileGDPR').checked) profiles.push('GDPR');
      if ($('#profileCCPA').checked) profiles.push('CCPA');
      if ($('#profileHIPAA').checked) profiles.push('HIPAA');
      
      try {
        // Отправляем запрос на сервер
        const res = await fetch(API.compliance, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text: txt, profiles })
        });
        
        if (res.ok) {
          const data = await res.json();
          const suggestionsList = data.suggestions.map(s => `- ${s}`).join('\n');
          $('#complianceResult').innerHTML += `<div class="mt-2 p-3 rounded bg-green-50"><b>Предложения по исправлению:</b><pre class="whitespace-pre-wrap text-sm">${suggestionsList}</pre></div>`;
        } else {
          throw new Error('Ошибка сервера');
        }
      } catch (e) {
        // Локальный фолбэк
        const suggestions = `
- Добавьте правовое основание обработки (Art.6 GDPR) и цели.
- Укажите сроки хранения и критерии их определения.
- Опишите права субъекта и порядок их реализации.
- Заключите DPA с процессорами и укажите меры безопасности (Art.28).
- Для передачи вне ЕЭЗ — примените SCC/адекватность.`;
        $('#complianceResult').innerHTML += `<div class="mt-2 p-3 rounded bg-green-50"><b>Предложения по исправлению:</b><pre class="whitespace-pre-wrap text-sm">${suggestions}</pre></div>`;
        toast('Используются локальные рекомендации', 'info');
      }
    }

    // Functions for document comparison
    async function handleCompareFileUpload(fileInput, docType) {
      const file = fileInput.files[0];
      if (!file) return;
      
      console.log(`Загружается документ ${docType}:`, file.name, file.size, 'bytes');
      
      try {
        const content = await readFileContent(file);
        console.log(`Содержимое документа ${docType} загружено:`, content.length, 'символов');
        
        const doc = {
          id: 'compare_' + docType + '_' + Math.random().toString(36).slice(2,9),
          name: file.name,
          size: file.size,
          type: file.type || 'text/plain',
          content: content,
          createdAt: Date.now()
        };
        
        // Сохраняем документ в состояние сравнения
        state.compare[docType] = doc;
        console.log(`Документ ${docType} сохранен в state.compare:`, state.compare);
        
        // Обновляем интерфейс
        updateCompareDocumentPreview(docType, doc);
        updateCompareButton();
        
        toast(`Документ ${docType.toUpperCase()} загружен: ${file.name}`, 'success');
        
      } catch (error) {
        console.error(`Ошибка загрузки документа ${docType}:`, error);
        toast(`Ошибка загрузки документа ${docType.toUpperCase()}: ${error.message}`, 'error');
      }
    }
    
    function updateCompareDocumentPreview(docType, doc) {
      const previewDiv = $(`#doc${docType.toUpperCase()}Preview`);
      const nameDiv = $(`#doc${docType.toUpperCase()}Name`);
      const sizeDiv = $(`#doc${docType.toUpperCase()}Size`);
      const statusDiv = $(`#doc${docType.toUpperCase()}Status`);
      const uploadBtn = $(`#uploadDoc${docType.toUpperCase()}`);
      
      if (previewDiv && nameDiv && sizeDiv && statusDiv && uploadBtn) {
        // Показываем блок предпросмотра
        previewDiv.classList.remove('hidden');
        
        // Обновляем информацию о документе
        nameDiv.textContent = doc.name;
        sizeDiv.textContent = `${(doc.size/1024).toFixed(1)} KB`;
        
        // Обновляем статус
        statusDiv.textContent = 'Документ загружен';
        statusDiv.classList.remove('text-gray-500');
        statusDiv.classList.add('text-green-600', 'font-bold');
        
        // Добавляем анимацию для привлечения внимания
        statusDiv.classList.add('animate-pulse');
        setTimeout(() => {
          statusDiv.classList.remove('animate-pulse');
        }, 2000);
        
        // Меняем кнопку на "Заменить"
        uploadBtn.innerHTML = `<span>🔄</span> Заменить документ ${docType.toUpperCase()}`;
        
        // Добавляем небольшой предпросмотр содержимого
        const contentPreview = document.createElement('div');
        contentPreview.className = 'mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600 max-h-20 overflow-y-auto';
        contentPreview.textContent = doc.content.substring(0, 200) + (doc.content.length > 200 ? '...' : '');
        
        // Удаляем предыдущий предпросмотр, если он есть
        const existingPreview = previewDiv.querySelector('.bg-gray-50');
        if (existingPreview) {
          existingPreview.remove();
        }
        
        // Добавляем новый предпросмотр
        previewDiv.appendChild(contentPreview);
      }
    }
    
    function updateCompareButton() {
      const runCompareBtn = $('#runCompare');
      const compareStatus = $('#compareStatus');
      
      if (runCompareBtn && compareStatus) {
        const hasDocA = state.compare.docA !== null;
        const hasDocB = state.compare.docB !== null;
        
        if (hasDocA && hasDocB) {
          runCompareBtn.disabled = false;
          runCompareBtn.classList.remove('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
          compareStatus.textContent = 'Готово к сравнению';
          compareStatus.classList.remove('text-gray-500', 'text-red-500');
          compareStatus.classList.add('text-green-600', 'font-bold');
        } else if (hasDocA || hasDocB) {
          runCompareBtn.disabled = true;
          runCompareBtn.classList.add('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
          compareStatus.textContent = hasDocA ? 'Загрузите документ B' : 'Загрузите документ A';
          compareStatus.classList.remove('text-green-600', 'text-red-500');
          compareStatus.classList.add('text-gray-500');
        } else {
          runCompareBtn.disabled = true;
          runCompareBtn.classList.add('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
          compareStatus.textContent = 'Загрузите оба документа для сравнения';
          compareStatus.classList.remove('text-green-600', 'text-gray-500');
          compareStatus.classList.add('text-red-500');
        }
      }
    }
    
    // Инициализация интерфейса сравнения документов
    function initCompare() {
      // Проверяем наличие сохраненных документов
      if (state.compare.docA) {
        updateCompareDocumentPreview('a', state.compare.docA);
      }
      
      if (state.compare.docB) {
        updateCompareDocumentPreview('b', state.compare.docB);
      }
      
      // Обновляем состояние кнопки сравнения
      updateCompareButton();
    }

    // Contract compare
    async function runCompare() {
      console.log('Запуск сравнения документов');
      console.log('state.compare:', state.compare);
      
      const a = state.compare.docA;
      const b = state.compare.docB;
      
      console.log('Документ A:', a ? a.name : 'не загружен');
      console.log('Документ B:', b ? b.name : 'не загружен');
      
      if (!a || !b) {
        console.log('Один или оба документа отсутствуют');
        return toast('Загрузите оба документа для сравнения', 'error');
      }
      
      console.log('Начинаем сравнение документов:', a.name, 'vs', b.name);
      $('#compareResult').innerHTML = `<div class="p-3 rounded bg-gray-50 text-center">Сравнение документов...</div>`;
      
      try {
        // Пробуем использовать API
        const res = await fetch(API.compare, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ doc_a: a.content, doc_b: b.content })
        });
        
        if (res.ok) {
          const data = await res.json();
          
          // Форматируем результаты
          let html = '';
          data.diffs.forEach(diff => {
            if (diff.type === 'added') {
              html += `<div class="bg-green-50 py-1 px-2 border-l-4 border-green-500">${escapeHtml(diff.text)}</div>`;
            } else if (diff.type === 'removed') {
              html += `<div class="bg-red-50 py-1 px-2 border-l-4 border-red-500 line-through">${escapeHtml(diff.text)}</div>`;
            } else {
              html += `<div class="py-1 px-2">${escapeHtml(diff.text)}</div>`;
            }
          });
          
          $('#compareResult').innerHTML = `
            <div class="text-xs text-gray-500 mb-1">${a.name} ↔ ${b.name}</div>
            <div class="p-3 border rounded-lg max-h-64 overflow-auto">${html}</div>
            <div class="mt-2 text-xs text-gray-600">${data.summary}</div>
          `;
          return;
        }
      } catch (e) {
        console.log('API недоступен, используем локальное сравнение');
      }
      
      // Локальное сравнение документов
      const result = compareDocumentsLocally(a, b);
      $('#compareResult').innerHTML = result;
      
      // Сохраняем историю пользователя если он авторизован
      if (state.user) {
        saveUserHistory(state.user.id);
      }
      
      toast('Используется локальное сравнение документов', 'info');
    }
    
    function compareDocumentsLocally(docA, docB) {
      const contentA = docA.content || '';
      const contentB = docB.content || '';
      
      // Разбиваем документы на строки для сравнения
      const linesA = contentA.split('\n').filter(line => line.trim());
      const linesB = contentB.split('\n').filter(line => line.trim());
      
      // Находим общие и различающиеся строки
      const commonLines = [];
      const onlyInA = [];
      const onlyInB = [];
      
      // Простое сравнение строк
      linesA.forEach((lineA, indexA) => {
        const foundInB = linesB.findIndex(lineB => 
          lineA.toLowerCase().trim() === lineB.toLowerCase().trim()
        );
        
        if (foundInB !== -1) {
          commonLines.push({ text: lineA, type: 'common' });
        } else {
          onlyInA.push({ text: lineA, type: 'removed', line: indexA + 1 });
        }
      });
      
      linesB.forEach((lineB, indexB) => {
        const foundInA = linesA.findIndex(lineA => 
          lineA.toLowerCase().trim() === lineB.toLowerCase().trim()
        );
        
        if (foundInA === -1) {
          onlyInB.push({ text: lineB, type: 'added', line: indexB + 1 });
        }
      });
      
      // Генерируем HTML результат
      let html = `
        <div class="text-xs text-gray-500 mb-3 flex items-center justify-between">
          <span>${docA.name} ↔ ${docB.name}</span>
          <span class="text-xs">Найдено различий: ${onlyInA.length + onlyInB.length}</span>
        </div>
      `;
      
      if (onlyInA.length === 0 && onlyInB.length === 0) {
        html += `
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg text-center">
            <div class="text-green-700 font-medium">✅ Документы идентичны</div>
            <div class="text-green-600 text-sm mt-1">Содержимое документов полностью совпадает</div>
          </div>
        `;
      } else {
        html += `<div class="space-y-2 max-h-64 overflow-auto">`;
        
        // Показываем различия
        if (onlyInA.length > 0) {
          html += `
            <div class="border-l-4 border-red-400 pl-3">
              <div class="text-sm font-medium text-red-700 mb-2">Только в "${docA.name}" (${onlyInA.length} строк):</div>
          `;
          
          onlyInA.forEach(item => {
            html += `<div class="bg-red-50 py-1 px-2 rounded text-sm mb-1">
              <span class="text-red-600 line-through">${escapeHtml(item.text)}</span>
            </div>`;
          });
          
          html += `</div>`;
        }
        
        if (onlyInB.length > 0) {
          html += `
            <div class="border-l-4 border-green-400 pl-3">
              <div class="text-sm font-medium text-green-700 mb-2">Только в "${docB.name}" (${onlyInB.length} строк):</div>
          `;
          
          onlyInB.forEach(item => {
            html += `<div class="bg-green-50 py-1 px-2 rounded text-sm mb-1">
              <span class="text-green-600">${escapeHtml(item.text)}</span>
            </div>`;
          });
          
          html += `</div>`;
        }
        
        html += `</div>`;
        
        // Добавляем статистику
        html += `
          <div class="mt-3 p-3 bg-gray-50 rounded-lg text-xs">
            <div class="font-medium text-gray-700 mb-1">Статистика сравнения:</div>
            <div class="grid grid-cols-3 gap-2 text-center">
              <div>
                <div class="text-gray-500">Общие строки</div>
                <div class="font-medium text-gray-700">${commonLines.length}</div>
              </div>
              <div>
                <div class="text-red-500">Удалено</div>
                <div class="font-medium text-red-600">${onlyInA.length}</div>
              </div>
              <div>
                <div class="text-green-500">Добавлено</div>
                <div class="font-medium text-green-600">${onlyInB.length}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      return html;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]) }

    // What-if Mermaid
    async function genFlow() {
      const q = ($('#whatIfInput').value || '').trim();
      
      // Показываем индикатор загрузки и делаем видимым контейнер
      const wrap = $('#flowWrap');
      wrap.classList.remove('hidden');
      wrap.innerHTML = '<div class="p-3 rounded bg-gray-50 text-center">Генерация диаграммы...</div>';
      
      try {
        // Пробуем использовать API
        if (q) {
          const res = await fetch(API.whatif, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ question: q })
          });
          
          if (res.ok) {
            const data = await res.json();
            
            // Создаем диаграмму
            const el = document.createElement('div');
            el.className = 'mermaid';
            el.textContent = data.diagram;
            wrap.innerHTML = '';
            wrap.appendChild(el);
            
            // Рендерим диаграмму
            if (window.mermaid && typeof window.mermaid.run === 'function') {
              try {
                await window.mermaid.run({ nodes:[el] });
              } catch (mermaidErr) {
                console.error('Mermaid rendering error:', mermaidErr);
                el.textContent = "Ошибка рендеринга диаграммы: " + mermaidErr.message;
              }
            } else {
              console.error('Mermaid library not properly loaded');
              el.textContent = "Библиотека Mermaid не загружена. Невозможно отрендерить диаграмму.";
            }
            
            // Добавляем пояснение
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'mt-3 text-sm p-3 bg-gray-50 rounded';
            explanationDiv.textContent = data.explanation;
            wrap.appendChild(explanationDiv);
            
            return;
          }
        }
        
        // Локальный фолбэк
        throw new Error('Используем локальную генерацию');
      } catch (e) {
        // Локальный фолбэк
        const diagram = q ? makeMermaidFromQuestion(q) : `flowchart TD
A[Нарушение договора] --> B{Уведомление контрагента?}
B -->|Да| C[Попытка урегулирования]
B -->|Нет| D[Расторжение/штраф]
C --> E{Согласие достигнуто?}
E -->|Да| F[Доп. соглашение]
E -->|Нет| D
D --> G[Судебная перспектива]`;
        
        const id = 'm_' + Math.random().toString(36).slice(2,8);
        const el = document.createElement('div');
        el.className = 'mermaid';
        el.textContent = diagram;
        wrap.innerHTML = '';
        wrap.appendChild(el);
        if (window.mermaid && typeof window.mermaid.run === 'function') {
          try {
            await window.mermaid.run({ nodes:[el] });
          } catch (mermaidErr) {
            console.error('Mermaid rendering error:', mermaidErr);
            el.textContent = "Ошибка рендеринга диаграммы: " + mermaidErr.message;
          }
        } else {
          console.error('Mermaid library not properly loaded');
          el.textContent = "Библиотека Mermaid не загружена. Невозможно отрендерить диаграмму.";
        }
        
        // Добавляем локальное пояснение
        const explanationDiv = document.createElement('div');
        explanationDiv.className = 'mt-3 text-sm p-3 bg-gray-50 rounded';
        explanationDiv.textContent = 'Диаграмма показывает возможные сценарии развития ситуации (локальный режим).';
        wrap.appendChild(explanationDiv);
        
        if (q) toast('Используется локальная генерация', 'info');
        
        // Сохраняем историю пользователя если он авторизован
        if (state.user) {
          saveUserHistory(state.user.id);
        }
      }
    }
    
    function makeMermaidFromQuestion(q) {
      // мини-шаблонизатор
      if (/gdpr|персонал/i.test(q)) {
        return `flowchart TD
A[Обработка персональных данных] --> B{Есть основание?}
B -->|Consent/Contract| C[Определить цели и объем]
B -->|Нет| H[Запрет/Ограничить]
C --> D{Передача за пределы ЕЭЗ?}
D -->|Да| E[SCC/Адекватность]
D -->|Нет| F[Локальная обработка]
C --> G[Права субъекта, сроки хранения]`;
      }
      return `flowchart TD
A[Сценарий: ${q.slice(0,28)}] --> B{Риск?}
B -->|Высокий| C[Эскалация/Юр.оценка]
B -->|Низкий| D[Урегулирование]
C --> E[Меры снижения риска]
D --> F[Мониторинг]`;
    }

    // Auth (demo)
    function showLoginModal(show=true){ 
      $('#loginModal').classList.toggle('hidden', !show); 
      $('#loginModal').classList.toggle('flex', show); 
      
      if (show) {
        // Показываем форму входа по умолчанию
        $('#loginFormContainer').classList.remove('hidden');
        $('#registerFormContainer').classList.add('hidden');
        
        // Очищаем поля форм
        $('#loginForm').reset();
        $('#registerForm').reset();
      }
    }
    
    // Demo modal
    function showDemoModal(show=true){
      const modal = $('#demoModal');
      modal.classList.toggle('hidden', !show); 
      modal.classList.toggle('flex', show);
      
      if (show) {
        // Добавляем обработчик для закрытия по клику вне модального окна
        const handleClickOutside = function(e) {
          if (e.target === modal) {
            showDemoModal(false);
            modal.removeEventListener('click', handleClickOutside);
          }
        };
        modal.addEventListener('click', handleClickOutside);
      }
    }
    // Система аутентификации
    function loginDemo() {
      const email = $('#loginEmail').value.trim();
      const password = $('#loginPassword').value;
      
      if (!email || !password) {
        toast('Пожалуйста, заполните все поля', 'error');
        return;
      }
      
      // Проверяем существующих пользователей
      const users = JSON.parse(localStorage.getItem('explainer_users') || '[]');
      const user = users.find(u => u.email === email && u.password === password);
      
      if (user) {
        // Успешный вход
        state.user = {
          id: user.id,
          email: user.email,
          name: user.name,
          createdAt: user.createdAt
        };
        
        // Загружаем историю пользователя
        loadUserHistory(user.id);
        
        // Обновляем UI
        updateUserInterface();
      showLoginModal(false);
        toast(`Добро пожаловать, ${user.name}!`, 'success');
      saveState();
      showApp();
        
        // Показываем приветственное сообщение
        setTimeout(() => {
          showWelcomeMessage(user.name);
        }, 500);
      } else {
        toast('Неверный email или пароль', 'error');
      }
    }
    
    function registerUser() {
      const name = $('#registerName').value.trim();
      const email = $('#registerEmail').value.trim();
      const password = $('#registerPassword').value;
      const passwordConfirm = $('#registerPasswordConfirm').value;
      
      if (!name || !email || !password || !passwordConfirm) {
        toast('Пожалуйста, заполните все поля', 'error');
        return;
      }
      
      if (password.length < 6) {
        toast('Пароль должен содержать минимум 6 символов', 'error');
        return;
      }
      
      if (password !== passwordConfirm) {
        toast('Пароли не совпадают', 'error');
        return;
      }
      
      // Проверяем, не существует ли уже пользователь с таким email
      const users = JSON.parse(localStorage.getItem('explainer_users') || '[]');
      if (users.find(u => u.email === email)) {
        toast('Пользователь с таким email уже существует', 'error');
        return;
      }
      
      // Создаем нового пользователя
      const newUser = {
        id: generateUserId(),
        name: name,
        email: email,
        password: password,
        createdAt: new Date().toISOString()
      };
      
      // Добавляем пользователя в список
      users.push(newUser);
      localStorage.setItem('explainer_users', JSON.stringify(users));
      
      // Автоматически входим
      state.user = {
        id: newUser.id,
        email: newUser.email,
        name: newUser.name,
        createdAt: newUser.createdAt
      };
      
      // Создаем пустую историю для нового пользователя
      initializeUserHistory(newUser.id);
      
              // Обновляем UI
        updateUserInterface();
        showLoginModal(false);
        toast(`Аккаунт создан! Добро пожаловать, ${name}!`, 'success');
        saveState();
        showApp();
        
        // Показываем приветственное сообщение для нового пользователя
        setTimeout(() => {
          showWelcomeMessage(name);
        }, 500);
    }
    
    function logoutDemo() {
      // Сохраняем текущую историю перед выходом
      if (state.user) {
        saveUserHistory(state.user.id);
      }
      
      state.user = null;
      saveState();
      
      // Сбрасываем UI
      $('#loginBtn').classList.remove('hidden');
      $('#userMenu').classList.add('hidden');
      $('#userEmail').textContent = '';
      $('#userInitial').textContent = '';
      
      toast('Вы вышли из системы', 'info');
      showLanding();
    }
    
    // Генерация уникального ID пользователя
    function generateUserId() {
      return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // Обновление пользовательского интерфейса
    function updateUserInterface() {
      if (state.user) {
        $('#userEmail').textContent = state.user.email;
        $('#userInitial').textContent = state.user.name.charAt(0).toUpperCase();
        $('#loginBtn').classList.add('hidden');
        $('#userMenu').classList.remove('hidden');
        
        // Показываем информацию о пользователе
        const userInfo = document.createElement('div');
        userInfo.className = 'text-xs text-gray-500 mt-1';
        userInfo.textContent = `Зарегистрирован: ${new Date(state.user.createdAt).toLocaleDateString()}`;
        
        // Добавляем информацию под email если её ещё нет
        const userEmail = $('#userEmail');
        if (userEmail && !userEmail.nextElementSibling?.classList.contains('text-xs')) {
          userEmail.parentNode.appendChild(userInfo);
        }
        
        // Добавляем tooltip для аватара
        const userAvatar = $('#userInitial');
        if (userAvatar) {
          userAvatar.title = `Пользователь: ${state.user.name}\nEmail: ${state.user.email}\nДата регистрации: ${new Date(state.user.createdAt).toLocaleDateString()}`;
        }
      }
    }
    
    // Управление историей пользователей
    function initializeUserHistory(userId) {
      const userHistory = {
        sessions: [],
        documents: [],
        translations: [],
        comparisons: [],
        whatIfScenarios: []
      };
      localStorage.setItem(`explainer_history_${userId}`, JSON.stringify(userHistory));
    }
    
    function saveUserHistory(userId) {
      if (!userId) return;
      
      const userHistory = {
        sessions: state.sessions || [],
        documents: state.docs || [],
        translations: state.translateFile ? [state.translateFile] : [],
        comparisons: state.compare || {},
        whatIfScenarios: state.whatIfFile ? [state.whatIfFile] : []
      };
      
      localStorage.setItem(`explainer_history_${userId}`, JSON.stringify(userHistory));
    }
    
    function loadUserHistory(userId) {
      if (!userId) return;
      
      const userHistory = JSON.parse(localStorage.getItem(`explainer_history_${userId}`) || '{}');
      
      // Восстанавливаем сессии
      if (userHistory.sessions && userHistory.sessions.length > 0) {
        state.sessions = userHistory.sessions;
        state.activeSessionId = userHistory.sessions[0].id;
      }
      
      // Восстанавливаем документы
      if (userHistory.documents && userHistory.documents.length > 0) {
        state.docs = userHistory.documents;
      }
      
      // Восстанавливаем другие данные
      if (userHistory.translations && userHistory.translations.length > 0) {
        state.translateFile = userHistory.translations[0];
      }
      
      if (userHistory.comparisons) {
        state.compare = userHistory.comparisons;
      }
      
      if (userHistory.whatIfScenarios && userHistory.whatIfScenarios.length > 0) {
        state.whatIfFile = userHistory.whatIfScenarios[0];
      }
    }
    
    // Функция для автоматического сохранения истории при различных действиях
    function autoSaveUserHistory() {
      if (state.user) {
        // Используем debounce для оптимизации частых сохранений
        clearTimeout(state.autoSaveTimeout);
        state.autoSaveTimeout = setTimeout(() => {
          saveUserHistory(state.user.id);
        }, 1000); // Сохраняем через 1 секунду после последнего изменения
      }
    }
    
    // Функция для очистки истории пользователя
    function clearUserHistory(userId) {
      if (!userId) return;
      
      if (confirm('Вы уверены, что хотите очистить всю историю?\n\n⚠️ Это действие нельзя отменить!\n\n💡 Рекомендуем сначала экспортировать историю кнопкой 📥')) {
                  localStorage.removeItem(`explainer_history_${userId}`);
          toast('История очищена! Все данные удалены безвозвратно. 🗑️ Система готова к новым данным. 💡 Для восстановления используйте кнопку 📤 (импорт истории).', 'info');
        
        // Сбрасываем состояние
        state.sessions = [];
        state.docs = [];
        state.translateFile = null;
        state.compare = {};
        state.whatIfFile = null;
        
                  // Создаем новую сессию
          newSession('Новая сессия');
          renderSessions();
          renderChat();
          renderUploadedFiles();
          saveState();
          
          // Показываем уведомление о том, что можно импортировать историю
          setTimeout(() => {
            toast('💡 Теперь вы можете импортировать сохраненную историю кнопкой 📤 или начать работу с чистого листа! 🚀 Система готова к новым данным. 📝 Все изменения будут автоматически сохраняться. 🔒 Ваши новые данные будут защищены. 🎯 Начните с создания новой сессии чата! 💬 Или загрузите документ для анализа. 🔎 Используйте все доступные инструменты в сайдбаре. 🌟 Система автоматически сохраняет все ваши действия.', 'info');
          }, 1000);
      }
    }
    
    // Функция для показа статистики пользователя
    function showUserStats() {
      if (!state.user) return;
      
      const userHistory = JSON.parse(localStorage.getItem(`explainer_history_${state.user.id}`) || '{}');
      
      let stats = `
        <div class="p-4 bg-white rounded-lg shadow-lg max-w-md">
          <h3 class="text-lg font-semibold mb-4">📊 Статистика пользователя</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span>Имя:</span>
              <span class="font-medium">${state.user.name}</span>
            </div>
            <div class="flex justify-between">
              <span>Email:</span>
              <span class="font-medium">${state.user.email}</span>
            </div>
            <div class="flex justify-between">
              <span>Дата регистрации:</span>
              <span class="font-medium">${new Date(state.user.createdAt).toLocaleDateString()}</span>
            </div>
            <div class="flex justify-between">
              <span>Сессий чата:</span>
              <span class="font-medium">${userHistory.sessions?.length || 0}</span>
            </div>
            <div class="flex justify-between">
              <span>Загружено документов:</span>
              <span class="font-medium">${userHistory.documents?.length || 0}</span>
            </div>
            <div class="flex justify-between">
              <span>Выполнено переводов:</span>
              <span class="font-medium">${userHistory.translations?.length || 0}</span>
            </div>
            <div class="flex justify-between">
              <span>Сравнений документов:</span>
              <span class="font-medium">${userHistory.comparisons?.docA ? 1 : 0}</span>
            </div>
            <div class="flex justify-between">
              <span>What-if сценариев:</span>
              <span class="font-medium">${userHistory.whatIfScenarios?.length || 0}</span>
            </div>
          </div>
        </div>
      `;
      
      // Показываем статистику в модальном окне
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-md w-full">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">📊 Статистика</h3>
            <button class="text-gray-400 hover:text-gray-600 text-xl" data-action="close-modal">&times;</button>
          </div>
          ${stats}
          <div class="mt-4 flex justify-between items-center">
            <div class="text-xs text-gray-500">
              💡 Используйте кнопки 📥 и 📤 для экспорта/импорта истории
            </div>
            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm" data-action="close-modal">Закрыть</button>
          </div>
        </div>
      `;
      
      // Обработчик закрытия
      modal.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target === modal) {
          modal.remove();
        }
      });
      
      document.body.appendChild(modal);
    }
    
    // Функция для экспорта истории пользователя
    function exportUserHistory() {
      if (!state.user) return;
      
      const userHistory = JSON.parse(localStorage.getItem(`explainer_history_${state.user.id}`) || '{}');
      
      // Создаем JSON файл с историей
      const historyData = {
        user: {
          name: state.user.name,
          email: state.user.email,
          createdAt: state.user.createdAt
        },
        exportDate: new Date().toISOString(),
        history: userHistory
      };
      
      const blob = new Blob([JSON.stringify(historyData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `explainer-history-${state.user.name}-${new Date().toISOString().slice(0,10)}.json`;
      a.title = 'Скачать файл истории';
      a.click();
      URL.revokeObjectURL(url);
      
      toast('История экспортирована! Файл сохранен в папку "Загрузки". 💾 Теперь вы можете безопасно очистить историю или перенести данные на другой компьютер. 📁 Имя файла: ' + `explainer-history-${state.user.name}-${new Date().toISOString().slice(0,10)}.json` + ' 📊 Размер: ' + (blob.size / 1024).toFixed(1) + ' KB. 🔒 Файл содержит все ваши данные в зашифрованном виде. 💡 Рекомендуем сохранить файл в надежном месте. 🔄 Для восстановления используйте кнопку 📤. 🚀 Система готова к новым данным. 🎯 Теперь можно безопасно очистить историю! 🗑️ Используйте кнопку 🗑️ для очистки. 💡 Файл содержит полную резервную копию всех данных. 🎉 Резервное копирование завершено успешно!', 'success');
    }
    
    // Функция для импорта истории пользователя
    function importUserHistory() {
      if (!state.user) return;
      
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.title = 'Выберите файл истории (.json) для импорта';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedData = JSON.parse(e.target.result);
            
            // Проверяем структуру импортируемых данных
            if (!importedData.history || !importedData.user) {
              toast('Неверный формат файла истории', 'error');
              return;
            }
            
            // Проверяем, что это история того же пользователя
            if (importedData.user.email !== state.user.email) {
              toast('История принадлежит другому пользователю', 'error');
              return;
            }
            
            // Импортируем историю
            const userHistory = importedData.history;
            
            // Восстанавливаем сессии
            if (userHistory.sessions && userHistory.sessions.length > 0) {
              state.sessions = userHistory.sessions;
              state.activeSessionId = userHistory.sessions[0].id;
            }
            
            // Восстанавливаем документы
            if (userHistory.documents && userHistory.documents.length > 0) {
              state.docs = userHistory.documents;
            }
            
            // Восстанавливаем другие данные
            if (userHistory.translations && userHistory.translations.length > 0) {
              state.translateFile = userHistory.translations[0];
            }
            
            if (userHistory.comparisons) {
              state.compare = userHistory.comparisons;
            }
            
            if (userHistory.whatIfScenarios && userHistory.whatIfScenarios.length > 0) {
              state.whatIfFile = userHistory.whatIfScenarios[0];
            }
            
            // Обновляем UI
            renderSessions();
            renderChat();
            renderUploadedFiles();
            saveState();
            
            toast('История успешно импортирована! Теперь у вас есть доступ ко всем сохраненным данным. 🎉 Все сессии, документы и настройки восстановлены. 📊 Импортировано: ' + (userHistory.sessions?.length || 0) + ' сессий, ' + (userHistory.documents?.length || 0) + ' документов. 💾 Размер файла: ' + (file.size / 1024).toFixed(1) + ' KB. 🔓 Данные успешно расшифрованы и загружены. 💡 Теперь вы можете продолжить работу с восстановленными данными. 🔒 Все данные защищены и автоматически сохраняются. 🚀 Система готова к работе! 🎯 Перейдите в чат для продолжения работы. 💬 Или используйте другие инструменты в сайдбаре. 🔍 Все импортированные документы доступны для анализа. 🎊 Восстановление данных завершено!', 'success');
            
          } catch (error) {
            console.error('Ошибка импорта истории:', error);
            toast('Ошибка при импорте истории', 'error');
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }
    
    // Функция для показа приветственного сообщения
    function showWelcomeMessage(userName) {
      const welcomeModal = document.createElement('div');
      welcomeModal.className = 'fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4';
      welcomeModal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-md w-full text-center">
          <div class="text-6xl mb-4">🎉</div>
          <h3 class="text-xl font-semibold mb-2">Добро пожаловать в explAiner!</h3>
          <p class="text-gray-600 mb-4">Привет, <strong>${userName}</strong>! Теперь у вас есть доступ ко всем возможностям системы.</p>
          
          <div class="space-y-3 text-left text-sm">
            <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
              <span class="text-xl">💬</span>
              <div>
                <div class="font-medium">ИИ Чат</div>
                <div class="text-gray-500">Задавайте вопросы и получайте ответы</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
              <span class="text-xl">🔎</span>
              <div>
                <div class="font-medium">Комплаенс-чекер</div>
                <div class="text-gray-500">Проверяйте документы на соответствие</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-amber-50 rounded-lg">
              <span class="text-xl">⚖️</span>
              <div>
                <div class="font-medium">Сравнение документов</div>
                <div class="text-gray-500">Находите различия между версиями</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-cyan-50 rounded-lg">
              <span class="text-xl">🌐</span>
              <div>
                <div class="font-medium">Переводы</div>
                <div class="text-gray-500">Переводите документы на разные языки</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-purple-50 rounded-lg">
              <span class="text-xl">🧭</span>
              <div>
                <div class="font-medium">What-if симулятор</div>
                <div class="text-gray-500">Анализируйте возможные сценарии</div>
              </div>
            </div>
          </div>
          
          <div class="mt-6">
            <div class="text-xs text-gray-500 mb-3">
              💾 Ваша история автоматически сохраняется при каждом действии
            </div>
            <button class="px-6 py-3 bg-gradient-to-r from-brand-500 to-brand-600 text-white rounded-lg font-medium hover:from-brand-600 hover:to-brand-700 transition-all duration-300" data-action="close-welcome">
              Начать работу! 🚀
            </button>
          </div>
        </div>
      `;
      
      // Обработчик закрытия
      welcomeModal.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-welcome' || e.target === welcomeModal) {
          welcomeModal.remove();
        }
      });
      
      document.body.appendChild(welcomeModal);
    }

    // App/Landing toggle
    function showApp() { 
      $('#landing').classList.add('hidden'); 
      $('#app').classList.remove('hidden'); 
      // Показываем панель чата по умолчанию и обновляем кнопки
      togglePanel('panelChat');
      // Принудительно обновляем кнопки в сайдбаре
      setTimeout(() => updateSidebarButtons(), 50);
    }
    function showLanding() { 
      $('#app').classList.add('hidden'); 
      $('#landing').classList.remove('hidden'); 
    }

    // Экспорт чата
    function exportChat() {
      const s = getActive();
      if (!s || !s.messages.length) {
        toast('Нет сообщений для экспорта', 'error');
        return;
      }
      
      // Форматируем чат в простом текстовом формате
      let content = `${s.title}\n\n`;
      content += `Дата: ${new Date(s.createdAt).toLocaleString()}\n\n`;
      
      // Группируем сообщения по парам (вопрос-ответ)
      for (let i = 0; i < s.messages.length; i += 2) {
        const userMsg = s.messages[i];
        const aiMsg = s.messages[i+1];
        
        if (userMsg && userMsg.role === 'user') {
          content += `Вопрос: ${userMsg.content.trim()}\n\n`;
          
          if (aiMsg && aiMsg.role === 'assistant') {
            // Очищаем текст от markdown-разметки
            let aiResponse = aiMsg.content.trim();
            // Удаляем markdown заголовки
            aiResponse = aiResponse.replace(/#{1,6}\s+/g, '');
            // Удаляем markdown жирный текст и курсив
            aiResponse = aiResponse.replace(/\*\*/g, '').replace(/\*/g, '');
            // Удаляем markdown ссылки, оставляя текст
            aiResponse = aiResponse.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
            
            content += `Ответ: ${aiResponse}\n\n`;
          }
          
          content += `----------------------------------------\n\n`;
        }
      }
      
      // Создаем и скачиваем файл
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `explainer-chat-${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      toast('Чат экспортирован', 'success');
    }
    
    // Анализ документов
    async function analyzeDocument(doc, analysisType = 'general') {
      if (!doc || !doc.content) {
        toast('Документ не содержит текста для анализа', 'error');
        return;
      }
      
      // Показываем панель анализа
      togglePanel('panelDocAnalysis');
      $('#docAnalysisName').textContent = doc.name;
      $('#docAnalysisResult').innerHTML = '<div class="p-3 rounded bg-gray-50 text-center">Анализ документа...</div>';
      
      // Обновляем кнопки типов анализа
      $$('#panelDocAnalysis button').forEach(btn => {
        btn.classList.remove('bg-brand-500', 'text-white');
        btn.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-900');
      });
      $(`#analysis${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)}`).classList.add('bg-brand-500', 'text-white');
      $(`#analysis${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)}`).classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-900');
      
      try {
        // Отправляем запрос на сервер
        const res = await fetch(API.analyze, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            document_id: doc.id,
            document_text: doc.content,
            analysis_type: analysisType
          })
        });
        
        if (res.ok) {
          const data = await res.json();
          
          // Формируем результат
          let html = `<div class="p-4 border rounded-lg">
            <div class="font-medium mb-2">Краткое содержание</div>
            <p class="text-sm">${data.summary}</p>
            
            <div class="font-medium mt-4 mb-2">Ключевые моменты</div>
            <ul class="list-disc pl-5 text-sm">
              ${data.key_points.map(p => `<li>${p}</li>`).join('')}
            </ul>`;
          
          if (data.risks && data.risks.length > 0) {
            html += `
            <div class="font-medium mt-4 mb-2 text-red-600">Риски</div>
            <ul class="list-disc pl-5 text-sm">
              ${data.risks.map(r => `<li>${r}</li>`).join('')}
            </ul>`;
          }
          
          if (data.recommendations && data.recommendations.length > 0) {
            html += `
            <div class="font-medium mt-4 mb-2 text-green-600">Рекомендации</div>
            <ul class="list-disc pl-5 text-sm">
              ${data.recommendations.map(r => `<li>${r}</li>`).join('')}
            </ul>`;
          }
          
          html += '</div>';
          $('#docAnalysisResult').innerHTML = html;
        } else {
          throw new Error('Ошибка сервера');
        }
      } catch (e) {
        // Локальный фолбэк
        const html = `<div class="p-4 border rounded-lg">
          <div class="font-medium mb-2">Краткое содержание</div>
          <p class="text-sm">Документ содержит примерно ${doc.content.split(/\s+/).length} слов и относится к юридической документации.</p>
          
          <div class="font-medium mt-4 mb-2">Ключевые моменты</div>
          <ul class="list-disc pl-5 text-sm">
            <li>Определены основные стороны договора и их обязательства</li>
            <li>Указаны сроки исполнения и условия оплаты</li>
            <li>Присутствуют положения о конфиденциальности</li>
          </ul>
          
          <div class="font-medium mt-4 mb-2 text-gray-500">Примечание</div>
          <p class="text-sm text-gray-500">Это демонстрационный анализ. Для полного анализа используйте API с LLM.</p>
        </div>`;
        
        $('#docAnalysisResult').innerHTML = html;
        toast('Используется локальный анализ', 'info');
      }
    }
    
    // Events
    function bindEvents() {
      // Add null checks for all element references
      const langToggle = $('#langToggle');
      if (langToggle) {
        langToggle.onclick = () => {
        const newLang = state.settings.language === 'ru' ? 'en' : 'ru';
        updateLanguage(newLang);
        toast(newLang === 'ru' ? 'Русский язык' : 'English language', 'success');
      };
      }
      
      const themeToggle = $('#themeToggle');
      if (themeToggle) themeToggle.onclick = () => setTheme(document.body.dataset.theme === 'light' ? 'dark':'light');
      
      const loginBtn = $('#loginBtn');
      if (loginBtn) loginBtn.onclick = () => showLoginModal(true);
      
      const loginCancel = $('#loginCancel');
      if (loginCancel) loginCancel.onclick = () => showLoginModal(false);
      
      const loginSubmit = $('#loginSubmit');
      if (loginSubmit) loginSubmit.onclick = loginDemo;
      
      const logoutBtn = $('#logoutBtn');
      if (logoutBtn) logoutBtn.onclick = logoutDemo;
      
      const playDemo = $('#playDemo');
      if (playDemo) playDemo.onclick = () => { showDemoModal(); };
      
      const newChatBtn = $('#newChatBtn');
      if (newChatBtn) newChatBtn.onclick = () => newSession(t('new_session') + ' ' + (state.sessions.length+1));
      
      const sendBtn = $('#sendBtn');
      if (sendBtn) sendBtn.onclick = sendMessage;
      
      const stopBtn = $('#stopBtn');
      if (stopBtn) stopBtn.onclick = () => { toast('Остановлено'); };
      
      const chatInput = $('#chatInput');
      if (chatInput) chatInput.addEventListener('keydown', (e) => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
      
      const attachBtn = $('#attachBtn');
      if (attachBtn) attachBtn.onclick = () => $('#fileInput').click();
      
      const voiceBtn = $('#voiceBtn');
      if (voiceBtn) voiceBtn.onclick = toggleVoice;
      
      const exportChatBtn = $('#exportChat');
      if (exportChatBtn) exportChatBtn.onclick = exportChat;
      
      const encryptToggle = $('#encryptToggle');
      if (encryptToggle) encryptToggle.onchange = (e) => { state.settings.encryption = e.target.checked; saveState(); toast(state.settings.encryption?'Шифрование включено':'Шифрование выключено'); };
      bindDropzone();

      // toggles
      const toggleJargon = $('#toggleJargon');
      if (toggleJargon) toggleJargon.onchange = (e)=>{ state.settings.explainJargon = e.target.checked; saveState(); renderChat(); };
      
      const toggleFact = $('#toggleFact');
      if (toggleFact) toggleFact.onchange = (e)=>{ state.settings.factCheck = e.target.checked; saveState(); };
      
      const toggleLang = $('#toggleLang');
      if (toggleLang) toggleLang.onchange = (e)=>{ state.settings.multilingual = e.target.checked; saveState(); };

      // Tools panels
      const toolChat = $('#toolChat');
      if (toolChat) toolChat.onclick = ()=> togglePanel('panelChat');
      
      const toolCompliance = $('#toolCompliance');
      if (toolCompliance) toolCompliance.onclick = ()=> togglePanel('panelCompliance');
      
      const toolCompare = $('#toolCompare');
      if (toolCompare) toolCompare.onclick = ()=> togglePanel('panelCompare');
      
      const toolTranslate = $('#toolTranslate');
      if (toolTranslate) toolTranslate.onclick = ()=> togglePanel('panelTranslate');
      
      const toolWhatIf = $('#toolWhatIf');
      if (toolWhatIf) toolWhatIf.onclick = ()=> togglePanel('panelWhatIf');
      
      const toolSettings = $('#toolSettings');
      if (toolSettings) toolSettings.onclick = ()=> togglePanel('panelSettings');
      
      // Demo modal
      const demoClose = $('#demoClose');
      if (demoClose) demoClose.onclick = () => showDemoModal(false);
      
      const startDemo = $('#startDemo');
      if (startDemo) startDemo.onclick = () => { 
        showDemoModal(false); 
        setTimeout(() => showLoginModal(true), 100); // Показываем окно входа с небольшой задержкой
      };
      
      const watchVideoDemo = $('#watchVideoDemo');
      if (watchVideoDemo) watchVideoDemo.onclick = () => {
        // Открываем видео в новом окне или показываем встроенное видео
        const w = window.open('', '_blank');
        w.document.write(`
          <div style="font-family: system-ui; padding: 16px; max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 16px;">Демонстрация возможностей explAiner</h2>
            <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <p style="margin-top: 16px; color: #6b7280;">Видео демонстрирует основные возможности системы explAiner: ИИ чат, комплаенс-чекер, сравнение договоров и what-if симулятор.</p>
          </div>
        `);
        toast('Открыто демонстрационное видео', 'success');
      };
      
      // Logo button - clicking on explAiner logo returns to main page
      const logoBtn = $('#logoBtn');
      if (logoBtn) logoBtn.onclick = () => {
        // Возвращаемся на главную страницу
        showLanding();
        toast('Вернулись на главную страницу', 'info');
      };
      
      // Document analysis
      const analysisGeneral = $('#analysisGeneral');
      if (analysisGeneral) analysisGeneral.onclick = () => {
        const docAnalysisName = $('#docAnalysisName');
        if (docAnalysisName) {
          const doc = state.docs.find(d => d.name === docAnalysisName.textContent);
        if (doc) analyzeDocument(doc, 'general');
        }
      };
      
      const analysisLegal = $('#analysisLegal');
      if (analysisLegal) analysisLegal.onclick = () => {
        const docAnalysisName = $('#docAnalysisName');
        if (docAnalysisName) {
          const doc = state.docs.find(d => d.name === docAnalysisName.textContent);
        if (doc) analyzeDocument(doc, 'legal');
        }
      };
      
      const analysisRisks = $('#analysisRisks');
      if (analysisRisks) analysisRisks.onclick = () => {
        const docAnalysisName = $('#docAnalysisName');
        if (docAnalysisName) {
          const doc = state.docs.find(d => d.name === docAnalysisName.textContent);
        if (doc) analyzeDocument(doc, 'risks');
        }
      };
      
      const runCompliance = $('#runCompliance');
      if (runCompliance) runCompliance.onclick = runComplianceCheck;
      
      const fixCompliance = $('#fixCompliance');
      if (fixCompliance) fixCompliance.onclick = suggestComplianceFixes;
      
      const runCompareBtn = $('#runCompare');
      if (runCompareBtn) runCompareBtn.onclick = runCompare;
      
      const genFlowBtn = $('#genFlow');
      if (genFlowBtn) genFlowBtn.onclick = genFlow;

      // Document comparison upload handlers
      const uploadDocA = $('#uploadDocA');
      if (uploadDocA) uploadDocA.onclick = () => $('#fileInputA').click();
      
      const uploadDocB = $('#uploadDocB');
      if (uploadDocB) uploadDocB.onclick = () => $('#fileInputB').click();
      
      const fileInputA = $('#fileInputA');
      if (fileInputA) fileInputA.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleCompareFileUpload(e.target, 'docA');
        }
      });
      
      const fileInputB = $('#fileInputB');
      if (fileInputB) fileInputB.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleCompareFileUpload(e.target, 'docB');
        }
      });

      // settings
      if ($('#modelSelect')) $('#modelSelect').onchange = (e)=>{ 
        state.settings.model = e.target.value; 
        const modelLabel = $('#modelLabel');
        if (modelLabel) modelLabel.textContent = e.target.value;
        saveState(); 
      };
      if ($('#voiceSelect')) $('#voiceSelect').onchange = (e)=>{ state.settings.voice = e.target.value; saveState(); };
      if ($('#avatarSelect')) $('#avatarSelect').onchange = (e)=>{ state.settings.avatar = e.target.value; saveState(); };
      if ($('#ragSource')) $('#ragSource').onchange = (e)=>{ 
        state.settings.rag = e.target.value; 
        const ragStatus = $('#ragStatus');
        if (ragStatus) ragStatus.textContent = e.target.value;
        saveState(); 
      };

      // fill voices
      const populateVoices = () => {
        const sel = $('#voiceSelect'); 
        if (!sel) return;
        
      // Привязываем события аутентификации
      bindAuthEvents();
        
        const vs = speechSynthesis.getVoices();
        sel.innerHTML = '<option value="">Браузер (по умолчанию)</option>' + vs.map(v=>`<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
        if (!state.settings.voice) return;
        const has = vs.find(v => v.name===state.settings.voice); if (!has) state.settings.voice = '';
      };
      if ('speechSynthesis' in window) {
        speechSynthesis.onvoiceschanged = populateVoices;
        setTimeout(populateVoices, 300);
      }
      
      // Translation panel events
      const uploadTranslateBtn = $('#uploadTranslateBtn');
      const translateFileInput = $('#translateFileInput');
      if (uploadTranslateBtn && translateFileInput) {
        uploadTranslateBtn.onclick = () => translateFileInput.click();
        translateFileInput.onchange = handleTranslateFileUpload;
      }
      
      const removeTranslateFile = $('#removeTranslateFile');
      if (removeTranslateFile) {
        removeTranslateFile.onclick = () => {
          $('#translateFilePreview').classList.add('hidden');
          $('#startTranslation').disabled = true;
          translateFileInput.value = '';
        };
      }
      
      const startTranslation = $('#startTranslation');
      if (startTranslation) startTranslation.onclick = performTranslation;
      
      const downloadTranslated = $('#downloadTranslated');
      if (downloadTranslated) downloadTranslated.onclick = downloadTranslatedFile;
      
      const copyTranslated = $('#copyTranslated');
      if (copyTranslated) copyTranslated.onclick = copyTranslatedText;
      
      // What-if panel file upload
      const uploadWhatIfBtn = $('#uploadWhatIfBtn');
      const whatIfFileInput = $('#whatIfFileInput');
      if (uploadWhatIfBtn && whatIfFileInput) {
        uploadWhatIfBtn.onclick = () => whatIfFileInput.click();
        whatIfFileInput.onchange = handleWhatIfFileUpload;
      }
      
      const removeWhatIfFile = $('#removeWhatIfFile');
      if (removeWhatIfFile) {
        removeWhatIfFile.onclick = () => {
          $('#whatIfFilePreview').classList.add('hidden');
          whatIfFileInput.value = '';
        };
      }
    }

    function togglePanel(id) {
      // Скрываем все панели
      ['panelChat','panelCompliance','panelCompare','panelTranslate','panelWhatIf','panelSettings','panelDocAnalysis'].forEach(i => {
        const panel = document.getElementById(i);
        if (panel) {
          panel.classList.add('hidden');
        }
      });
      
      // Показываем нужную панель
      const targetPanel = document.getElementById(id);
      if (targetPanel) {
        targetPanel.classList.remove('hidden');
      }
      
      // Специальная инициализация для панели сравнения
      if (id === 'panelCompare') {
        // Инициализируем интерфейс сравнения документов
        initCompare();
      }
      
      // Обновляем активную кнопку в сайдбаре
      updateSidebarButtons();
      
      // Добавляем небольшую задержку для плавности анимации
      setTimeout(() => {
        updateSidebarButtons();
      }, 50);
    }
    
    function updateSidebarButtons() {
      const buttons = ['toolChat', 'toolCompliance', 'toolCompare', 'toolTranslate', 'toolWhatIf', 'toolSettings'];
      const panels = ['panelChat', 'panelCompliance', 'panelCompare', 'panelTranslate', 'panelWhatIf', 'panelSettings'];
      
      buttons.forEach((btnId, index) => {
        const btn = document.getElementById(btnId);
        const panel = document.getElementById(panels[index]);
        
        if (btn && panel) {
          // Удаляем все возможные классы состояний
          btn.classList.remove(
            // Активное состояние (синий градиент)
            'bg-gradient-to-r', 'from-brand-500', 'to-brand-600', 'text-white',
            // Неактивные состояния для разных инструментов
            'bg-gray-100', 'bg-gray-200', 'text-gray-700',
            'hover:from-gray-200', 'hover:to-gray-300',
            'hover:from-emerald-100', 'hover:to-emerald-200', 'hover:text-emerald-800',
            'hover:from-amber-100', 'hover:to-amber-200', 'hover:text-amber-800',
            'hover:from-cyan-100', 'hover:to-cyan-200', 'hover:text-cyan-800',
            'hover:from-purple-100', 'hover:to-purple-200', 'hover:text-purple-800',
            'hover:from-blue-100', 'hover:to-blue-200', 'hover:text-blue-800'
          );
          
          if (!panel.classList.contains('hidden')) {
            // Активная панель - синий градиент
            btn.classList.add('bg-gradient-to-r', 'from-brand-500', 'to-brand-600', 'text-white');
          } else {
            // Неактивная панель - возвращаем оригинальные цвета
            btn.classList.add('bg-gradient-to-r', 'from-gray-100', 'to-gray-200', 'text-gray-700');
            
            // Добавляем специфичные hover цвета для каждого инструмента
            switch (btnId) {
              case 'toolCompliance':
                btn.classList.add('hover:from-emerald-100', 'hover:to-emerald-200', 'hover:text-emerald-800');
                break;
              case 'toolCompare':
                btn.classList.add('hover:from-amber-100', 'hover:to-amber-200', 'hover:text-amber-800');
                break;
              case 'toolTranslate':
                btn.classList.add('hover:from-cyan-100', 'hover:to-cyan-200', 'hover:text-cyan-800');
                break;
              case 'toolWhatIf':
                btn.classList.add('hover:from-purple-100', 'hover:to-purple-200', 'hover:text-purple-800');
                break;
              case 'toolSettings':
                btn.classList.add('hover:from-blue-100', 'hover:to-blue-200', 'hover:text-blue-800');
                break;
              default:
                btn.classList.add('hover:from-gray-200', 'hover:to-gray-300');
                break;
            }
          }
        }
      });
    }

    // Новые event listeners для форм входа и регистрации
    function bindAuthEvents() {
      // Форма входа
      const loginForm = $('#loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', (e) => {
          e.preventDefault();
          loginDemo();
        });
      }

      // Форма регистрации
      const registerForm = $('#registerForm');
      if (registerForm) {
        registerForm.addEventListener('submit', (e) => {
          e.preventDefault();
          registerUser();
        });
      }

      // Переключение между формами
      const showRegister = $('#showRegister');
      if (showRegister) {
        showRegister.onclick = () => {
          $('#loginFormContainer').classList.add('hidden');
          $('#registerFormContainer').classList.remove('hidden');
          $('#registerFormContainer').classList.add('slide-in-right');
        };
      }

      const showLogin = $('#showLogin');
      if (showLogin) {
        showLogin.onclick = () => {
          $('#registerFormContainer').classList.add('hidden');
          $('#loginFormContainer').classList.remove('hidden');
          $('#loginFormContainer').classList.add('slide-in-left');
        };
      }

      // Закрытие модального окна
      const loginClose = $('#loginClose');
      if (loginClose) {
        loginClose.onclick = () => showLoginModal(false);
      }

      const registerClose = $('#registerClose');
      if (registerClose) {
        registerClose.onclick = () => showLoginModal(false);
      }
      
      // Кнопка очистки истории
      const clearHistoryBtn = $('#clearHistoryBtn');
      if (clearHistoryBtn) {
        clearHistoryBtn.onclick = () => {
          if (state.user) {
            clearUserHistory(state.user.id);
          }
        };
      }
      
      // Кнопка показа статистики
      const showStatsBtn = $('#showStatsBtn');
      if (showStatsBtn) {
        showStatsBtn.onclick = () => {
          if (state.user) {
            showUserStats();
          }
        };
      }
      
      // Кнопка экспорта истории
      const exportHistoryBtn = $('#exportHistoryBtn');
      if (exportHistoryBtn) {
        exportHistoryBtn.onclick = () => {
          if (state.user) {
            exportUserHistory();
          }
        };
      }
      
      // Кнопка импорта истории
      const importHistoryBtn = $('#importHistoryBtn');
      if (importHistoryBtn) {
        importHistoryBtn.onclick = () => {
          if (state.user) {
            importUserHistory();
          }
        };
      }
    }

    // Demo script
    async function demoScript() {
      const s = getActive() || newSession('Демо');
      const demoQs = [
        'Проверьте: соответствует ли это NDA требованиям GDPR?',
        'Сравните два договора SaaS: какой риск по SLA и ответственности?',
        'Что если я нарушу пункт о неконкуренции в течение 6 месяцев?'
      ];
      for (const q of demoQs) {
        $('#chatInput').value = q;
        await sendMessage();
        await sleep(600);
      }
      $('#whatIfInput').value = 'Что если я нарушу пункт о неконкуренции в течение 6 месяцев?';
      genFlow();
    }

    // Отображение загруженных файлов при загрузке страницы
    function renderUploadedFiles() {
      const container = $('#uploadedFiles');
      if (state.docs && state.docs.length > 0) {
        container.classList.remove('hidden');
        container.innerHTML = ''; // Очищаем контейнер
        
        // Добавляем каждый файл в контейнер
        state.docs.forEach(doc => {
          addFileToUploadedFiles(doc.id, doc.name, doc.size);
        });
      } else {
        container.classList.add('hidden');
      }
    }

    // Init
    function init() {
      // Проверяем и настраиваем marked для правильной обработки переносов строк
      if (window.marked && typeof window.marked.setOptions === 'function') {
        window.marked.setOptions({
          breaks: true, // Включаем обработку одиночных переносов строк
          gfm: true,    // GitHub Flavored Markdown
        });
      }
      
      loadState();
      setTheme(document.body.dataset.theme || 'light');
      bindEvents();
      
      // Проверяем авторизованного пользователя
      if (state.user) {
        // Пользователь уже авторизован
        updateUserInterface();
      if (!state.sessions.length) newSession(t('new_session'));
      updateLanguage(state.settings.language || 'ru');
      renderSessions();
      renderChat();
        renderUploadedFiles();
        showApp(); // Показываем приложение
      } else {
        // Пользователь не авторизован
        if (!state.sessions.length) newSession(t('new_session'));
        updateLanguage(state.settings.language || 'ru');
        renderSessions();
        renderChat();
        renderUploadedFiles();
        showLanding(); // Показываем лендинг
        
        // Проверяем, есть ли сохраненные пользователи
        const savedUsers = JSON.parse(localStorage.getItem('explainer_users') || '[]');
        if (savedUsers.length > 0) {
          console.log(`Найдено ${savedUsers.length} сохраненных пользователей`);
        }
      }
    }

    // Translation functions
    function handleTranslateFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('Загружается файл для перевода:', file.name, file.size, 'bytes');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        console.log('Содержимое файла для перевода загружено:', e.target.result.length, 'символов');
        
        // Показываем превью файла
        $('#translateFileName').textContent = file.name;
        $('#translateFileSize').textContent = formatFileSize(file.size);
        $('#translateFilePreview').classList.remove('hidden');
        $('#startTranslation').disabled = false;
        
        // Сохраняем содержимое файла
        state.translateFile = {
          name: file.name,
          size: file.size,
          content: e.target.result,
          type: file.type
        };
        
        toast(`Файл "${file.name}" загружен для перевода`, 'success');
      };
      
      reader.readAsText(file);
    }
    
    async function performTranslation() {
      if (!state.translateFile) {
        toast('Пожалуйста, загрузите файл для перевода', 'error');
        return;
      }
      
      const sourceLanguage = $('#sourceLanguage').value;
      const targetLanguage = $('#targetLanguage').value;
      const preserveFormatting = $('#preserveFormatting').checked;
      const legalTerms = $('#legalTerms').checked;
      
      console.log('Начинается перевод через Google Translate:', {
        source: sourceLanguage,
        target: targetLanguage,
        preserve: preserveFormatting,
        legal: legalTerms
      });
      
      // Показываем статус перевода
      $('#translationStatus').classList.remove('hidden');
      $('#translationResult').classList.add('hidden');
      $('#translationProgress').style.width = '10%';
      
      try {
        // Разбиваем текст на части для лучшего перевода
        const originalText = state.translateFile.content;
        const textChunks = splitTextForTranslation(originalText, preserveFormatting);
        
        $('#translationProgress').style.width = '20%';
        
        // Переводим каждую часть через Google Translate
        const translatedChunks = [];
        for (let i = 0; i < textChunks.length; i++) {
          const chunk = textChunks[i];
          if (chunk.trim()) {
            const translatedChunk = await translateWithGoogle(chunk, sourceLanguage, targetLanguage);
            translatedChunks.push(translatedChunk);
          } else {
            translatedChunks.push(chunk); // Сохраняем пустые строки
          }
          
          // Обновляем прогресс
          const progress = 20 + (i + 1) / textChunks.length * 70;
          $('#translationProgress').style.width = progress + '%';
        }
        
        $('#translationProgress').style.width = '95%';
        
        // Объединяем переведенные части
        const translatedText = translatedChunks.join('');
        
        // Постобработка для юридических терминов если включена опция
        const finalText = legalTerms ? 
          applyLegalTerminologyCorrections(translatedText, targetLanguage) : 
          translatedText;
        
        $('#translationProgress').style.width = '100%';
        
        // Показываем результат
        setTimeout(() => {
          completeTranslation(finalText);
        }, 300);
        
      } catch (error) {
        console.error('Ошибка перевода:', error);
        $('#translationStatus').classList.add('hidden');
        
        // Fallback на локальный перевод если Google Translate недоступен
        toast('Google Translate недоступен, используется локальный перевод', 'warning');
        setTimeout(() => {
          const fallbackTranslation = translateLocally(state.translateFile.content, sourceLanguage, targetLanguage, legalTerms);
          completeTranslation(fallbackTranslation);
        }, 500);
      }
    }
    
    // Функция для разбивки текста на части
    function splitTextForTranslation(text, preserveFormatting) {
      if (preserveFormatting) {
        // Разбиваем по строкам для сохранения форматирования
        return text.split('\n');
      } else {
        // Разбиваем по предложениям для лучшего перевода
        return text.split(/[.!?]+/).filter(chunk => chunk.trim().length > 0);
      }
    }
    
    // Основная функция перевода через Google Translate
    async function translateWithGoogle(text, sourceLang, targetLang) {
      // Пробуем несколько методов доступа к Google Translate
      
      // Метод 1: Прямой API (может блокироваться CORS)
      try {
        const url = 'https://translate.googleapis.com/translate_a/single';
        const params = new URLSearchParams({
          client: 'gtx',
          sl: sourceLang === 'auto' ? 'auto' : sourceLang,
          tl: targetLang,
          dt: 't',
          q: text
        });
        
        const response = await fetch(`${url}?${params}`, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Извлекаем переведенный текст из ответа Google Translate
        let translatedText = '';
        if (data && data[0]) {
          for (const item of data[0]) {
            if (item[0]) {
              translatedText += item[0];
            }
          }
        }
        
        return translatedText || text;
        
      } catch (error) {
        console.error('Прямой Google Translate API недоступен:', error);
        
        // Метод 2: Через CORS-прокси
        try {
          return await translateWithCORSProxy(text, sourceLang, targetLang);
        } catch (proxyError) {
          console.error('CORS-прокси недоступен:', proxyError);
          
          // Метод 3: Альтернативный сервис
          return await translateWithAlternativeService(text, sourceLang, targetLang);
        }
      }
    }
    
    // Перевод через CORS-прокси
    async function translateWithCORSProxy(text, sourceLang, targetLang) {
      const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
      const targetUrl = 'https://translate.googleapis.com/translate_a/single';
      const params = new URLSearchParams({
        client: 'gtx',
        sl: sourceLang === 'auto' ? 'auto' : sourceLang,
        tl: targetLang,
        dt: 't',
        q: text
      });
      
      const response = await fetch(`${proxyUrl}${targetUrl}?${params}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      if (!response.ok) {
        throw new Error(`CORS proxy error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      let translatedText = '';
      if (data && data[0]) {
        for (const item of data[0]) {
          if (item[0]) {
            translatedText += item[0];
          }
        }
      }
      
      return translatedText || text;
    }
    
    // Альтернативный сервис перевода (MyMemory API)
    async function translateWithAlternativeService(text, sourceLang, targetLang) {
      try {
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.responseStatus === 200 && data.responseData) {
          return data.responseData.translatedText;
        } else {
          throw new Error('MyMemory API error');
        }
      } catch (error) {
        console.error('Ошибка альтернативного API:', error);
        // Возвращаем исходный текст если все API недоступны
        return text;
      }
    }
    
    // Постобработка для улучшения юридической терминологии
    function applyLegalTerminologyCorrections(text, targetLang) {
      let corrected = text;
      
      if (targetLang === 'ru') {
        // Исправления для русского языка
        corrected = corrected
          .replace(/контракт/gi, 'договор')
          .replace(/клиент/gi, 'заказчик')
          .replace(/поставщик услуг/gi, 'исполнитель')
          .replace(/юридическое лицо/gi, 'юридическое лицо')
          .replace(/ответственность/gi, 'ответственность');
      } else if (targetLang === 'en') {
        // Исправления для английского языка
        corrected = corrected
          .replace(/agreement/gi, 'contract')
          .replace(/customer/gi, 'client')
          .replace(/provider/gi, 'contractor')
          .replace(/legal entity/gi, 'legal entity')
          .replace(/liability/gi, 'responsibility');
      }
      
      return corrected;
    }
    
    // Локальный fallback перевод (упрощенная версия предыдущих функций)
    function translateLocally(text, sourceLang, targetLang, legalTerms) {
      if (targetLang === 'en' && sourceLang !== 'en') {
        return translateToEnglish(text, legalTerms);
      } else if (targetLang === 'ru' && sourceLang !== 'ru') {
        return translateToRussian(text, legalTerms);
      } else {
        return text;
      }
    }
    
    function completeTranslation(translatedText) {
      // Сохраняем переведенный текст
      state.translatedContent = translatedText;
      
      // Скрываем статус и показываем результат
      $('#translationStatus').classList.add('hidden');
      $('#translationResult').classList.remove('hidden');
      $('#translatedContent').innerHTML = translatedText.replace(/\n/g, '<br>');
      
      // Сохраняем историю пользователя если он авторизован
      if (state.user) {
        saveUserHistory(state.user.id);
      }
      
      toast('Перевод завершен через Google Translate!', 'success');
    }
    
    // Функции перевода для разных языков
    function translateToEnglish(text, legalTerms) {
      // Симуляция перевода на английский с сохранением структуры
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line; // Пустые строки остаются пустыми
        
        // Базовые замены для симуляции перевода
        let translated = line
          .replace(/договор|контракт/gi, 'contract')
          .replace(/соглашение/gi, 'agreement')
          .replace(/сторон[аы]/gi, 'party/parties')
          .replace(/обязательств[ао]/gi, 'obligation')
          .replace(/услуг[аи]/gi, 'service')
          .replace(/работ[аы]/gi, 'work')
          .replace(/платеж/gi, 'payment')
          .replace(/срок/gi, 'term')
          .replace(/ответственность/gi, 'responsibility')
          .replace(/нарушение/gi, 'violation')
          .replace(/исполнение/gi, 'performance')
          .replace(/документ/gi, 'document')
          .replace(/пункт/gi, 'clause')
          .replace(/статья/gi, 'article')
          .replace(/раздел/gi, 'section')
          .replace(/приложение/gi, 'appendix')
          .replace(/подпись/gi, 'signature')
          .replace(/дата/gi, 'date')
          .replace(/место/gi, 'place')
          .replace(/компания/gi, 'company')
          .replace(/организация/gi, 'organization')
          .replace(/лицо/gi, 'person')
          .replace(/право/gi, 'right')
          .replace(/закон/gi, 'law')
          .replace(/требование/gi, 'requirement')
          .replace(/условие/gi, 'condition')
          .replace(/положение/gi, 'provision');
          
        if (legalTerms) {
          translated = translated
            .replace(/в соответствии с/gi, 'in accordance with')
            .replace(/настоящим договором/gi, 'this contract')
            .replace(/вступает в силу/gi, 'comes into effect')
            .replace(/прекращается/gi, 'terminates')
            .replace(/имеет право/gi, 'has the right')
            .replace(/обязуется/gi, 'undertakes')
            .replace(/несет ответственность/gi, 'bears responsibility');
        }
        
        return translated;
      });
      
      return translatedLines.join('\n');
    }
    
    function translateToRussian(text, legalTerms) {
      // Симуляция перевода на русский с сохранением структуры
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line; // Пустые строки остаются пустыми
        
        // Базовые замены для симуляции перевода
        let translated = line
          .replace(/contract/gi, 'договор')
          .replace(/agreement/gi, 'соглашение')
          .replace(/party|parties/gi, 'сторона/стороны')
          .replace(/obligation/gi, 'обязательство')
          .replace(/service/gi, 'услуга')
          .replace(/work/gi, 'работа')
          .replace(/payment/gi, 'платеж')
          .replace(/term/gi, 'срок')
          .replace(/responsibility/gi, 'ответственность')
          .replace(/violation/gi, 'нарушение')
          .replace(/performance/gi, 'исполнение')
          .replace(/document/gi, 'документ')
          .replace(/clause/gi, 'пункт')
          .replace(/article/gi, 'статья')
          .replace(/section/gi, 'раздел')
          .replace(/appendix/gi, 'приложение')
          .replace(/signature/gi, 'подпись')
          .replace(/date/gi, 'дата')
          .replace(/place/gi, 'место')
          .replace(/company/gi, 'компания')
          .replace(/organization/gi, 'организация')
          .replace(/person/gi, 'лицо')
          .replace(/right/gi, 'право')
          .replace(/law/gi, 'закон')
          .replace(/requirement/gi, 'требование')
          .replace(/condition/gi, 'условие')
          .replace(/provision/gi, 'положение');
          
        if (legalTerms) {
          translated = translated
            .replace(/in accordance with/gi, 'в соответствии с')
            .replace(/this contract/gi, 'настоящим договором')
            .replace(/comes into effect/gi, 'вступает в силу')
            .replace(/terminates/gi, 'прекращается')
            .replace(/has the right/gi, 'имеет право')
            .replace(/undertakes/gi, 'обязуется')
            .replace(/bears responsibility/gi, 'несет ответственность');
        }
        
        return translated;
      });
      
      return translatedLines.join('\n');
    }
    
    function translateToChinese(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        return `[中文翻译] ${line}`;
      });
      return translatedLines.join('\n');
    }
    
    function translateToSpanish(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        let translated = line
          .replace(/contract/gi, 'contrato')
          .replace(/agreement/gi, 'acuerdo')
          .replace(/document/gi, 'documento')
          .replace(/company/gi, 'empresa')
          .replace(/service/gi, 'servicio');
        return translated;
      });
      return translatedLines.join('\n');
    }
    
    function translateToFrench(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        let translated = line
          .replace(/contract/gi, 'contrat')
          .replace(/agreement/gi, 'accord')
          .replace(/document/gi, 'document')
          .replace(/company/gi, 'entreprise')
          .replace(/service/gi, 'service');
        return translated;
      });
      return translatedLines.join('\n');
    }
    
    function translateToGerman(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        let translated = line
          .replace(/contract/gi, 'Vertrag')
          .replace(/agreement/gi, 'Vereinbarung')
          .replace(/document/gi, 'Dokument')
          .replace(/company/gi, 'Unternehmen')
          .replace(/service/gi, 'Dienstleistung');
        return translated;
      });
      return translatedLines.join('\n');
    }
    
    function translateToJapanese(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        return `[日本語翻訳] ${line}`;
      });
      return translatedLines.join('\n');
    }
    
    function translateToKorean(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        return `[한국어 번역] ${line}`;
      });
      return translatedLines.join('\n');
    }
    
    function downloadTranslatedFile() {
      if (!state.translatedContent) {
        toast('Нет переведенного содержимого для скачивания', 'error');
        return;
      }
      
      const blob = new Blob([state.translatedContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'translated_' + (state.translateFile?.name || 'document.txt');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      toast('Переведенный файл скачан', 'success');
    }
    
    function copyTranslatedText() {
      if (!state.translatedContent) {
        toast('Нет переведенного содержимого для копирования', 'error');
        return;
      }
      
      navigator.clipboard.writeText(state.translatedContent).then(() => {
        toast('Переведенный текст скопирован в буфер обмена', 'success');
      }).catch(() => {
        toast('Ошибка при копировании текста', 'error');
      });
    }
    
    // What-if file upload functions
    function handleWhatIfFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('Загружается файл для What-if:', file.name, file.size, 'bytes');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        console.log('Содержимое файла для What-if загружено:', e.target.result.length, 'символов');
        
        // Показываем превью файла
        $('#whatIfFileName').textContent = file.name;
        $('#whatIfFileSize').textContent = formatFileSize(file.size);
        $('#whatIfFilePreview').classList.remove('hidden');
        
        // Сохраняем содержимое файла
        state.whatIfFile = {
          name: file.name,
          size: file.size,
          content: e.target.result,
          type: file.type
        };
        
        toast(`Документ "${file.name}" загружен для анализа сценариев`, 'success');
      };
      
      reader.readAsText(file);
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    window.addEventListener('load', init);

    // Add this new function after other functions
    function formatText(text) {
      let formatted = text || '';
      
      // Заменяем различные варианты переносов строк на реальные переносы
      formatted = formatted.replace(/\\n/g, '\n'); // Экранированные \n
      formatted = formatted.replace(/\n\n/g, '\n\n'); // Двойные переносы остаются как есть
      
      // Не применяем дополнительное форматирование здесь, так как marked.parse сделает это лучше
      return formatted;
    }
  </script>
</body>
</html>
</html>