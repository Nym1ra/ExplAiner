<!doctype html>
<html lang="ru" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>explAiner ‚Äî Legal AI Assistant</title>
  <meta name="description" content="explAiner ‚Äî Legal AI: —á–∞—Ç, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ–º–ø–ª–∞–µ–Ω—Å –∏ –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è. –ù–µ —è–≤–ª—è–µ—Ç—Å—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg width='120' height='120' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='120' height='120' rx='24' fill='%231a56db'/%3E%3Ctext x='50%' y='54%' text-anchor='middle' font-size='64' font-family='Arial' fill='white'%3Ee%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: ['class', '[data-theme="dark"]'],
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#eef5ff',
              100: '#d9e8ff',
              200: '#b7d2ff',
              300: '#86b3ff',
              400: '#4b86ff',
              500: '#1a56db',
              600: '#153fb0',
              700: '#133790',
              800: '#132f73',
              900: '#112758'
            }
          }
        }
      }
    }
  </script>
  <!-- Mermaid for flowcharts -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" onerror="window.mermaid = {initialize: function() {}, run: function() { return Promise.resolve(); }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.mermaid && typeof window.mermaid.initialize === 'function') {
        window.mermaid.initialize({ startOnLoad: false, theme: "neutral" });
      }
    });
  </script>
  <!-- Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" onerror="window.marked = {parse: function(text) { 
    let html = text || '';
    // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    html = html.replace(/\n\n/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π markdown
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    html = html.replace(/`(.*?)`/g, '<code>$1</code>');
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–∏—Å–∫–∏
    html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (!html.includes('<p>') && !html.includes('<ul>')) {
      html = '<p>' + html + '</p>';
    }
    return html;
  }}"></script>
  <!-- Syntax highlight -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css" onerror="this.remove()">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js" onerror="window.hljs = {highlightElement: function() {}}"></script>
  <!-- Diff for contract comparison -->
  <script>
    // Simple diff implementation fallback
    window.diff_match_patch = function() {
      this.diff_main = function(text1, text2) {
        // Simple word-based diff for fallback
        const words1 = text1.split(/\s+/);
        const words2 = text2.split(/\s+/);
        const result = [];
        
        let i = 0, j = 0;
        while (i < words1.length || j < words2.length) {
          if (i >= words1.length) {
            result.push([1, words2[j] + ' ']);
            j++;
          } else if (j >= words2.length) {
            result.push([-1, words1[i] + ' ']);
            i++;
          } else if (words1[i] === words2[j]) {
            result.push([0, words1[i] + ' ']);
            i++;
            j++;
          } else {
            result.push([-1, words1[i] + ' ']);
            result.push([1, words2[j] + ' ']);
            i++;
            j++;
          }
        }
        return result;
      };
      
      this.diff_cleanupSemantic = function(diffs) {
        // Simple cleanup - just return as is for fallback
        return diffs;
      };
    };
  </script>
  <!-- PDF.js (optional extract text from PDFs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>
  <style>
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { 
      background: linear-gradient(45deg, #6366f1, #8b5cf6); 
      border-radius: 9999px; 
      transition: all 0.3s ease;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { 
      background: linear-gradient(45deg, #4f46e5, #7c3aed); 
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏ */
    .typing-dot { 
      width: 6px; height: 6px; 
      border-radius: 9999px; 
      background: linear-gradient(45deg, #6366f1, #8b5cf6);
      display: inline-block; 
      margin-right: 4px; 
      animation: bounce 1.3s infinite; 
    }
    .typing-dot:nth-child(2) { animation-delay: .2s }
    .typing-dot:nth-child(3) { animation-delay: .4s }
    @keyframes bounce { 
      0%,80%,100%{transform:translateY(0);} 
      40%{transform:translateY(-4px);} 
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏—è */
    .prose p { margin: .5rem 0; }
    .prose code { 
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0); 
      padding: .12rem .34rem; 
      border-radius: .3rem; 
      border: 1px solid #e2e8f0;
    }
    
    /* –ö—Ä–∞—Å–∏–≤—ã–µ —Ç–µ–≥–∏ */
    .tag { 
      font-size: .7rem; 
      padding: .15rem .4rem; 
      border-radius: .375rem; 
      background: linear-gradient(135deg, #eef2ff, #ddd6fe); 
      color: #4338ca; 
      border: 1px solid #c7d2fe;
      animation: tagGlow 3s ease-in-out infinite;
    }
    
    @keyframes tagGlow {
      0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.3); }
      50% { box-shadow: 0 0 15px rgba(99, 102, 241, 0.6); }
    }
    
    /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    .btn { 
      display: inline-flex; 
      align-items: center; 
      gap: .5rem; 
      padding: .56rem .8rem; 
      border-radius: .6rem; 
      background: linear-gradient(135deg, #1f2937, #111827); 
      color: #fff; 
      font-weight: 600; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      position: relative;
      overflow: hidden;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-secondary { 
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb); 
      color: #111827; 
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #e5e7eb, #d1d5db);
    }
    
    /* –®—Ä–∏—Ñ—Ç—ã –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #fdf4ff 0%, #f0f9ff 25%, #f0fdfa 50%, #fefce8 75%, #fef7ed 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      transition: all 0.3s ease;
      min-height: 100vh;
      color: #1f2937;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 50% 0%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 50% 100%; }
      100% { background-position: 0% 50%; }
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è —ç–º–æ–¥–∑–∏ */
    .emoji-highlight { 
      display: inline-block; 
      margin: 0 2px; 
      animation: emojiPulse 2s infinite; 
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }
    
    @keyframes emojiPulse { 
      0% { transform: scale(1) rotate(0deg); } 
      25% { transform: scale(1.1) rotate(2deg); }
      50% { transform: scale(1.2) rotate(0deg); } 
      75% { transform: scale(1.1) rotate(-2deg); }
      100% { transform: scale(1) rotate(0deg); } 
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .card-animate {
      animation: fadeInUp 0.6s ease-out;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-animate:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–∞–π–¥–±–∞—Ä–∞ */
    .sidebar-item {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .sidebar-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 3px;
      background: linear-gradient(180deg, #6366f1, #8b5cf6);
      border-radius: 0 3px 3px 0;
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }
    
    .sidebar-item:hover::before,
    .sidebar-item.active::before {
      transform: scaleY(1);
    }
    
    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ —Ñ–æ–Ω—ã */
    .gradient-bg-1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-bg-2 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .gradient-bg-3 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .gradient-bg-4 {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ç–µ–Ω–∏ */
    .shadow-elegant {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                  0 4px 6px -2px rgba(0, 0, 0, 0.05),
                  0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    
    .shadow-elegant-hover:hover {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 
                  0 10px 10px -5px rgba(0, 0, 0, 0.04),
                  0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    
    /* –ó–∞–¥–µ—Ä–∂–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ */
    .animation-delay-2000 {
      animation-delay: 2s;
    }
    
    .animation-delay-4000 {
      animation-delay: 4s;
    }
    
    /* –ü–ª–∞–≤–∞—é—â–∏–µ —á–∞—Å—Ç–∏—Ü—ã */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    
    .float-animation {
      animation: float 3s ease-in-out infinite;
    }
    
    /* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è */
    .glow-effect {
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
      to { box-shadow: 0 0 30px rgba(99, 102, 241, 0.6); }
    }
    :root [data-theme="dark"] {
      --bg: #111827;
      --text: #f9fafb;
      --accent: #6366f1;
      --secondary: #1f2937;
      --border: #374151;
    }

    [data-theme="dark"] {
      background-color: var(--bg);
      color: var(--text);
    }

    [data-theme="dark"] .bg-white { background-color: var(--secondary); }
    [data-theme="dark"] .bg-gray-50 { background-color: #374151; }
    [data-theme="dark"] .bg-gray-100 { background-color: #4b5563; }
    [data-theme="dark"] .bg-gray-200 { background-color: #6b7280; }
    [data-theme="dark"] .bg-blue-50 { background-color: rgba(59, 130, 246, 0.2); }
    [data-theme="dark"] .bg-green-50 { background-color: rgba(34, 197, 94, 0.2); }
    [data-theme="dark"] .bg-yellow-50 { background-color: rgba(234, 179, 8, 0.2); }
    [data-theme="dark"] .bg-purple-50 { background-color: rgba(147, 51, 234, 0.2); }
    [data-theme="dark"] .bg-red-50 { background-color: rgba(239, 68, 68, 0.2); }
    [data-theme="dark"] .bg-brand-50 { background-color: rgba(26, 86, 219, 0.2); }
    
    [data-theme="dark"] .text-gray-900 { color: var(--text); }
    [data-theme="dark"] .text-gray-800 { color: var(--text); }
    [data-theme="dark"] .text-gray-700 { color: #d1d5db; }
    [data-theme="dark"] .text-gray-600 { color: #d1d5db; }
    [data-theme="dark"] .text-gray-500 { color: #9ca3af; }
    [data-theme="dark"] .text-gray-400 { color: #9ca3af; }
    [data-theme="dark"] .text-gray-300 { color: #d1d5db; }
    
    [data-theme="dark"] .bg-indigo-50\/60 { background-color: rgba(67,56,202,0.3); }
    [data-theme="dark"] .border-gray-200 { border-color: var(--border); }
    [data-theme="dark"] .border-gray-300 { border-color: #6b7280; }
    [data-theme="dark"] .border { border-color: var(--border); }
    
    [data-theme="dark"] .btn { background: #f3f4f6; color: #111827; }
    [data-theme="dark"] .btn-secondary { background: #4b5563; color: #f3f4f6; }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    [data-theme="dark"] .bg-white { background-color: #1f2937 !important; }
    [data-theme="dark"] .border { border-color: #374151 !important; }
    [data-theme="dark"] .text-gray-900 { color: #f9fafb !important; }
    [data-theme="dark"] .text-gray-800 { color: #f9fafb !important; }
    [data-theme="dark"] .text-gray-700 { color: #d1d5db !important; }
    [data-theme="dark"] .text-gray-600 { color: #9ca3af !important; }
    [data-theme="dark"] .text-gray-500 { color: #9ca3af !important; }
    [data-theme="dark"] .text-gray-400 { color: #9ca3af !important; }
    [data-theme="dark"] .text-gray-300 { color: #d1d5db !important; }
    [data-theme="dark"] .text-gray-200 { color: #e5e7eb !important; }
    [data-theme="dark"] .text-gray-100 { color: #f3f4f6 !important; }
    
    [data-theme="dark"] .bg-gray-50 { background-color: #374151 !important; }
    [data-theme="dark"] .bg-gray-100 { background-color: #4b5563 !important; }
    [data-theme="dark"] .bg-gray-200 { background-color: #6b7280 !important; }
    [data-theme="dark"] .bg-gray-300 { background-color: #9ca3af !important; }
    [data-theme="dark"] .bg-gray-400 { background-color: #d1d5db !important; }
    [data-theme="dark"] .bg-gray-500 { background-color: #6b7280 !important; }
    [data-theme="dark"] .bg-gray-600 { background-color: #4b5563 !important; }
    [data-theme="dark"] .bg-gray-700 { background-color: #374151 !important; }
    [data-theme="dark"] .bg-gray-800 { background-color: #1f2937 !important; }
    [data-theme="dark"] .bg-gray-900 { background-color: #111827 !important; }
    
    [data-theme="dark"] .border-gray-200 { border-color: #374151 !important; }
    [data-theme="dark"] .border-gray-300 { border-color: #4b5563 !important; }
    [data-theme="dark"] .border-gray-400 { border-color: #6b7280 !important; }
    [data-theme="dark"] .border-gray-500 { border-color: #6b7280 !important; }
    
    [data-theme="dark"] .hover\:bg-gray-50:hover { background-color: #4b5563 !important; }
    [data-theme="dark"] .hover\:bg-gray-100:hover { background-color: #6b7280 !important; }
    [data-theme="dark"] .hover\:bg-gray-200:hover { background-color: #9ca3af !important; }
    [data-theme="dark"] .hover\:text-gray-700:hover { color: #d1d5db !important; }
    [data-theme="dark"] .hover\:text-gray-900:hover { color: #f9fafb !important; }
    

    
    [data-theme="dark"] .prose code { background: #374151; }
    [data-theme="dark"] .tag { background: rgba(67,56,202,0.2); color: #a5b4fc; }
    
    [data-theme="dark"] input, [data-theme="dark"] textarea, [data-theme="dark"] select {
      background-color: #374151;
      border-color: #4b5563;
      color: var(--text);
    }
    
    [data-theme="dark"] input:focus, [data-theme="dark"] textarea:focus, [data-theme="dark"] select:focus {
      border-color: #6366f1;
      outline-color: #6366f1;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] #loginModal .bg-white,
    [data-theme="dark"] #demoModal .bg-white {
      background-color: #1f2937 !important;
      color: #f9fafb !important;
    }
    
    [data-theme="dark"] #loginModal .text-gray-500,
    [data-theme="dark"] #demoModal .text-gray-500 {
      color: #9ca3af !important;
    }
    
    [data-theme="dark"] #loginModal .text-gray-600,
    [data-theme="dark"] #demoModal .text-gray-600 {
      color: #d1d5db !important;
    }
    
    [data-theme="dark"] #loginModal .border,
    [data-theme="dark"] #demoModal .border {
      border-color: #374151 !important;
    }
    
    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ –¥–ª—è –¥–µ–º–æ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    [data-theme="dark"] #demoModal .bg-gradient-to-r {
      background: #374151 !important;
    }
    
    [data-theme="dark"] #demoModal .border-blue-200,
    [data-theme="dark"] #demoModal .border-green-200,
    [data-theme="dark"] #demoModal .border-yellow-200,
    [data-theme="dark"] #demoModal .border-purple-200 {
      border-color: #4b5563 !important;
    }
    
    /* üåô –û–°–ù–û–í–ù–´–ï –°–í–ï–¢–õ–´–ï –°–¢–ò–õ–ò (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
    
    /* üåô –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) */
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω —Å –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º */
    [data-theme="dark"] body {
      background: linear-gradient(135deg, #0c0a1a 0%, #1a0f2e 25%, #2d1b3d 50%, #1e293b 75%, #0f172a 100%) !important;
      background-size: 400% 400%;
      animation: darkGradientShift 20s ease infinite;
    }
    
    @keyframes darkGradientShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 50% 0%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 50% 100%; }
      100% { background-position: 0% 50%; }
    }
    
    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] header {
      background: rgba(15, 23, 42, 0.9) !important;
      backdrop-filter: blur(20px);
      border-color: rgba(99, 102, 241, 0.2) !important;
      box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1), 
                  0 2px 4px -1px rgba(99, 102, 241, 0.06);
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º */
    [data-theme="dark"] .bg-white\/90,
    [data-theme="dark"] .bg-white\/80,
    [data-theme="dark"] .bg-white {
      background: rgba(15, 23, 42, 0.8) !important;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(99, 102, 241, 0.2) !important;
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    /* –¢–µ–∫—Å—Ç –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] .text-gray-900,
    [data-theme="dark"] .text-gray-800,
    [data-theme="dark"] .text-gray-700 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .text-gray-600 {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .text-gray-500 {
      color: #94a3b8 !important;
    }
    
    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] .bg-gradient-to-r.from-gray-100 {
      background: linear-gradient(135deg, rgba(51, 65, 85, 0.8), rgba(71, 85, 105, 0.8)) !important;
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .hover\:from-gray-200:hover {
      background: linear-gradient(135deg, rgba(71, 85, 105, 0.9), rgba(99, 102, 241, 0.3)) !important;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }
    
    /* –°–∞–π–¥–±–∞—Ä –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] .sidebar-item:not(.bg-gradient-to-r.from-brand-500) {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.8)) !important;
      border: 1px solid rgba(99, 102, 241, 0.2);
      color: #e2e8f0 !important;
      backdrop-filter: blur(10px);
    }
    
    [data-theme="dark"] .sidebar-item:not(.bg-gradient-to-r.from-brand-500):hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)) !important;
      color: #f8fafc !important;
      box-shadow: 0 0 25px rgba(99, 102, 241, 0.4);
      transform: translateY(-2px);
    }
    
    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    [data-theme="dark"] .gradient-bg-1 {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.8)) !important;
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
    }
    
    [data-theme="dark"] .gradient-bg-2 {
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.8), rgba(239, 68, 68, 0.8)) !important;
      box-shadow: 0 0 30px rgba(236, 72, 153, 0.3);
    }
    
    [data-theme="dark"] .gradient-bg-3 {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.8), rgba(34, 197, 94, 0.8)) !important;
      box-shadow: 0 0 30px rgba(6, 182, 212, 0.3);
    }
    
    [data-theme="dark"] .gradient-bg-4 {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.8), rgba(163, 230, 53, 0.8)) !important;
      box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
    }
    
    /* –ü–ª–∞–≤–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Ñ–æ–Ω–µ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] .bg-purple-300 {
      background: rgba(139, 92, 246, 0.3) !important;
    }
    
    [data-theme="dark"] .bg-yellow-300 {
      background: rgba(251, 191, 36, 0.3) !important;
    }
    
    [data-theme="dark"] .bg-pink-300 {
      background: rgba(236, 72, 153, 0.3) !important;
    }
    
    /* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] .scrollbar-thin::-webkit-scrollbar-thumb {
      background: linear-gradient(45deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.8)) !important;
    }
    
    [data-theme="dark"] .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(45deg, rgba(79, 70, 229, 0.9), rgba(124, 58, 237, 0.9)) !important;
    }
    
    /* –¢–µ–≥–∏ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] .tag {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)) !important;
      color: #a5b4fc !important;
      border: 1px solid rgba(99, 102, 241, 0.4) !important;
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.2);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–≤–µ—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    [data-theme="dark"] .glow-effect {
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ç–µ–Ω–∏ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] .shadow-elegant {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 
                  0 4px 6px -2px rgba(0, 0, 0, 0.2),
                  0 0 0 1px rgba(99, 102, 241, 0.2),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="dark"] .shadow-elegant:hover {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 
                  0 10px 10px -5px rgba(0, 0, 0, 0.3),
                  0 0 0 1px rgba(99, 102, 241, 0.4),
                  0 0 30px rgba(99, 102, 241, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    
    /* –ß–∞—Ç –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] #chatMessages {
      background: rgba(15, 23, 42, 0.6) !important;
      border: 1px solid rgba(99, 102, 241, 0.2);
      backdrop-filter: blur(15px);
    }
    
    /* –°–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ */
    [data-theme="dark"] .message {
      background: rgba(30, 41, 59, 0.8) !important;
      border: 1px solid rgba(99, 102, 241, 0.1);
      backdrop-filter: blur(10px);
    }
    
    [data-theme="dark"] .message.user {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3)) !important;
      border: 1px solid rgba(99, 102, 241, 0.4);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
    }
    
    /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] input,
    [data-theme="dark"] textarea,
    [data-theme="dark"] select {
      background: rgba(30, 41, 59, 0.8) !important;
      border: 1px solid rgba(99, 102, 241, 0.3) !important;
      color: #e2e8f0 !important;
      backdrop-filter: blur(10px);
    }
    
    [data-theme="dark"] input:focus,
    [data-theme="dark"] textarea:focus,
    [data-theme="dark"] select:focus {
      border-color: rgba(99, 102, 241, 0.6) !important;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 
                  0 0 20px rgba(99, 102, 241, 0.3) !important;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] .file-chip {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.8)) !important;
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: #e2e8f0 !important;
      backdrop-filter: blur(10px);
    }
    
    [data-theme="dark"] .file-chip:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)) !important;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    [data-theme="dark"] .modal-overlay {
      background: rgba(0, 0, 0, 0.8) !important;
      backdrop-filter: blur(5px);
    }
    
    /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
    [data-theme="dark"] .animate-pulse {
      animation: darkPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes darkPulse {
      0%, 100% { 
        opacity: 1;
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
      }
      50% { 
        opacity: 0.7;
        box-shadow: 0 0 25px rgba(139, 92, 246, 0.7);
      }
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã */
    [data-theme="dark"] .border {
      border-color: rgba(99, 102, 241, 0.2) !important;
    }
    
    [data-theme="dark"] .border-gray-200,
    [data-theme="dark"] .border-gray-300 {
      border-color: rgba(99, 102, 241, 0.3) !important;
    }
    
    /* –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
    [data-theme="dark"] .loading-spinner {
      border-color: rgba(51, 65, 85, 0.3);
      border-top-color: #6366f1;
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
    }
    
    /* –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
    [data-theme="dark"] .btn:not(.btn-secondary) {
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="dark"] .btn:not(.btn-secondary):hover {
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6),
                  inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ */
    .auth-form {
      transition: all 0.3s ease;
    }
    
    .auth-form.hidden {
      opacity: 0;
      transform: translateX(20px);
    }
    
    .auth-form:not(.hidden) {
      opacity: 1;
      transform: translateX(0);
    }
    
    .user-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    
    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º */
    @keyframes slideInFromRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .slide-in-right {
      animation: slideInFromRight 0.3s ease-out;
    }
    
    .slide-in-left {
      animation: slideInFromLeft 0.3s ease-out;
    }
  </style>
</head>
<body class="h-full text-gray-900">
  <!-- Navbar -->
  <header class="sticky top-0 z-40 border-b bg-white/90 backdrop-blur-xl shadow-elegant">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="logoBtn" class="flex items-center gap-3 hover:opacity-80 transition-all duration-300 hover:transform hover:scale-105">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 flex items-center justify-center text-white font-bold shadow-lg hover:shadow-xl transition-all duration-300">
            <span class="animate-pulse">e</span>
          </div>
          <div class="card-animate">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-lg bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">explAiner</span>
              <span class="tag">Legal AI</span>
              <span class="tag bg-gradient-to-r from-green-50 to-emerald-50 text-green-700 border-green-200">beta</span>
            </div>
            <p class="text-xs text-gray-500 hover:text-gray-700 transition-colors">–Ø–≤–ª—è–µ—Ç—Å—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π</p>
          </div>
        </button>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#features" class="text-gray-600 hover:text-brand-600 transition-all duration-300 hover:transform hover:scale-105 relative group">
          –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
          <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gradient-to-r from-brand-500 to-brand-600 group-hover:w-full transition-all duration-300"></span>
        </a>
        <a href="#security" class="text-gray-600 hover:text-brand-600 transition-all duration-300 hover:transform hover:scale-105 relative group">
          –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
          <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gradient-to-r from-brand-500 to-brand-600 group-hover:w-full transition-all duration-300"></span>
        </a>
        <a href="#app" class="text-gray-600 hover:text-brand-600 transition-all duration-300 hover:transform hover:scale-105 relative group">
          –î–∞—à–±–æ—Ä–¥
          <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gradient-to-r from-brand-500 to-brand-600 group-hover:w-full transition-all duration-300"></span>
        </a>
        <a href="#" class="text-gray-300 cursor-not-allowed opacity-50">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a>
      </nav>
      <div class="flex items-center gap-2">
        <button id="langToggle" class="px-3 py-2 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-sm transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md">
          üåç RU/EN
        </button>
        <button id="loginBtn" class="px-4 py-2 rounded-lg bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white text-sm transition-all duration-300 hover:transform hover:scale-105 shadow-lg hover:shadow-xl">
          ‚ú® –í–æ–π—Ç–∏
        </button>
        <div id="userMenu" class="hidden items-center gap-3">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-brand-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold">
              <span id="userInitial"></span>
            </div>
            <div class="text-right">
              <div id="userEmail" class="text-sm text-gray-600 font-medium"></div>
              <div class="text-xs text-gray-500">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="showStatsBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 hover:from-blue-200 hover:to-blue-300 text-blue-700 text-sm transition-all duration-300 hover:transform hover:scale-105" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É">
              üìä
            </button>
            <button id="exportHistoryBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-green-100 to-green-200 hover:from-green-200 hover:to-green-300 text-green-700 text-sm transition-all duration-300 hover:transform hover:scale-105" title="–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏">
              üì•
            </button>
            <button id="importHistoryBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-indigo-100 to-indigo-200 hover:from-indigo-200 hover:to-indigo-300 text-indigo-700 text-sm transition-all duration-300 hover:transform hover:scale-105" title="–ò–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏">
              üì§
            </button>
            <button id="clearHistoryBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-yellow-100 to-yellow-200 hover:from-yellow-200 hover:to-yellow-300 text-yellow-700 text-sm transition-all duration-300 hover:transform hover:scale-105" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é">
              üóëÔ∏è
            </button>
            <button id="logoutBtn" class="px-3 py-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 hover:from-red-200 hover:to-red-300 text-red-700 text-sm transition-all duration-300 hover:transform hover:scale-105">
              üëã –í—ã–π—Ç–∏
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Landing -->
  <main id="landing" class="relative overflow-hidden">
    <!-- –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ–Ω–∞ -->
    <div class="absolute inset-0 -z-10">
      <div class="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse"></div>
      <div class="absolute top-0 -right-4 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse animation-delay-2000"></div>
      <div class="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse animation-delay-4000"></div>
    </div>
    
    <section class="mx-auto max-w-7xl px-4 py-16">
      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div class="card-animate">
          <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight leading-tight">
            <span class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 bg-clip-text text-transparent">
              ExplAiner, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–Ω—è—Ç–Ω–æ.
            </span>
            <br>
            <span class="bg-gradient-to-r from-brand-600 via-purple-600 to-brand-700 bg-clip-text text-transparent animate-pulse">
              explAiner
            </span>
            <span class="bg-gradient-to-r from-gray-700 to-gray-900 bg-clip-text text-transparent">
              –æ–±—ä—è—Å–Ω—è–µ—Ç, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç.
            </span>
          </h1>
          <p class="mt-6 text-gray-600 text-lg leading-relaxed">
            –ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –¥–æ–≥–æ–≤–æ—Ä—ã, –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã, –ø–æ–ª—É—á–∞–π—Ç–µ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è –≤ —á–∞—Ç–µ, –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ. 
            –ü–æ–¥–¥–µ—Ä–∂–∫–∞ RAG, –∫–æ–º–ø–ª–∞–µ–Ω—Å‚Äë—á–µ–∫–µ—Ä–∞, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∏ what‚Äëif —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –¥–∏–∞–≥—Ä–∞–º–º–∞–º–∏.
          </p>
          <div class="mt-8 flex gap-4">
            <button class="btn shadow-elegant hover:shadow-xl" onclick="showLoginModal(true)">
              üöÄ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
            </button>
            <button id="playDemo" class="btn btn-secondary shadow-elegant hover:shadow-xl">
              ‚ñ∂Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å –¥–µ–º–æ
            </button>
          </div>
          <div class="mt-6 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg">
            <div class="flex items-center gap-2">
              <span class="text-amber-600">‚ö†Ô∏è</span>
              <span class="text-sm text-amber-800 font-medium">–î–∏—Å–∫–ª–µ–π–º–µ—Ä</span>
          </div>
            <p class="text-xs text-amber-700 mt-1">
              –°–µ—Ä–≤–∏—Å –Ω–æ—Å–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π.
            </p>
        </div>
          </div>
        <div class="bg-white/80 backdrop-blur-sm border rounded-2xl p-6 shadow-elegant hover:shadow-xl transition-all duration-500 card-animate">
          <div class="text-sm text-gray-600 mb-4 font-medium flex items-center gap-2">
            <span class="w-2 h-2 bg-gradient-to-r from-green-400 to-green-500 rounded-full animate-pulse"></span>
            –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å explAiner
          </div>
          <div class="rounded-xl overflow-hidden border shadow-lg">
            <div class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 h-64 flex items-center justify-center relative overflow-hidden">
              <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ -->
              <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
              <div class="text-center text-white z-10">
                <div class="text-4xl mb-4 animate-bounce">üí¨</div>
                <div class="text-lg font-semibold mb-2">–ò–ò –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
                <div class="text-sm opacity-90">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
              </div>
              <!-- –ü–ª–∞–≤–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
              <div class="absolute top-4 left-4 w-3 h-3 bg-white/30 rounded-full animate-ping"></div>
              <div class="absolute bottom-4 right-4 w-2 h-2 bg-white/40 rounded-full animate-pulse"></div>
              <div class="absolute top-1/2 left-8 w-1 h-1 bg-white/50 rounded-full animate-bounce"></div>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-3 gap-3 text-xs">
            <div class="p-3 rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 hover:from-blue-100 hover:to-indigo-100 transition-all duration-300 cursor-pointer group">
              <div class="text-blue-600 group-hover:scale-110 transition-transform duration-300">üìö</div>
              <div class="mt-1 text-blue-800 font-medium">RAG –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
            </div>
            <div class="p-3 rounded-lg bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-100 hover:from-purple-100 hover:to-pink-100 transition-all duration-300 cursor-pointer group">
              <div class="text-purple-600 group-hover:scale-110 transition-transform duration-300">üé¨</div>
              <div class="mt-1 text-purple-800 font-medium">–ê—É–¥–∏–æ/–í–∏–¥–µ–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è</div>
            </div>
            <div class="p-3 rounded-lg bg-gradient-to-br from-green-50 to-emerald-50 border border-green-100 hover:from-green-100 hover:to-emerald-100 transition-all duration-300 cursor-pointer group">
              <div class="text-green-600 group-hover:scale-110 transition-transform duration-300">üìä</div>
              <div class="mt-1 text-green-800 font-medium">What‚Äëif –¥–∏–∞–≥—Ä–∞–º–º—ã</div>
            </div>
          </div>
        </div>
      </div>

      <section id="features" class="mt-20">
        <div class="text-center mb-12 card-animate">
          <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent mb-4">
            –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ explAiner
          </h2>
          <p class="text-gray-600 max-w-2xl mx-auto">
            –ú–æ—â–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö –ò–ò
          </p>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate gradient-bg-1 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">üí¨</div>
            <h3 class="font-semibold mb-3 text-lg">–ß–∞—Ç + –ñ–∞—Ä–≥–æ–Ω‚Äë–æ–±—ä—è—Å–Ω–∏—Ç–µ–ª—å</h3>
            <p class="text-sm opacity-90">–ê–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              –£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate gradient-bg-2 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">üìÑ</div>
            <h3 class="font-semibold mb-3 text-lg">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h3>
            <p class="text-sm opacity-90">PDF/DOC/TXT —Ñ–∞–π–ª—ã —Å RAG-–∞–Ω–∞–ª–∏–∑–æ–º –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Å–º—ã—Å–ª–∞</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              OCR –ø–æ–¥–¥–µ—Ä–∂–∫–∞
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate gradient-bg-3 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">üîç</div>
            <h3 class="font-semibold mb-3 text-lg">–ö–æ–º–ø–ª–∞–µ–Ω—Å‚Äë—á–µ–∫–µ—Ä</h3>
            <p class="text-sm opacity-90">GDPR/CCPA –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate gradient-bg-4 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">‚öñÔ∏è</div>
            <h3 class="font-semibold mb-3 text-lg">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–æ–≤</h3>
            <p class="text-sm opacity-90">–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–∏–π –∏ –∞–Ω–∞–ª–∏–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              –í–∏–∑—É–∞–ª—å–Ω—ã–π diff
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate bg-gradient-to-br from-indigo-600 to-purple-700 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">üéß</div>
            <h3 class="font-semibold mb-3 text-lg">–ê—É–¥–∏–æ/–í–∏–¥–µ–æ</h3>
            <p class="text-sm opacity-90">–û–∑–≤—É—á–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∞–≤–∞—Ç–∞—Ä</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              TTS —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏
            </div>
          </div>
          <div class="p-6 border rounded-xl shadow-elegant hover:shadow-xl transition-all duration-500 hover:transform hover:scale-105 card-animate bg-gradient-to-br from-pink-600 to-red-700 text-white group">
            <div class="text-3xl mb-4 group-hover:animate-bounce">üéØ</div>
            <h3 class="font-semibold mb-3 text-lg">What‚Äëif —Å–∏–º—É–ª—è—Ç–æ—Ä</h3>
            <p class="text-sm opacity-90">Mermaid-–¥–∏–∞–≥—Ä–∞–º–º—ã —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</p>
            <div class="mt-4 flex items-center text-xs opacity-75">
              <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
              –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ö–µ–º—ã
            </div>
          </div>
        </div>
      </section>

      <section id="security" class="mt-16">
        <h2 class="text-2xl font-bold mb-4">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h2>
        <ul class="list-disc pl-6 text-gray-600">
          <li>–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, AES‚ÄëGCM demo).</li>
          <li>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å: —Ç–æ–ª—å–∫–æ –≤—ã –≤–∏–¥–∏—Ç–µ —Å–≤–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∏—Å—Ç–æ—Ä–∏—é (–ª–æ–∫–∞–ª—å–Ω–æ; —Å–µ—Ä–≤–µ—Ä ‚Äî –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ Supabase).</li>
          <li>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ Google Scholar.</li>
        </ul>
      </section>
    </section>
  </main>

  <!-- App -->
  <section id="app" class="hidden">
    <div class="mx-auto max-w-7xl px-4 py-6 grid grid-cols-12 gap-4">
      <!-- Sidebar -->
      <aside class="col-span-12 md:col-span-3 space-y-4 card-animate">
        <div class="border rounded-xl bg-white/90 backdrop-blur-sm p-4 shadow-elegant hover:shadow-xl transition-all duration-300">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-800 flex items-center gap-2">
              <span class="w-2 h-2 bg-gradient-to-r from-green-400 to-green-500 rounded-full animate-pulse"></span>
              –°–µ—Å—Å–∏–∏
            </h3>
            <button id="newChatBtn" class="text-sm px-3 py-2 rounded-lg bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md">
              ‚ú® –ù–æ–≤–∞—è
            </button>
          </div>
          <div id="sessionsList" class="mt-3 space-y-2 max-h-72 overflow-auto scrollbar-thin"></div>
        </div>

        <div class="border rounded-xl bg-white/90 backdrop-blur-sm p-4 shadow-elegant hover:shadow-xl transition-all duration-300">
          <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-2 h-2 bg-gradient-to-r from-blue-400 to-blue-500 rounded-full animate-pulse"></span>
            –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
          </h3>
          <div class="mt-2 space-y-3 text-sm">
            <button id="toolChat" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-brand-500 to-brand-600 text-white text-left transition-all duration-300 hover:transform hover:scale-105 shadow-lg flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">üí¨</span>
              <span class="font-medium">–ò–ò –ß–∞—Ç</span>
            </button>
            <button id="toolCompliance" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-emerald-100 hover:to-emerald-200 text-gray-700 hover:text-emerald-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">üîé</span>
              <span class="font-medium">–ö–æ–º–ø–ª–∞–µ–Ω—Å‚Äë—á–µ–∫–µ—Ä</span>
            </button>
            <button id="toolCompare" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-amber-100 hover:to-amber-200 text-gray-700 hover:text-amber-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">‚öñÔ∏è</span>
              <span class="font-medium">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–æ–≤</span>
            </button>
            <button id="toolTranslate" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-cyan-100 hover:to-cyan-200 text-gray-700 hover:text-cyan-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">üåê</span>
              <span class="font-medium">–ü–µ—Ä–µ–≤–æ–¥—ã</span>
            </button>
            <button id="toolWhatIf" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-purple-100 hover:to-purple-200 text-gray-700 hover:text-purple-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">üß≠</span>
              <span class="font-medium">What‚Äëif —Å–∏–º—É–ª—è—Ç–æ—Ä</span>
            </button>
            <button id="toolSettings" class="sidebar-item w-full px-4 py-3 rounded-lg bg-gradient-to-r from-gray-100 to-gray-200 hover:from-blue-100 hover:to-blue-200 text-gray-700 hover:text-blue-800 text-left transition-all duration-300 hover:transform hover:scale-105 shadow-sm hover:shadow-md flex items-center gap-3 group">
              <span class="text-lg group-hover:animate-bounce">‚öôÔ∏è</span>
              <span class="font-medium">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </button>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="col-span-12 md:col-span-9 space-y-4">

        <!-- Panels -->
        <div id="panelChat" class="border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">Expl<span id="modelLabel" class="font-medium">Ai</span>ner<span id="ragStatus" class="font-medium"></span></div>
            <div class="flex items-center gap-2">
              <button id="exportChat" class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
              <div class="text-xs text-gray-500">–ù–µ —è–≤–ª—è–µ—Ç—Å—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π</div>
            </div>
          </div>
          <div id="chatStream" class="mt-3 h-[52vh] overflow-auto scrollbar-thin pr-2"></div>
          <div id="uploadedFiles" class="mt-2 flex flex-wrap gap-2 hidden"></div>
          <div class="mt-3 border rounded-lg p-2">
            <div class="flex items-center gap-2 mb-2">
              <button id="attachBtn" class="text-sm px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 flex items-center gap-1">
                <span>üìé</span> –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å
              </button>
              <button id="voiceBtn" class="text-sm px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">üéôÔ∏è –ì–æ–ª–æ—Å</button>
              <div class="flex items-center gap-3 ml-auto text-xs">
                <label class="flex items-center gap-1"><input id="toggleJargon" type="checkbox" checked class="rounded"> –ñ–∞—Ä–≥–æ–Ω</label>
                <label class="flex items-center gap-1"><input id="toggleFact" type="checkbox" checked class="rounded"> –§–∞–∫—Ç‚Äë—á–µ–∫</label>
                <label class="flex items-center gap-1"><input id="toggleLang" type="checkbox" checked class="rounded"> –ú—É–ª—å—Ç–∏—è–∑—ã–∫</label>
              </div>
            </div>
            <textarea id="chatInput" rows="2" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ NDA –Ω–∞ —Ä–∏—Å–∫–∏ –ø–æ GDPR..."
              class="w-full resize-y rounded-md border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500"></textarea>
            <div class="mt-2 flex items-center justify-between">
              <div id="inputHint" class="text-xs text-gray-500">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏</div>
              <div class="flex gap-2">
                <button id="stopBtn" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm hidden">‚èπÔ∏è –°—Ç–æ–ø</button>
                <button id="sendBtn" class="px-3 py-2 rounded bg-brand-500 hover:bg-brand-600 text-white text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
          <!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
          <input id="fileInput" type="file" class="hidden" multiple />
        </div>

        <div id="panelCompliance" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">–ö–æ–º–ø–ª–∞–µ–Ω—Å‚Äë—á–µ–∫–µ—Ä</h3>
            <div class="text-xs text-gray-500">GDPR ‚Ä¢ CCPA ‚Ä¢ ISO/IEC 27001 (–¥–µ–º–æ)</div>
          </div>
          <div class="mt-2 grid md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <textarea id="complianceText" rows="5" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ–ª–∏—Ç–∏–∫–∏/—Å–æ–≥–ª–∞—à–µ–Ω–∏—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç —Å–ª–µ–≤–∞" class="w-full border rounded-md p-2"></textarea>
              <div class="mt-2 flex gap-2">
                <button id="runCompliance" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm">–ê–Ω–∞–ª–∏–∑</button>
                <button id="fixCompliance" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–∞–≤–∫–∏</button>
              </div>
            </div>
            <div>
              <div class="text-sm font-medium">–ü—Ä–æ—Ñ–∏–ª–∏</div>
              <div class="mt-2 space-y-1 text-sm">
                <label class="flex items-center gap-2"><input id="profileGDPR" type="checkbox" class="rounded" checked> GDPR</label>
                <label class="flex items-center gap-2"><input id="profileCCPA" type="checkbox" class="rounded"> CCPA</label>
                <label class="flex items-center gap-2"><input id="profileHIPAA" type="checkbox" class="rounded"> HIPAA</label>
              </div>
              <div class="mt-3 text-xs text-gray-500">–ê–Ω–∞–ª–∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π/–º–æ–∫. –î–ª—è –ø—Ä–æ–¥ ‚Äî –ø–æ–¥–∫–ª—é—á–∏—Ç–µ /api/chat –∞–≥–µ–Ω—Ç.</div>
            </div>
          </div>
          <div id="complianceResult" class="mt-3 text-sm"></div>
        </div>

        <div id="panelCompare" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–æ–≤</h3>
            <div class="text-xs text-gray-500">–ó–∞–≥—Ä—É–∑–∏—Ç–µ 2 –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</div>
          </div>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <!-- –î–æ–∫—É–º–µ–Ω—Ç A -->
            <div class="border rounded-lg p-3">
              <div class="text-sm font-medium mb-2">–î–æ–∫—É–º–µ–Ω—Ç A</div>
              <div id="docAStatus" class="text-xs text-gray-500 mb-2">–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>
              <input id="fileInputA" type="file" class="hidden" accept=".pdf,.doc,.docx,.txt">
              <button id="uploadDocA" class="w-full px-3 py-2 rounded bg-blue-100 hover:bg-blue-200 text-blue-700 text-sm flex items-center justify-center gap-2">
                <span>üìÑ</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç A
              </button>
              <div id="docAPreview" class="mt-2 hidden">
                <div class="text-xs font-medium text-gray-600">–ó–∞–≥—Ä—É–∂–µ–Ω:</div>
                <div id="docAName" class="text-xs text-gray-800"></div>
                <div id="docASize" class="text-xs text-gray-500"></div>
          </div>
          </div>
            
            <!-- –î–æ–∫—É–º–µ–Ω—Ç B -->
            <div class="border rounded-lg p-3">
              <div class="text-sm font-medium mb-2">–î–æ–∫—É–º–µ–Ω—Ç B</div>
              <div id="docBStatus" class="text-xs text-gray-500 mb-2">–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>
              <input id="fileInputB" type="file" class="hidden" accept=".pdf,.doc,.docx,.txt">
              <button id="uploadDocB" class="w-full px-3 py-2 rounded bg-green-100 hover:bg-green-200 text-green-700 text-sm flex items-center justify-center gap-2">
                <span>üìÑ</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç B
              </button>
              <div id="docBPreview" class="mt-2 hidden">
                <div class="text-xs font-medium text-gray-600">–ó–∞–≥—Ä—É–∂–µ–Ω:</div>
                <div id="docBName" class="text-xs text-gray-800"></div>
                <div id="docBSize" class="text-xs text-gray-500"></div>
              </div>
            </div>
        </div>

          <div class="mt-4 flex items-center justify-between">
            <div class="text-xs text-gray-500">
              <span id="compareStatus">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</span>
            </div>
            <button id="runCompare" class="px-4 py-2 rounded bg-brand-500 hover:bg-brand-600 text-white text-sm disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
              –°—Ä–∞–≤–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
            </button>
          </div>
          
          <div id="compareResult" class="mt-4 text-sm"></div>
        </div>

        <div id="panelTranslate" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold flex items-center gap-2">
              <span class="text-xl">üåê</span>
              –ü–µ—Ä–µ–≤–æ–¥—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            </h3>
            <div class="text-xs text-gray-500 flex items-center gap-2">
              <span>–ü–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ Google Translate</span>
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">Powered by Google</span>
            </div>
          </div>
          
          <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ -->
          <div class="mb-4 p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 transition-colors">
            <div class="text-center">
              <div class="mb-2">üìÑ</div>
              <div class="text-sm font-medium mb-1">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</div>
              <div class="text-xs text-gray-500 mb-3">PDF, DOCX, TXT —Ñ–∞–π–ª—ã</div>
              <input type="file" id="translateFileInput" accept=".pdf,.docx,.txt" class="hidden">
              <button id="uploadTranslateBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition-colors">
                üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
              </button>
            </div>
            <div id="translateFilePreview" class="hidden mt-3 p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-sm">üìÑ</span>
                  <div>
                    <div id="translateFileName" class="text-sm font-medium"></div>
                    <div id="translateFileSize" class="text-xs text-gray-500"></div>
                  </div>
                </div>
                <button id="removeTranslateFile" class="text-red-500 hover:text-red-700 text-sm">‚úï</button>
              </div>
            </div>
          </div>

          <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–æ–≤ -->
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium mb-2">–ò—Å—Ö–æ–¥–Ω—ã–π —è–∑—ã–∫</label>
              <select id="sourceLanguage" class="w-full border rounded-lg p-2 text-sm">
                <option value="auto">üîç –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</option>
                <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                <option value="en">üá∫üá∏ –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                <option value="zh">üá®üá≥ –ö–∏—Ç–∞–π—Å–∫–∏–π</option>
                <option value="es">üá™üá∏ –ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
                <option value="fr">üá´üá∑ –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
                <option value="de">üá©üá™ –ù–µ–º–µ—Ü–∫–∏–π</option>
                <option value="ja">üáØüáµ –Ø–ø–æ–Ω—Å–∫–∏–π</option>
                <option value="ko">üá∞üá∑ –ö–æ—Ä–µ–π—Å–∫–∏–π</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">–¶–µ–ª–µ–≤–æ–π —è–∑—ã–∫</label>
              <select id="targetLanguage" class="w-full border rounded-lg p-2 text-sm">
                <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                <option value="en">üá∫üá∏ –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                <option value="zh">üá®üá≥ –ö–∏—Ç–∞–π—Å–∫–∏–π</option>
                <option value="es">üá™üá∏ –ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
                <option value="fr">üá´üá∑ –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
                <option value="de">üá©üá™ –ù–µ–º–µ—Ü–∫–∏–π</option>
                <option value="ja">üáØüáµ –Ø–ø–æ–Ω—Å–∫–∏–π</option>
                <option value="ko">üá∞üá∑ –ö–æ—Ä–µ–π—Å–∫–∏–π</option>
              </select>
            </div>
          </div>

          <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
          <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞</span>
            </div>
            <div class="grid grid-cols-2 gap-3 text-xs">
              <label class="flex items-center gap-2">
                <input type="checkbox" id="preserveFormatting" checked class="rounded">
                <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" id="legalTerms" checked class="rounded">
                <span>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è</span>
              </label>
            </div>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
          <div class="flex gap-3 mb-4">
            <button id="startTranslation" class="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg font-medium transition-all duration-300 hover:transform hover:scale-105 shadow-lg hover:shadow-xl disabled:opacity-50" disabled>
              üöÄ –ù–∞—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥
            </button>
          </div>

          <!-- –°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–≤–æ–¥–∞ -->
          <div id="translationStatus" class="hidden mb-4 p-3 rounded-lg">
            <div class="flex items-center gap-2">
              <div class="loading-spinner"></div>
              <span class="text-sm">–ü–µ—Ä–µ–≤–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞...</span>
            </div>
            <div class="mt-2 bg-gray-200 rounded-full h-2">
              <div id="translationProgress" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>

          <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ -->
          <div id="translationResult" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-medium">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–≤–æ–¥–∞</h4>
              <div class="flex gap-2">
                <button id="downloadTranslated" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm">
                  üì• –°–∫–∞—á–∞—Ç—å
                </button>
                <button id="copyTranslated" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded text-sm">
                  üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
              </div>
            </div>
            <div id="translatedContent" class="max-h-96 overflow-auto border rounded-lg p-4 bg-gray-50 text-sm whitespace-pre-wrap font-mono leading-relaxed"></div>
          </div>
        </div>

        <div id="panelWhatIf" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold flex items-center gap-2">
              <span class="text-xl">üß≠</span>
              What‚Äëif —Å–∏–º—É–ª—è—Ç–æ—Ä
            </h3>
            <div class="text-xs text-gray-500">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Mermaid –¥–∏–∞–≥—Ä–∞–º–º</div>
          </div>

          <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ -->
          <div class="mb-4 p-3 border border-dashed border-gray-300 rounded-lg hover:border-purple-400 transition-colors">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-sm">üìÑ</span>
                <div>
                  <div class="text-sm font-medium">–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
                  <div class="text-xs text-gray-500">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç</div>
          </div>
              </div>
              <div class="flex gap-2">
                <input type="file" id="whatIfFileInput" accept=".pdf,.docx,.txt" class="hidden">
                <button id="uploadWhatIfBtn" class="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white rounded text-sm">
                  üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å
                </button>
              </div>
            </div>
            <div id="whatIfFilePreview" class="hidden mt-2 p-2 bg-purple-50 rounded">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-xs">üìÑ</span>
                  <div>
                    <div id="whatIfFileName" class="text-xs font-medium"></div>
                    <div id="whatIfFileSize" class="text-xs text-gray-500"></div>
                  </div>
                </div>
                <button id="removeWhatIfFile" class="text-red-500 hover:text-red-700 text-xs">‚úï</button>
              </div>
            </div>
          </div>

          <textarea id="whatIfInput" rows="4" placeholder="–ß—Ç–æ –µ—Å–ª–∏ —è –Ω–∞—Ä—É—à—É –ø—É–Ω–∫—Ç –æ –Ω–µ–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤ –¥–æ–≥–æ–≤–æ—Ä–µ –Ω–∞ 6 –º–µ—Å—è—Ü–µ–≤? –ö–∞–∫–∏–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è?" class="w-full border rounded-md p-3 mt-2 resize-none"></textarea>
          
          <div class="mt-3 flex gap-2">
            <button id="genFlow" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white rounded-lg font-medium transition-all duration-300 hover:transform hover:scale-105 shadow-lg hover:shadow-xl text-sm">
              üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π
            </button>
          </div>
          
          <div id="flowWrap" class="mt-4 overflow-auto border rounded-lg p-3 bg-gray-50 min-h-[200px] hidden">
            <div class="text-center text-gray-500 text-sm py-8">
              –î–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å
            </div>
          </div>
        </div>

        <div id="panelDocAnalysis" class="hidden border rounded-xl bg-white p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
            <div class="text-xs text-gray-500"><span id="docAnalysisName"></span></div>
          </div>
          <div class="mt-3 grid md:grid-cols-3 gap-3">
            <div class="md:col-span-3">
              <div class="text-sm font-medium">–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞</div>
              <div class="mt-2 flex gap-2">
                <button id="analysisGeneral" class="px-3 py-1 rounded bg-brand-500 text-white text-sm">–û–±—â–∏–π</button>
                <button id="analysisLegal" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-sm">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π</button>
                <button id="analysisRisks" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-sm">–†–∏—Å–∫–∏</button>
              </div>
            </div>
          </div>
          <div id="docAnalysisResult" class="mt-3"></div>
        </div>
        
        <div id="panelSettings" class="hidden border rounded-xl bg-white p-4">
          <h3 class="font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <div class="grid md:grid-cols-2 gap-4 mt-2">
            <div>
              <label class="text-sm font-medium">–ú–æ–¥–µ–ª—å</label>
              <select id="modelSelect" class="w-full border rounded-md p-2 mt-1">
                <option value="gpt-4o">OpenAI GPT‚Äë4o</option>
                <option value="o1">OpenAI o1 (reasoning)</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">–ì–æ–ª–æ—Å (TTS)</label>
              <select id="voiceSelect" class="w-full border rounded-md p-2 mt-1"></select>
            </div>
            <div>
              <label class="text-sm font-medium">–í–∏–¥–µ–æ‚Äë–∞–≤–∞—Ç–∞—Ä</label>
              <select id="avatarSelect" class="w-full border rounded-md p-2 mt-1">
                <option value="none">–û—Ç–∫–ª—é—á–µ–Ω–æ</option>
                <option value="heygen">HeyGen (—á–µ—Ä–µ–∑ /api/video)</option>
                <option value="synthesia">Synthesia (—á–µ—Ä–µ–∑ /api/video)</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">RAG –∏—Å—Ç–æ—á–Ω–∏–∫</label>
              <select id="ragSource" class="w-full border rounded-md p-2 mt-1">
                <option value="off">–í—ã–∫–ª</option>
                <option value="local">–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</option>
                <option value="vector">–í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</option>
              </select>
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-500">–î–ª—è –ø—Ä–æ–¥‚Äë—Ä–µ–∂–∏–º–∞ —É–∫–∞–∂–∏—Ç–µ –∫–ª—é—á–∏ –≤ .env –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ Next.js API.</div>
        </div>
      </main>
    </div>
  </section>

  <!-- Login/Register Modal -->
  <div id="loginModal" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full">
              <!-- Login Form -->
        <div id="loginFormContainer" class="auth-form">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">üöÄ –í—Ö–æ–¥ –≤ explAiner</h3>
          <button id="loginClose" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
      </div>
        
        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Email</label>
            <input type="email" id="loginEmail" required class="w-full border rounded-lg p-3" placeholder="your@email.com">
      </div>
          <div>
            <label class="block text-sm font-medium mb-2">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="loginPassword" required class="w-full border rounded-lg p-3" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
          </div>
          <button type="submit" class="w-full btn">üöÄ –í–æ–π—Ç–∏</button>
        </form>
        
        <div class="mt-4 text-center text-sm text-gray-500">
          –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <button id="showRegister" class="text-brand-500 hover:underline font-medium">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
      </div>

              <!-- Register Form -->
        <div id="registerFormContainer" class="hidden auth-form">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">‚ú® –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ explAiner</h3>
          <button id="registerClose" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>
        
        <form id="registerForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">–ò–º—è</label>
            <input type="text" id="registerName" required class="w-full border rounded-lg p-3" placeholder="–í–∞—à–µ –∏–º—è">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Email</label>
            <input type="email" id="registerEmail" required class="w-full border rounded-lg p-3" placeholder="your@email.com">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="registerPassword" required class="w-full border rounded-lg p-3" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" minlength="6">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="registerPasswordConfirm" required class="w-full border rounded-lg p-3" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
          </div>
          <button type="submit" class="w-full btn">‚ú® –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </form>
        
        <div class="mt-4 text-center text-sm text-gray-500">
          –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <button id="showLogin" class="text-brand-500 hover:underline font-medium">–í–æ–π—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Demo Modal -->
  <div id="demoModal" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">üé¨ –î–µ–º–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π explAiner</h3>
        <button id="demoClose" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      </div>
      
      <div class="grid md:grid-cols-2 gap-6">
        <!-- –ß–∞—Ç —Å –ò–ò -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">üí¨ –ò–ò –ß–∞—Ç</h4>
          <div class="space-y-2 text-sm">
            <div class="p-3 bg-gray-50 rounded-lg">
              <strong>–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</strong>
              <ul class="mt-2 space-y-1">
                <li>‚Ä¢ "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–æ—Ç NDA –Ω–∞ —Ä–∏—Å–∫–∏ –ø–æ GDPR"</li>
                <li>‚Ä¢ "–û–±—ä—è—Å–Ω–∏—Ç–µ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –ø—É–Ω–∫—Ç –æ –Ω–µ–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏"</li>
                <li>‚Ä¢ "–ö–∞–∫–∏–µ —Ä–∏—Å–∫–∏ –≤ —ç—Ç–æ–º –¥–æ–≥–æ–≤–æ—Ä–µ –∞—Ä–µ–Ω–¥—ã?"</li>
                <li>‚Ä¢ "–°—Ä–∞–≤–Ω–∏—Ç–µ –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞"</li>
              </ul>
            </div>
            <div class="p-3 bg-blue-50 rounded-lg">
              <strong>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</strong>
              <ul class="mt-2 space-y-1">
                <li>‚Ä¢ –ê–≤—Ç–æ–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤</li>
                <li>‚Ä¢ –§–∞–∫—Ç-—á–µ–∫ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏</li>
                <li>‚Ä¢ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</li>
                <li>‚Ä¢ –ê—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è</li>
              </ul>
            </div>
            <div class="mt-2 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
              <div class="text-center text-blue-600">
                <div class="text-2xl mb-2">üí¨</div>
                <div class="text-sm font-medium">–ò–ò –ß–∞—Ç –î–µ–º–æ</div>
              </div>
            </div>
          </div>
        </div>

        <!-- –ö–æ–º–ø–ª–∞–µ–Ω—Å-—á–µ–∫–µ—Ä -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">üîé –ö–æ–º–ø–ª–∞–µ–Ω—Å-—á–µ–∫–µ—Ä</h4>
          <div class="space-y-2 text-sm">
            <div class="p-3 bg-gray-50 rounded-lg">
              <strong>–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã:</strong>
              <ul class="mt-2 space-y-1">
                <li>‚Ä¢ GDPR (–ï–°)</li>
                <li>‚Ä¢ CCPA (–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è)</li>
                <li>‚Ä¢ HIPAA (–º–µ–¥–∏—Ü–∏–Ω–∞)</li>
                <li>‚Ä¢ ISO/IEC 27001</li>
              </ul>
            </div>
            <div class="p-3 bg-green-50 rounded-lg">
              <strong>–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:</strong>
              <ul class="mt-2 space-y-1">
                <li>‚Ä¢ –ü—Ä–∞–≤–æ–≤—ã–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</li>
                <li>‚Ä¢ –ü—Ä–∞–≤–∞ —Å—É–±—ä–µ–∫—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö</li>
                <li>‚Ä¢ –°—Ä–æ–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è</li>
                <li>‚Ä¢ –ú–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</li>
              </ul>
            </div>
            <div class="mt-2 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
              <div class="text-center text-green-600">
                <div class="text-2xl mb-2">üîé</div>
                <div class="text-sm font-medium">–ö–æ–º–ø–ª–∞–µ–Ω—Å-—á–µ–∫–µ—Ä –î–µ–º–æ</div>
              </div>
            </div>
          </div>
        </div>

        <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–æ–≤</h4>
          <div class="space-y-2 text-sm">
            <div class="p-3 bg-gray-50 rounded-lg">
              <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</strong>
              <ul class="mt-2 space-y-1">
                <li>‚Ä¢ PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã</li>
                <li>‚Ä¢ Word (.docx)</li>
                <li>‚Ä¢ –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã</li>
                <li>‚Ä¢ Markdown</li>
              </ul>
            </div>
            <div class="p-3 bg-yellow-50 rounded-lg">
              <strong>–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–∏–π:</strong>
              <ul class="mt-2 space-y-1">
                <li>‚Ä¢ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</li>
                <li>‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤</li>
                <li>‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è</li>
                <li>‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</li>
              </ul>
            </div>
            <div class="mt-2 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200">
              <div class="text-center text-yellow-600">
                <div class="text-2xl mb-2">‚öñÔ∏è</div>
                <div class="text-sm font-medium">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –î–æ–≥–æ–≤–æ—Ä–æ–≤ –î–µ–º–æ</div>
              </div>
            </div>
          </div>
        </div>

        <!-- What-if —Å–∏–º—É–ª—è—Ç–æ—Ä -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">üß≠ What-if —Å–∏–º—É–ª—è—Ç–æ—Ä</h4>
          <div class="space-y-2 text-sm">
            <div class="p-3 bg-gray-50 rounded-lg">
              <strong>–ü—Ä–∏–º–µ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:</strong>
              <ul class="mt-2 space-y-1">
                <li>‚Ä¢ "–ß—Ç–æ –µ—Å–ª–∏ –Ω–∞—Ä—É—à—É NDA?"</li>
                <li>‚Ä¢ "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–ª–∞—Ç–µ–∂–∞"</li>
                <li>‚Ä¢ "–†–∏—Å–∫–∏ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞"</li>
                <li>‚Ä¢ "GDPR –Ω–∞—Ä—É—à–µ–Ω–∏—è"</li>
              </ul>
            </div>
            <div class="p-3 bg-purple-50 rounded-lg">
              <strong>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:</strong>
              <ul class="mt-2 space-y-1">
                <li>‚Ä¢ Mermaid –¥–∏–∞–≥—Ä–∞–º–º—ã</li>
                <li>‚Ä¢ –ü–æ—à–∞–≥–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏</li>
                <li>‚Ä¢ –û—Ü–µ–Ω–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π</li>
                <li>‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π</li>
              </ul>
            </div>
            <div class="mt-2 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
              <div class="text-center text-purple-600">
                <div class="text-2xl mb-2">üß≠</div>
                <div class="text-sm font-medium">What-If –°–∏–º—É–ª—è—Ç–æ—Ä –î–µ–º–æ</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 p-4 bg-brand-50 rounded-xl">
        <h4 class="font-semibold mb-2">üöÄ –ù–∞—á–Ω–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</h4>
        <p class="text-sm text-gray-600 mb-3">–ù–∞–∂–º–∏—Ç–µ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–º–æ" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤ –¥–µ–π—Å—Ç–≤–∏–∏</p>
        <div class="flex gap-4">
        <button id="startDemo" class="px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white rounded-lg font-medium">
          –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–º–æ
        </button>
          <button id="watchVideoDemo" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium flex items-center gap-2">
            <span>‚ñ∂Ô∏è</span> –°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ
        </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm shadow-lg"></div>
  </div>

  <!-- Scripts -->
  <script>
    // Utilities
    const $ = (sel, parent=document) => parent.querySelector(sel);
    const $$ = (sel, parent=document) => Array.from(parent.querySelectorAll(sel));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const API = { chat:'/api/chat', upload:'/api/upload', audio:'/api/audio', video:'/api/video', compliance:'/api/compliance', compare:'/api/compare', whatif:'/api/whatif', analyze:'/api/analyze' };
    const LOCAL_KEY = 'explAiner_state_v1';

    const state = {
      user: null,
      settings: { 
        model:'gpt-4o', 
        voice:'', 
        avatar:'none', 
        rag:'off', 
        explainJargon:true, 
        factCheck:true, 
        multilingual:true, 
        encryption:false,
        language: 'ru' // ru –∏–ª–∏ en
      },
      sessions: [],
      docs: [],
      activeSessionId: null,
      busy: false,
      recorder: { media: null, chunks: [], active: false },
      crypto: { key: null }, // AES-GCM demo
      compare: { docA: null, docB: null }, // –î–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
      autoSaveTimeout: null // –¢–∞–π–º–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
    };
    
    // –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const translations = {
      ru: {
        app_title: 'explAiner ‚Äî Legal AI Assistant',
        disclaimer: '–ù–µ —è–≤–ª—è–µ—Ç—Å—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π',
        btn_audio: 'üîä –ê—É–¥–∏–æ',
        btn_video: 'üé¨ –í–∏–¥–µ–æ',
        btn_sources: 'üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏',
        btn_attach: 'üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å',
        btn_voice: 'üéôÔ∏è –ì–æ–ª–æ—Å',
        btn_send: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        btn_stop: '‚èπÔ∏è –°—Ç–æ–ø',
        btn_export: 'üì• –≠–∫—Å–ø–æ—Ä—Ç',
        btn_login: '–í–æ–π—Ç–∏',
        btn_logout: '–í—ã–π—Ç–∏',
        btn_theme: 'üåì –¢–µ–º–∞',
        user_name: '–í—ã',
        chat_placeholder: '–°–ø—Ä–æ—Å–∏—Ç–µ: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ NDA –Ω–∞ —Ä–∏—Å–∫–∏ –ø–æ GDPR...',
        new_session: '–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è',
        upload_file: '‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å',
        drop_files: '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞',
        encrypt_local: '–®–∏—Ñ—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ (AES‚ÄëGCM demo)',
        compliance_checker: 'üîé –ö–æ–º–ø–ª–∞–µ–Ω—Å‚Äë—á–µ–∫–µ—Ä',
        contract_compare: '‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–æ–≤',
        whatif: 'üß≠ What‚Äëif —Å–∏–º—É–ª—è—Ç–æ—Ä',
        settings: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏'
      },
      en: {
        app_title: 'explAiner ‚Äî Legal AI Assistant',
        disclaimer: 'Not legal advice',
        btn_audio: 'üîä Audio',
        btn_video: 'üé¨ Video',
        btn_sources: 'üìö Sources',
        btn_attach: 'üìé Attach',
        btn_voice: 'üéôÔ∏è Voice',
        btn_send: 'Send',
        btn_stop: '‚èπÔ∏è Stop',
        btn_export: 'üì• Export',
        btn_login: 'Login',
        btn_logout: 'Logout',
        btn_theme: 'üåì Theme',
        user_name: 'You',
        chat_placeholder: 'Ask: Check this NDA for GDPR risks...',
        new_session: 'New session',
        upload_file: '‚¨ÜÔ∏è Upload',
        drop_files: 'Drop files here',
        encrypt_local: 'Encrypt locally (AES‚ÄëGCM demo)',
        compliance_checker: 'üîé Compliance checker',
        contract_compare: '‚öñÔ∏è Contract comparison',
        whatif: 'üß≠ What‚Äëif simulator',
        settings: '‚öôÔ∏è Settings'
      }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
    const t = (key) => {
      const lang = state.settings.language || 'ru';
      return translations[lang][key] || translations['ru'][key] || key;
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const updateLanguage = (lang) => {
      state.settings.language = lang;
      saveState();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      document.title = t('app_title');
      $('#chatInput').placeholder = t('chat_placeholder');
      $('#sendBtn').textContent = t('btn_send');
      $('#stopBtn').textContent = t('btn_stop');
      $('#exportChat').textContent = t('btn_export');
      $('#attachBtn').textContent = t('btn_attach');
      $('#voiceBtn').textContent = t('btn_voice');
      $('#loginBtn').textContent = t('btn_login');
      $('#logoutBtn').textContent = t('btn_logout');
      $('#themeToggle').textContent = t('btn_theme');
      $('#newChatBtn').textContent = '+ ' + t('new_session');
      
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      renderSessions();
      renderChat();
    };
    
    const saveState = () => {
      try {
        const { user, settings, sessions, docs, activeSessionId } = state;
        localStorage.setItem(LOCAL_KEY, JSON.stringify({ user, settings, sessions, docs, activeSessionId }));
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if (user) {
          autoSaveUserHistory();
        }
      } catch {}
    };
    const loadState = () => {
      try {
        const data = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
        Object.assign(state, data, { 
          busy: false, 
          recorder: { media:null, chunks:[], active:false },
          autoSaveTimeout: null // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        });
      } catch {}
    };

    // Theme
    const setTheme = (mode) => {
      document.body.dataset.theme = mode;
      document.documentElement.classList.toggle('dark', mode === 'dark');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
      if (mode === 'dark') {
        document.body.classList.add('bg-gray-900', 'text-white');
        document.body.classList.remove('bg-gray-50', 'text-gray-900');
      } else {
        document.body.classList.add('bg-gray-50', 'text-gray-900');
        document.body.classList.remove('bg-gray-900', 'text-white');
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –ø–∞–Ω–µ–ª–∏
      const cards = document.querySelectorAll('.bg-white');
      cards.forEach(card => {
        if (mode === 'dark') {
          card.classList.remove('bg-white');
          card.classList.add('bg-gray-800');
        } else {
          card.classList.remove('bg-gray-800');
          card.classList.add('bg-white');
        }
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Å–∞–π–¥–±–∞—Ä–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ
      if (!$('#app').classList.contains('hidden')) {
        updateSidebarButtons();
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
      const fileChips = document.querySelectorAll('#uploadedFiles > div');
      fileChips.forEach(chip => {
        if (mode === 'dark') {
          chip.classList.remove('bg-gray-100');
          chip.classList.add('bg-gray-700');
        } else {
          chip.classList.remove('bg-gray-700');
          chip.classList.add('bg-gray-100');
        }
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫
      const buttons = document.querySelectorAll('button.bg-gray-100, button.bg-gray-200');
      buttons.forEach(button => {
        if (mode === 'dark') {
          if (button.classList.contains('bg-gray-100')) {
            button.classList.remove('bg-gray-100');
            button.classList.add('bg-gray-700');
          }
          if (button.classList.contains('bg-gray-200')) {
            button.classList.remove('bg-gray-200');
            button.classList.add('bg-gray-600');
          }
          if (button.classList.contains('hover:bg-gray-200')) {
            button.classList.remove('hover:bg-gray-200');
            button.classList.add('hover:bg-gray-600');
          }
        } else {
          if (button.classList.contains('bg-gray-700')) {
            button.classList.remove('bg-gray-700');
            button.classList.add('bg-gray-100');
          }
          if (button.classList.contains('bg-gray-600')) {
            button.classList.remove('bg-gray-600');
            button.classList.add('bg-gray-200');
          }
          if (button.classList.contains('hover:bg-gray-600')) {
            button.classList.remove('hover:bg-gray-600');
            button.classList.add('hover:bg-gray-200');
          }
        }
      });
      
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
      if (mode === 'dark') {
        document.body.style.backgroundColor = '#111827';
        document.body.style.color = '#f9fafb';
      } else {
        document.body.style.backgroundColor = '#f9fafb';
        document.body.style.color = '#111827';
      }
    };

    // Toast
    function toast(msg, type='info') {
      const wrap = $('#toast'); const box = wrap.firstElementChild;
      box.textContent = msg;
      wrap.classList.remove('hidden');
      box.className = 'px-4 py-2 rounded-lg text-sm shadow-lg ' + (type==='error'?'bg-red-600 text-white':type==='success'?'bg-green-600 text-white':'bg-gray-900 text-white');
      setTimeout(()=>wrap.classList.add('hidden'), 2200);
    }

    // Sessions
    function newSession(title='–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è') {
      const id = 's_' + Math.random().toString(36).slice(2,9);
      const session = { id, title, createdAt: Date.now(), messages: [] };
      state.sessions.unshift(session);
      state.activeSessionId = id;
      renderSessions();
      renderChat();
      saveState();
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      if (state.user) {
        saveUserHistory(state.user.id);
      }
      
      return session;
    }
    const getActive = () => state.sessions.find(s => s.id === state.activeSessionId);

    function renderSessions() {
      const list = $('#sessionsList');
      list.innerHTML = '';
      state.sessions.forEach(s => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-gray-50 ' + (s.id===state.activeSessionId?'bg-gray-100':'');
        div.innerHTML = `
          <div class="h-7 w-7 rounded bg-gray-100 flex items-center justify-center">üí¨</div>
          <div class="flex-1">
            <div class="text-sm font-medium">${s.title}</div>
            <div class="text-xs text-gray-500">${new Date(s.createdAt).toLocaleString()}</div>
          </div>
          <button class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="rename">‚úèÔ∏è</button>
          <button class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="del">üóëÔ∏è</button>
        `;
        div.onclick = (e) => {
          if (e.target.dataset.act === 'rename') {
            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏', s.title) || s.title;
            s.title = name; renderSessions(); saveState(); 
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (state.user) {
              saveUserHistory(state.user.id);
            }
            return;
          }
          if (e.target.dataset.act === 'del') {
            state.sessions = state.sessions.filter(x => x.id !== s.id);
            if (state.activeSessionId === s.id) state.activeSessionId = state.sessions[0]?.id || null;
            renderSessions(); renderChat(); saveState(); 
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (state.user) {
              saveUserHistory(state.user.id);
            }
            return;
          }
          state.activeSessionId = s.id; renderSessions(); renderChat();
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
          if (state.user) {
            saveUserHistory(state.user.id);
          }
        };
        list.appendChild(div);
      });
    }



    // Chat
    function renderChat() {
      const stream = $('#chatStream');
      stream.innerHTML = '';
      const s = getActive(); if (!s) return;
      s.messages.forEach(m => appendMessage(m.role, m.content, m.meta));
      stream.scrollTop = stream.scrollHeight;
    }

    function appendMessage(role, content, meta={}) {
      const stream = $('#chatStream');
      const wrap = document.createElement('div');
      wrap.className = 'flex items-start gap-3 mb-3';
      
      let avatar, bg, name;
      
      if (role === 'user') {
        avatar = 'üßë';
        bg = 'bg-gray-50';
        name = t('user_name');
      } else if (role === 'system') {
        avatar = 'üìé';
        bg = 'bg-blue-50';
        name = '–°–∏—Å—Ç–µ–º–∞';
      } else {
        avatar = 'ü§ñ';
        bg = 'bg-indigo-50/60';
        name = 'explAiner';
      }
      
      const formattedContent = formatText(content);
      const md = state.settings.explainJargon && role!=='user' && role!=='system' ? renderWithJargon(formattedContent) : marked.parse(formattedContent);
      
      wrap.innerHTML = `
        <div class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-lg">${avatar}</div>
        <div class="flex-1 min-w-0">
          <div class="text-xs text-gray-500">${name}</div>
          <div class="mt-1 p-3 rounded-lg ${bg} prose prose-sm max-w-none">${md}</div>
          ${role === 'assistant' ? `
          <div class="mt-1 flex items-center gap-2 text-xs">
            <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="tts">${t('btn_audio')}</button>
            <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="vid">${t('btn_video')}</button>
            <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="src">${t('btn_sources')}</button>
          </div>
          <div class="mt-2 hidden text-xs text-gray-600" data-role="sources"></div>
          `:''}
        </div>
      `;
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
      if (role === 'assistant') {
        setupMessageEventHandlers(wrap, content, meta);
      }
      
      stream.appendChild(wrap);
      stream.scrollTop = stream.scrollHeight;
      // highlight code
      wrap.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
    }

    function setupMessageEventHandlers(wrap, content, meta={}) {
      const el = wrap.querySelector('[data-role="sources"]');
      wrap.addEventListener('click', async (e) => {
        if (!(e.target instanceof HTMLElement)) return;
        if (e.target.dataset.act === 'tts') {
          const text = stripHtml(content || '');
          await tts(text);
        }
        if (e.target.dataset.act === 'vid') {
          const text = stripHtml(content || '');
          await videoExplain(text);
        }
        if (e.target.dataset.act === 'src') {
          if (el) {
            if (el.classList.contains('hidden')) {
              el.classList.remove('hidden');
              el.innerHTML = renderSources(meta.sources || mockSources(textKeywords(content)));
            } else el.classList.add('hidden');
          }
        }
      });
    }
    
    function stripHtml(html) { const d = document.createElement('div'); d.innerHTML = html; return d.textContent || ''; }

    function renderWithJargon(text) {
      // –ø—Ä–æ—Å—Ç–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ—Ä–º–∏–Ω–æ–≤ RU/EN
      const dict = {
        'GDPR': '–û–±—â–∏–π —Ä–µ–≥–ª–∞–º–µ–Ω—Ç –ï–° –ø–æ –∑–∞—â–∏—Ç–µ –¥–∞–Ω–Ω—ã—Ö. –¢—Ä–µ–±—É–µ—Ç –∑–∞–∫–æ–Ω–Ω–æ—Å—Ç—å, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ü–µ–ª–µ–π, –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—é –∏ –ø—Ä–∞–≤–∞ —Å—É–±—ä–µ–∫—Ç–æ–≤.',
        'CCPA': '–ó–∞–∫–æ–Ω –ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏–∏ –æ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π.',
        'NDA': '–°–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ –Ω–µ—Ä–∞–∑–≥–ª–∞—à–µ–Ω–∏–∏ ‚Äî –¥–æ–≥–æ–≤–æ—Ä –æ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏.',
        'Force majeure': '–§–æ—Ä—Å-–º–∞–∂–æ—Ä ‚Äî –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ –Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º–æ–π —Å–∏–ª—ã.',
        'Indemnity': '–ò–Ω–¥–µ–º–Ω–∏—Ç–∏ ‚Äî –≤–æ–∑–º–µ—â–µ–Ω–∏–µ —É–±—ã—Ç–∫–æ–≤ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Ä–∏—Å–∫–∏.',
        'Non-compete': '–ù–µ–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è ‚Äî –∑–∞–ø—Ä–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞.',
        'Personal data': '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –ª—é–±–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ–º–æ–º –ª–∏—Ü–µ.'
      };
      let safe = text || '';
      for (const [term, explain] of Object.entries(dict)) {
        const re = new RegExp(`\\b(${term})\\b`, 'gi');
        safe = safe.replace(re, `<span title="${explain}" class="underline decoration-dotted cursor-help">$1</span>`);
      }
      return marked.parse(safe);
    }

    function textKeywords(text='') {
      return (text.toLowerCase().match(/[a-z–∞-—è]{4,}/gi) || []).slice(0,8);
    }

    function renderSources(sources=[]) {
      const items = sources.map(s => `<li class="mb-1"><a class="text-brand-600 hover:underline" target="_blank" href="${s.url}">${s.title}</a> <span class="text-gray-400">(${s.snippet})</span></li>`).join('');
      return `<div><div class="font-medium mb-1">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ (—Ñ–∞–∫—Ç‚Äë—á–µ–∫)</div><ul class="list-disc pl-5">${items}</ul></div>`;
    }

    function mockSources(keywords=[]) {
      const q = encodeURIComponent(keywords.join(' '));
      return [
        { title: 'Google Scholar –ø–æ–∏—Å–∫', url: `https://scholar.google.com/scholar?q=${q}`, snippet: '–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –ø—Ä–∞–≤–æ–≤—ã–º –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º' },
        { title: 'EUR-Lex GDPR', url: 'https://eur-lex.europa.eu/eli/reg/2016/679/oj', snippet: '–¢–µ–∫—Å—Ç GDPR (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π)' }
      ];
    }

    async function sendMessage() {
      const input = $('#chatInput'); const text = input.value.trim();
      if (!text) return;
      const s = getActive() || newSession();
      s.messages.push({ role:'user', content: text, meta:{} });
      appendMessage('user', text);
      input.value = '';

      const controller = new AbortController();
      $('#stopBtn').classList.remove('hidden');
      $('#sendBtn').disabled = true;
      state.busy = true;

      // AI placeholder / stream
      try {
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        let contextMessage = text;
        if (state.docs && state.docs.length > 0) {
          const doc = state.docs[state.docs.length - 1];
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É
          if (/–∞–Ω–∞–ª–∏–∑|–ø—Ä–æ–∞–Ω–∞–ª–∏–∑|—Ä–∞–∑–±–µ—Ä|–∏–∑—É—á|—Ä–∞—Å—Å–º–æ—Ç—Ä/i.test(text)) {
            contextMessage = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç "${doc.name}":\n\n${doc.content}\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç: ${text}`;
          } else if (/—Ä–∏—Å–∫|–æ–ø–∞—Å–Ω–æ—Å—Ç|–ø—Ä–æ–±–ª–µ–º|–Ω–µ–¥–æ—Å—Ç–∞—Ç/i.test(text)) {
            contextMessage = `–ù–∞–π–¥–∏ —Ä–∏—Å–∫–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ "${doc.name}":\n\n${doc.content}\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç: ${text}`;
          } else if (/–∫–ª—é—á–µ–≤|–≤–∞–∂–Ω|–æ—Å–Ω–æ–≤–Ω|–≥–ª–∞–≤–Ω/i.test(text)) {
            contextMessage = `–í—ã–¥–µ–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞ "${doc.name}":\n\n${doc.content}\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç: ${text}`;
          } else if (/—á—Ç–æ|–≥–¥–µ|–∫–æ–≥–¥–∞|–∫–∞–∫|–ø–æ—á–µ–º—É|–∑–∞—á–µ–º/i.test(text)) {
            contextMessage = `–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É "${doc.name}":\n\n${doc.content}\n\n–í–æ–ø—Ä–æ—Å: ${text}`;
          } else if (text.length < 50) {
            // –ö–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å - –≤–µ—Ä–æ—è—Ç–Ω–æ, –ø—Ä–æ—Å—Ç–æ "–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π" –∏–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–¥–æ–±–Ω–æ–µ
            contextMessage = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç "${doc.name}":\n\n${doc.content}`;
          }
        }

        const body = {
          model: state.settings.model,
          message: contextMessage,
          rag: state.settings.rag !== 'off' ? { source: state.settings.rag, docs: state.docs.map(d => ({ id:d.id, name:d.name, content: d.content })) } : null,
          multilingual: state.settings.multilingual,
          factCheck: state.settings.factCheck,
        };

        // Try real API; if fails ‚Äî mock
        let reply = '';
        let messageElement = null;
        const res = await fetch(API.chat, { method:'POST', body: JSON.stringify(body), headers: { 'Content-Type':'application/json' }, signal: controller.signal });
        if (res.ok && res.body?.getReader) {
          // stream chunks if server streams
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          const result = await streamOut(reader, decoder);
          reply = result.text;
          messageElement = result.element;
        } else {
          reply = await res.text();
          if (!reply || !res.ok) throw new Error('No server');
        }
        if (!reply) reply = mockAnswer(text);
        const meta = { sources: state.settings.factCheck ? mockSources(textKeywords(text)) : [] };
        s.messages.push({ role:'assistant', content: reply, meta });
        
        // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —É–∂–µ —Å–æ–∑–¥–∞–Ω –≤ streamOut, –æ–±–Ω–æ–≤–∏–º –µ–≥–æ, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–π
        if (!messageElement) {
          appendMessage('assistant', reply, meta);
        }
        saveState();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if (state.user) {
          saveUserHistory(state.user.id);
        }
      } catch (e) {
        // mock
        const reply = mockAnswer(text);
        const meta = { sources: state.settings.factCheck ? mockSources(textKeywords(text)) : [] };
        s.messages.push({ role:'assistant', content: reply, meta });
        appendMessage('assistant', reply, meta);
        saveState();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if (state.user) {
          saveUserHistory(state.user.id);
        }
      } finally {
        state.busy = false;
        $('#stopBtn').classList.add('hidden');
        $('#sendBtn').disabled = false;
        $('#chatStream').scrollTop = $('#chatStream').scrollHeight;
      }
    }

    async function streamOut(reader, decoder) {
      let done = false, acc = '';
      // render typing placeholder
      const stream = $('#chatStream');
      const wrap = document.createElement('div');
      wrap.className = 'flex items-start gap-3 mb-3';
      wrap.innerHTML = `
        <div class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-lg">ü§ñ</div>
        <div class="flex-1 min-w-0">
          <div class="text-xs text-gray-500">explAiner</div>
          <div class="mt-1 p-3 rounded-lg bg-indigo-50/60"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>
        </div>
      `;
      stream.appendChild(wrap);
      stream.scrollTop = stream.scrollHeight;

      while (!done) {
        const { value, done: d } = await reader.read();
        done = d;
        const chunk = decoder.decode(value || new Uint8Array(), { stream: true });
        if (chunk) acc += chunk;
      }
      // replace typing with real content
      const contentDiv = wrap.querySelector('.mt-1');
      contentDiv.innerHTML = `<div class="prose prose-sm max-w-none">${marked.parse(acc)}</div>`;
      wrap.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'mt-1 flex items-center gap-2 text-xs';
      controlsDiv.innerHTML = `
        <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="tts">üîä –ê—É–¥–∏–æ</button>
        <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="vid">üé¨ –í–∏–¥–µ–æ</button>
        <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-act="src">üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏</button>
      `;
      wrap.querySelector('.flex-1').appendChild(controlsDiv);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
      const sourcesDiv = document.createElement('div');
      sourcesDiv.className = 'mt-2 hidden text-xs text-gray-600';
      sourcesDiv.dataset.role = 'sources';
      wrap.querySelector('.flex-1').appendChild(sourcesDiv);
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
      const meta = { sources: state.settings.factCheck ? mockSources(textKeywords(acc)) : [] };
      setupMessageEventHandlers(wrap, acc, meta);
      
      return { text: acc, element: wrap };
    }

    function mockAnswer(question) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
      const hasDocuments = state.docs && state.docs.length > 0;
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∞–Ω–∞–ª–∏–∑ –∏–ª–∏ –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã
      if (hasDocuments && (/–∞–Ω–∞–ª–∏–∑|–ø—Ä–æ–∞–Ω–∞–ª–∏–∑|—Ä–∞–∑–±–µ—Ä|–∏–∑—É—á|—Ä–∞—Å—Å–º–æ—Ç—Ä|—Ä–∏—Å–∫|–∫–ª—é—á–µ–≤|—á—Ç–æ|–≥–¥–µ|–∫–æ–≥–¥–∞|–∫–∞–∫|–ø–æ—á–µ–º—É|–∑–∞—á–µ–º/i.test(question) || question.length < 50)) {
        const doc = state.docs[state.docs.length - 1]; // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
        const content = doc.content || '';
        const wordCount = content.split(/\s+/).length;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ—Ç–≤–µ—Ç
        let analysis = '';
        
        if (/—Ä–∏—Å–∫|–æ–ø–∞—Å–Ω–æ—Å—Ç|–ø—Ä–æ–±–ª–µ–º|–Ω–µ–¥–æ—Å—Ç–∞—Ç/i.test(question)) {
          analysis = `**–ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ "${doc.name}":**\n\n`;
        } else if (/–∫–ª—é—á–µ–≤|–≤–∞–∂–Ω|–æ—Å–Ω–æ–≤–Ω|–≥–ª–∞–≤–Ω/i.test(question)) {
          analysis = `**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞ "${doc.name}":**\n\n`;
        } else if (/—á—Ç–æ|–≥–¥–µ|–∫–æ–≥–¥–∞|–∫–∞–∫|–ø–æ—á–µ–º—É|–∑–∞—á–µ–º/i.test(question)) {
          analysis = `**–û—Ç–≤–µ—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É "${doc.name}":**\n\n`;
        } else {
          analysis = `**–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ "${doc.name}":**\n\n`;
        }
        
        // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        analysis += `üìÑ **–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**\n`;
        analysis += `- –†–∞–∑–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${(doc.size/1024).toFixed(1)} –ö–ë\n`;
        analysis += `- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤: ~${wordCount}\n`;
        analysis += `- –¢–∏–ø —Ñ–∞–π–ª–∞: ${doc.type || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}\n\n`;
        
        // –ê–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        const legalKeywords = {
          '–¥–æ–≥–æ–≤–æ—Ä': /–¥–æ–≥–æ–≤–æ—Ä|—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ|–∫–æ–Ω—Ç—Ä–∞–∫—Ç/gi,
          '—Å—Ç–æ—Ä–æ–Ω—ã': /—Å—Ç–æ—Ä–æ–Ω–∞|—Å—Ç–æ—Ä–æ–Ω[–∞—ã]|–∑–∞–∫–∞–∑—á–∏–∫|–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å|–ø—Ä–æ–¥–∞–≤–µ—Ü|–ø–æ–∫—É–ø–∞—Ç–µ–ª—å/gi,
          '–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞': /–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤|–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç|–¥–æ–ª–∂–µ–Ω|–æ–±—è–∑—É–µ—Ç—Å—è/gi,
          '–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å': /–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç|—à—Ç—Ä–∞—Ñ|–Ω–µ—É—Å—Ç–æ–π–∫|—Å–∞–Ω–∫—Ü/gi,
          '—Å—Ä–æ–∫–∏': /—Å—Ä–æ–∫|–ø–µ—Ä–∏–æ–¥|–≤—Ä–µ–º—è|–¥–∞—Ç–∞|–¥–æ|–ø–æ—Å–ª–µ/gi,
          '–æ–ø–ª–∞—Ç–∞': /–æ–ø–ª–∞—Ç|–ø–ª–∞—Ç–µ–∂|—Å—Ç–æ–∏–º–æ—Å—Ç|—Ü–µ–Ω–∞|—Å—É–º–º/gi,
          '–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å': /–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω|—Ç–∞–π–Ω|—Ä–∞–∑–≥–ª–∞—à–µ–Ω|NDA/gi,
          '–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ': /–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω.*–¥–∞–Ω–Ω|GDPR|–æ–±—Ä–∞–±–æ—Ç–∫.*–¥–∞–Ω–Ω/gi,
          '—Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä': /—Ñ–æ—Ä—Å.–º–∞–∂–æ—Ä|–Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º.*—Å–∏–ª|–æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤/gi
        };
        
        analysis += `üîç **–ö–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞:**\n`;
        let foundElements = 0;
        
        for (const [category, regex] of Object.entries(legalKeywords)) {
          const matches = content.match(regex);
          if (matches && matches.length > 0) {
            analysis += `- ${category}: –Ω–∞–π–¥–µ–Ω–æ ${matches.length} —É–ø–æ–º–∏–Ω–∞–Ω–∏–π\n`;
            foundElements++;
          }
        }
        
        if (foundElements === 0) {
          analysis += `- –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ —è–≤–Ω—ã—Ö —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π\n`;
        }
        
        // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
        if (/—Ä–∏—Å–∫|–æ–ø–∞—Å–Ω–æ—Å—Ç|–ø—Ä–æ–±–ª–µ–º|–Ω–µ–¥–æ—Å—Ç–∞—Ç/i.test(question)) {
          analysis += `\n‚ö†Ô∏è **–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏:**\n`;
          
          if (content.match(/–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω.*–¥–∞–Ω–Ω|GDPR|–æ–±—Ä–∞–±–æ—Ç–∫.*–¥–∞–Ω–Ω/gi)) {
            analysis += `- **–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —è–≤–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è GDPR\n`;
          }
          
          if (content.match(/—à—Ç—Ä–∞—Ñ|–Ω–µ—É—Å—Ç–æ–π–∫|—Å–∞–Ω–∫—Ü/gi)) {
            analysis += `- **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–∏—Å–∫**: –®—Ç—Ä–∞—Ñ–Ω—ã–µ —Å–∞–Ω–∫—Ü–∏–∏ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ—Å—Ç—å\n`;
          }
          
          if (content.match(/—Å—Ä–æ–∫/gi) && !content.match(/–ø—Ä–æ–¥–ª–µ–Ω|–ø—Ä–æ–ª–æ–Ω–≥/gi)) {
            analysis += `- **–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∏—Å–∫**: –ñ–µ—Å—Ç–∫–∏–µ —Å—Ä–æ–∫–∏ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è\n`;
          }
          
          if (!content.match(/—Ñ–æ—Ä—Å.–º–∞–∂–æ—Ä|–Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º.*—Å–∏–ª/gi)) {
            analysis += `- **–ü—Ä–∞–≤–æ–≤–æ–π —Ä–∏—Å–∫**: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—â–∏—Ç–∞ –æ—Ç —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä–Ω—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤\n`;
          }
          
          if (!content.match(/—Ä–∞—Å—Ç–æ—Ä–∂|–æ—Ç–∫–∞–∑/gi)) {
            analysis += `- **–ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ä–∏—Å–∫**: –ù–µ—è—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è\n`;
          }
          
        } else if (/–∫–ª—é—á–µ–≤|–≤–∞–∂–Ω|–æ—Å–Ω–æ–≤–Ω|–≥–ª–∞–≤–Ω/i.test(question)) {
          analysis += `\nüîë **–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è:**\n`;
          
          if (content.match(/—Å—Ç–æ—Ä–æ–Ω–∞|—Å—Ç–æ—Ä–æ–Ω[–∞—ã]/gi)) {
            analysis += `- –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –∏—Ö —Ä–æ–ª–∏\n`;
          }
          
          if (content.match(/–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤|–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç/gi)) {
            analysis += `- –ü—Ä–æ–ø–∏—Å–∞–Ω—ã –≤–∑–∞–∏–º–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —Å—Ç–æ—Ä–æ–Ω\n`;
          }
          
          if (content.match(/–æ–ø–ª–∞—Ç|–ø–ª–∞—Ç–µ–∂|—Å—Ç–æ–∏–º–æ—Å—Ç/gi)) {
            analysis += `- –£–∫–∞–∑–∞–Ω—ã —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å\n`;
          }
          
          if (content.match(/—Å—Ä–æ–∫/gi)) {
            analysis += `- –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è\n`;
          }
          
          if (content.match(/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç/gi)) {
            analysis += `- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –º–µ–∂–¥—É —Å—Ç–æ—Ä–æ–Ω–∞–º–∏\n`;
          }
          
        } else {
          // –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤
          analysis += `\n‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏—è:**\n`;
          
          if (content.match(/–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω.*–¥–∞–Ω–Ω|GDPR|–æ–±—Ä–∞–±–æ—Ç–∫.*–¥–∞–Ω–Ω/gi)) {
            analysis += `- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è GDPR\n`;
          }
          
          if (content.match(/—à—Ç—Ä–∞—Ñ|–Ω–µ—É—Å—Ç–æ–π–∫|—Å–∞–Ω–∫—Ü/gi)) {
            analysis += `- –®—Ç—Ä–∞—Ñ–Ω—ã–µ —Å–∞–Ω–∫—Ü–∏–∏ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ—Å—Ç—å\n`;
          }
          
          if (content.match(/—Å—Ä–æ–∫/gi) && !content.match(/–ø—Ä–æ–¥–ª–µ–Ω|–ø—Ä–æ–ª–æ–Ω–≥/gi)) {
            analysis += `- –°—Ä–æ–∫–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è - —É–±–µ–¥–∏—Ç–µ—Å—å –≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏\n`;
          }
          
          if (!content.match(/—Ñ–æ—Ä—Å.–º–∞–∂–æ—Ä|–Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º.*—Å–∏–ª/gi)) {
            analysis += `- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–≥–æ–≤–æ—Ä–∫–∞ –æ —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä–µ\n`;
          }
        }
        
        analysis += `\nüí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**\n`;
        analysis += `- –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏—Ç–µ –≤—Å–µ —É—Å–ª–æ–≤–∏—è –∏ —Å—Ä–æ–∫–∏\n`;
        analysis += `- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å —é—Ä–∏—Å—Ç–æ–º\n`;
        analysis += `- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ–º—É –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É\n`;
        
        analysis += `\n*–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π.*`;
        
        return analysis;
      }
      
      // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤
      const base = `–í–æ—Ç –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:

1) –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã: –ª–∏—Ü–µ–Ω–∑–∏—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö.
2) –†–∏—Å–∫–∏ –ø–æ GDPR: –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è, –ø—Ä–∞–≤–æ–≤—ã–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è, DPA, —Ç—Ä–∞–Ω—Å–≥—Ä–∞–Ω–∏—á–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞.
3) –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: —É—Ç–æ—á–Ω–∏—Ç—å —Ü–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏, –ø—Ä–æ–ø–∏—Å–∞—Ç—å —Å—Ä–æ–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è, –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ —Å—É–±—ä–µ–∫—Ç–∞.

–≠—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π.`;

      // –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
      if (/—Å—Ä–∞–≤–Ω/i.test(question)) return `–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–≤–∞ —Ñ–∞–π–ª–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°—Ä–∞–≤–Ω–∏—Ç—å". –ú—ã –ø–æ–¥—Å–≤–µ—Ç–∏–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è (—É—Å–ª–æ–≤–∏—è, —Å—Ä–æ–∫–∏, —à—Ç—Ä–∞—Ñ—ã) –∏ –≤—ã–¥–µ–ª–∏–º —Ä–∏—Å–∫–∏.`;
      if (/gdpr/i.test(question)) return `–î–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è GDPR –ø—Ä–æ–≤–µ—Ä—å—Ç–µ: –∑–∞–∫–æ–Ω–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ (Art.6), DPIA –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö —Ä–∏—Å–∫–∞—Ö, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ DPO –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –¥–æ–≥–æ–≤–æ—Ä —Å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º (Art.28).`;
      if (/—á—Ç–æ –µ—Å–ª–∏|what if|–Ω–∞—Ä—É—à—É/i.test(question)) return `–°–º–æ–¥–µ–ª–∏—Ä—É–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞, –≤–æ–∑–º–æ–∂–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã, —Å—É–¥–µ–±–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫, —à–∞–Ω—Å –º–µ–¥–∏–∞—Ü–∏–∏. –ù–∞–∂–º–∏—Ç–µ "What‚Äëif —Å–∏–º—É–ª—è—Ç–æ—Ä" –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã.`;
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–æ –∑–∞–ø—Ä–æ—Å –Ω–µ –ø—Ä–æ –∞–Ω–∞–ª–∏–∑
      if (hasDocuments) {
        return base + `\n\nüìé –£ –≤–∞—Å –∑–∞–≥—Ä—É–∂–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç "${state.docs[state.docs.length - 1].name}". –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –∏–ª–∏ –∑–∞–¥–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é.`;
      }
      
      return base;
    }

    // TTS (fallback: Web Speech API)
    async function tts(text) {
      try {
        // Try backend first
        const resp = await fetch(API.audio, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, voice: state.settings.voice }) });
        if (resp.ok) {
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url); audio.play();
          return;
        }
        throw new Error('No server');
      } catch {
        // Fallback
        if ('speechSynthesis' in window) {
          const utter = new SpeechSynthesisUtterance(text);
          if (state.settings.voice) {
            const voice = speechSynthesis.getVoices().find(v => v.name === state.settings.voice);
            if (voice) utter.voice = voice;
          }
          speechSynthesis.speak(utter);
          toast('–û–∑–≤—É—á–∫–∞ —á–µ—Ä–µ–∑ SpeechSynthesis', 'info');
        } else {
          toast('TTS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
        }
      }
    }

    // Video (fallback: static avatar + audio)
    async function videoExplain(text) {
      try {
        const resp = await fetch(API.video, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, avatar: state.settings.avatar, voice: state.settings.voice }) });
        if (resp.ok) {
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const w = window.open('', '_blank');
          w.document.write(`<video controls autoplay style="width:100%"><source src="${url}" type="video/mp4"></video>`);
          return;
        }
        throw new Error('No server');
      } catch {
        // Fallback: audio + placeholder
        const w = window.open('', '_blank');
        const escaped = text.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        w.document.write(`
          <div style="font-family: system-ui; padding: 16px">
            <div style="display:flex; align-items:center; gap:12px">
              <div style="width:64px;height:64px;border-radius:50%;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-size:28px">üé¨</div>
              <div><b>–í–∏–¥–µ–æ‚Äë–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (–¥–µ–º–æ)</b><div style="color:#6b7280;font-size:12px">–§–æ–ª–ª–±—ç–∫: —Å—Ç–∞—Ç–∏—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ + –∞—É–¥–∏–æ</div></div>
            </div>
            <p style="margin-top:12px;color:#374151">${escaped}</p>
            <audio id="a" controls autoplay></audio>
          </div>
        `);
        // generate audio via TTS fallback
        setTimeout(()=> {
          if (w && 'speechSynthesis' in w) {
            const u = new w.SpeechSynthesisUtterance(text);
            w.speechSynthesis.speak(u);
          }
        }, 300);
      }
    }

    // Voice input (SpeechRecognition fallback)
    async function toggleVoice() {
      try {
        if ('webkitSpeechRecognition' in window) {
          const rec = new webkitSpeechRecognition();
          rec.lang = 'ru-RU';
          rec.interimResults = false;
          rec.onresult = (e) => {
            const t = Array.from(e.results).map(r => r[0].transcript).join(' ');
            $('#chatInput').value = t;
            toast('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –≥–æ–ª–æ—Å–æ–º', 'success');
          };
          rec.onerror = (e) => {
            console.error('Speech recognition error:', e);
            toast('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + (e.error || 'unknown'), 'error');
          };
          rec.start();
          toast('–ì–æ–≤–æ—Ä–∏—Ç–µ...', 'info');
        } else if ('SpeechRecognition' in window) {
          // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API (Firefox –∏ –¥—Ä—É–≥–∏–µ)
          const rec = new SpeechRecognition();
          rec.lang = 'ru-RU';
          rec.interimResults = false;
          rec.onresult = (e) => {
            const t = Array.from(e.results).map(r => r[0].transcript).join(' ');
            $('#chatInput').value = t;
            toast('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –≥–æ–ª–æ—Å–æ–º', 'success');
          };
          rec.onerror = (e) => {
            console.error('Speech recognition error:', e);
            toast('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + (e.error || 'unknown'), 'error');
          };
          rec.start();
          toast('–ì–æ–≤–æ—Ä–∏—Ç–µ...', 'info');
        } else {
          toast('SpeechRecognition –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.', 'error');
          console.error('SpeechRecognition API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        }
      } catch (err) {
        console.error('Error initializing speech recognition:', err);
        toast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏: ' + err.message, 'error');
      }
    }

    // Upload
    function bindDropzone() {
      // –î–æ–±–∞–≤–ª—è–µ–º drag & drop –Ω–∞ –≤—Å—é –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞
      const chatArea = $('#panelChat');
      ['dragenter','dragover'].forEach(ev => chatArea.addEventListener(ev, e => { 
        e.preventDefault(); 
        chatArea.classList.add('bg-blue-50'); 
      }));
      ['dragleave','drop'].forEach(ev => chatArea.addEventListener(ev, e => { 
        e.preventDefault(); 
        chatArea.classList.remove('bg-blue-50'); 
      }));
      chatArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
      $('#fileInput').addEventListener('change', e => handleFiles(e.target.files));
    }

    async function handleFiles(fileList) {
      const files = Array.from(fileList || []);
      for (const file of files) {
        const id = 'd_' + Math.random().toString(36).slice(2,9);
        let content = '';
        try {
          content = await readFileContent(file);
          // optional encrypt
          let payload = content;
          if (state.settings.encryption) {
            payload = await encryptText(content);
          }
          // Try backend upload
          try {
            const form = new FormData();
            form.append('file', file);
            form.append('encrypted', state.settings.encryption ? '1':'0');
            const resp = await fetch(API.upload, { method:'POST', body: form });
            if (!resp.ok) throw new Error('upload fail');
          } catch {}
          state.docs.push({ id, name:file.name, size:file.size, type:file.type || 'text/plain', content, createdAt: Date.now() });
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
          toast(`üìé –§–∞–π–ª "${file.name}" –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∞–Ω–∞–ª–∏–∑—É`, 'success');
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
          const s = getActive() || newSession();
          const fileMessage = {
            role: 'system',
            content: `üìé –§–∞–π–ª "${file.name}" (${(file.size/1024).toFixed(1)} KB) –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.`,
            meta: { fileId: id, fileName: file.name }
          };
          s.messages.push(fileMessage);
          appendMessage('system', fileMessage.content, fileMessage.meta);
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          addFileToUploadedFiles(id, file.name, file.size);
          
        } catch (e) {
          toast(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ "${file.name}": ${e.message}`, 'error');
        }
      }
      saveState();
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      if (state.user) {
        saveUserHistory(state.user.id);
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
    function addFileToUploadedFiles(id, fileName, fileSize) {
      const container = $('#uploadedFiles');
      container.classList.remove('hidden');
      
      const fileElement = document.createElement('div');
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏
      const isDarkMode = document.body.dataset.theme === 'dark';
      fileElement.className = `px-2 py-1 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg flex items-center gap-2 text-xs cursor-pointer hover:opacity-90`;
      fileElement.dataset.fileId = id;
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
      let fileIcon = 'üìÑ';
      if (fileName.toLowerCase().endsWith('.pdf')) fileIcon = 'üìï';
      else if (fileName.toLowerCase().endsWith('.doc') || fileName.toLowerCase().endsWith('.docx')) fileIcon = 'üìò';
      else if (fileName.toLowerCase().endsWith('.txt')) fileIcon = 'üìù';
      
      fileElement.innerHTML = `
        <span>${fileIcon}</span>
        <span class="truncate max-w-[150px]">${fileName}</span>
        <span class="text-gray-500">(${(fileSize/1024).toFixed(1)} KB)</span>
        <button class="ml-1 text-gray-400 hover:text-gray-600" data-action="remove-file">√ó</button>
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
      fileElement.querySelector('[data-action="remove-file"]').addEventListener('click', (e) => {
        e.stopPropagation();
        // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏–∑ state.docs
        state.docs = state.docs.filter(d => d.id !== id);
        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
        fileElement.remove();
        // –ï—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤, —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        if (!state.docs.length) {
          container.classList.add('hidden');
        }
        saveState();
        toast(`–§–∞–π–ª "${fileName}" —É–¥–∞–ª–µ–Ω`, 'info');
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
      fileElement.addEventListener('click', () => {
        const doc = state.docs.find(d => d.id === id);
        if (doc) {
          // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4';
          const isDarkMode = document.body.dataset.theme === 'dark';
          modal.innerHTML = `
            <div class="${isDarkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold">${doc.name}</h3>
                <button class="${isDarkMode ? 'text-gray-300 hover:text-gray-100' : 'text-gray-500 hover:text-gray-700'} text-xl" data-action="close-modal">&times;</button>
              </div>
              <div class="${isDarkMode ? 'border-gray-600' : 'border'} rounded-lg p-4 max-h-[60vh] overflow-auto ${isDarkMode ? 'bg-gray-700' : ''}">
                <pre class="whitespace-pre-wrap text-sm">${escapeHtml(doc.content.slice(0, 10000))}${doc.content.length > 10000 ? '...' : ''}</pre>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
          modal.querySelector('[data-action="close-modal"]').addEventListener('click', () => {
            modal.remove();
          });
          
          // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }
      });
      
      container.appendChild(fileElement);
    }

    async function readFileContent(file) {
      if (file.type === 'application/pdf' && window['pdfjsLib']) {
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        let text = '';
        for (let i=1;i<=pdf.numPages;i++){
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(it => it.str).join(' ') + '\n';
        }
        return text;
      }
      if (file.type.startsWith('text/') || /\.(txt|md|csv|json)$/i.test(file.name)) {
        return await file.text();
      }
      // simple fallback: base64
      const b = await file.arrayBuffer();
      return btoa(String.fromCharCode(...new Uint8Array(b)));
    }

    // AES-GCM demo
    async function getCryptoKey() {
      if (state.crypto.key) return state.crypto.key;
      const key = await crypto.subtle.generateKey({ name:'AES-GCM', length:256 }, true, ['encrypt','decrypt']);
      state.crypto.key = key; return key;
    }
    async function encryptText(plain) {
      const key = await getCryptoKey();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = new TextEncoder().encode(plain);
      const ct = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, enc);
      return JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(ct)) });
    }

    // Compliance checker (mock local)
    async function runComplianceCheck() {
      const txt = $('#complianceText').value || '';
      if (!txt.trim()) return toast('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞', 'error');
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
      const profiles = [];
      if ($('#profileGDPR').checked) profiles.push('GDPR');
      if ($('#profileCCPA').checked) profiles.push('CCPA');
      if ($('#profileHIPAA').checked) profiles.push('HIPAA');
      
      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const res = await fetch(API.compliance, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text: txt, profiles })
        });
        
        if (res.ok) {
          const data = await res.json();
          $('#complianceResult').innerHTML = `
            <div class="p-3 rounded bg-gray-50">
              <div><b>–û—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</b> ${data.score}/100</div>
              <ul class="list-disc pl-5 mt-2">${data.issues.map(i=>`<li>${i}</li>`).join('') || '<li>–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–º–µ—á–∞–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ.</li>'}</ul>
            </div>`;
        } else {
          throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
      } catch (e) {
        // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫
        const issues = [];
        if (!/consent|—Å–æ–≥–ª–∞—Å/i.test(txt)) issues.push('–ù–µ—Ç —è–≤–Ω–æ–≥–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (consent/contract).');
        if (/third.?party|—Ç—Ä–µ—Ç—å/i.test(txt)) issues.push('–£–∫–∞–∑–∞–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è DPA –∏ SCC –ø—Ä–∏ —Ç—Ä–∞–Ω—Å–≥—Ä–∞–Ω–∏—á–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–µ.');
        if (!/retention|—Å—Ä–æ–∫/i.test(txt)) issues.push('–ù–µ —É–∫–∞–∑–∞–Ω —Å—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è.');
        if (!/rights|–ø—Ä–∞–≤–∞ —Å—É–±—ä–µ–∫—Ç–∞/i.test(txt)) issues.push('–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∞–≤ —Å—É–±—ä–µ–∫—Ç–∞ (–¥–æ—Å—Ç—É–ø, —É–¥–∞–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–Ω–æ—Å).');
        const score = Math.max(0, 100 - issues.length*20);
        $('#complianceResult').innerHTML = `
          <div class="p-3 rounded bg-gray-50">
            <div><b>–û—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</b> ${score}/100</div>
            <ul class="list-disc pl-5 mt-2">${issues.map(i=>`<li>${i}</li>`).join('') || '<li>–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–º–µ—á–∞–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)</li>'}</ul>
          </div>`;
        toast('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑', 'info');
      }
    }
    async function suggestComplianceFixes() {
      const txt = $('#complianceText').value || '';
      if (!txt.trim()) return toast('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞', 'error');
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
      const profiles = [];
      if ($('#profileGDPR').checked) profiles.push('GDPR');
      if ($('#profileCCPA').checked) profiles.push('CCPA');
      if ($('#profileHIPAA').checked) profiles.push('HIPAA');
      
      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const res = await fetch(API.compliance, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text: txt, profiles })
        });
        
        if (res.ok) {
          const data = await res.json();
          const suggestionsList = data.suggestions.map(s => `- ${s}`).join('\n');
          $('#complianceResult').innerHTML += `<div class="mt-2 p-3 rounded bg-green-50"><b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é:</b><pre class="whitespace-pre-wrap text-sm">${suggestionsList}</pre></div>`;
        } else {
          throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
      } catch (e) {
        // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫
        const suggestions = `
- –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∞–≤–æ–≤–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (Art.6 GDPR) –∏ —Ü–µ–ª–∏.
- –£–∫–∞–∂–∏—Ç–µ —Å—Ä–æ–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∏—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
- –û–ø–∏—à–∏—Ç–µ –ø—Ä–∞–≤–∞ —Å—É–±—ä–µ–∫—Ç–∞ –∏ –ø–æ—Ä—è–¥–æ–∫ –∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
- –ó–∞–∫–ª—é—á–∏—Ç–µ DPA —Å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞–º–∏ –∏ —É–∫–∞–∂–∏—Ç–µ –º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Art.28).
- –î–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤–Ω–µ –ï–≠–ó ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç–µ SCC/–∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å.`;
        $('#complianceResult').innerHTML += `<div class="mt-2 p-3 rounded bg-green-50"><b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é:</b><pre class="whitespace-pre-wrap text-sm">${suggestions}</pre></div>`;
        toast('–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', 'info');
      }
    }

    // Functions for document comparison
    async function handleCompareFileUpload(fileInput, docType) {
      const file = fileInput.files[0];
      if (!file) return;
      
      console.log(`–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç ${docType}:`, file.name, file.size, 'bytes');
      
      try {
        const content = await readFileContent(file);
        console.log(`–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ${docType} –∑–∞–≥—Ä—É–∂–µ–Ω–æ:`, content.length, '—Å–∏–º–≤–æ–ª–æ–≤');
        
        const doc = {
          id: 'compare_' + docType + '_' + Math.random().toString(36).slice(2,9),
          name: file.name,
          size: file.size,
          type: file.type || 'text/plain',
          content: content,
          createdAt: Date.now()
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        state.compare[docType] = doc;
        console.log(`–î–æ–∫—É–º–µ–Ω—Ç ${docType} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ state.compare:`, state.compare);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        updateCompareDocumentPreview(docType, doc);
        updateCompareButton();
        
        toast(`–î–æ–∫—É–º–µ–Ω—Ç ${docType.toUpperCase()} –∑–∞–≥—Ä—É–∂–µ–Ω: ${file.name}`, 'success');
        
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ${docType}:`, error);
        toast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ${docType.toUpperCase()}: ${error.message}`, 'error');
      }
    }
    
    function updateCompareDocumentPreview(docType, doc) {
      const previewDiv = $(`#doc${docType.toUpperCase()}Preview`);
      const nameDiv = $(`#doc${docType.toUpperCase()}Name`);
      const sizeDiv = $(`#doc${docType.toUpperCase()}Size`);
      const statusDiv = $(`#doc${docType.toUpperCase()}Status`);
      const uploadBtn = $(`#uploadDoc${docType.toUpperCase()}`);
      
      if (previewDiv && nameDiv && sizeDiv && statusDiv && uploadBtn) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        previewDiv.classList.remove('hidden');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ
        nameDiv.textContent = doc.name;
        sizeDiv.textContent = `${(doc.size/1024).toFixed(1)} KB`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        statusDiv.textContent = '–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω';
        statusDiv.classList.remove('text-gray-500');
        statusDiv.classList.add('text-green-600', 'font-bold');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è
        statusDiv.classList.add('animate-pulse');
        setTimeout(() => {
          statusDiv.classList.remove('animate-pulse');
        }, 2000);
        
        // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ "–ó–∞–º–µ–Ω–∏—Ç—å"
        uploadBtn.innerHTML = `<span>üîÑ</span> –ó–∞–º–µ–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç ${docType.toUpperCase()}`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        const contentPreview = document.createElement('div');
        contentPreview.className = 'mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600 max-h-20 overflow-y-auto';
        contentPreview.textContent = doc.content.substring(0, 200) + (doc.content.length > 200 ? '...' : '');
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        const existingPreview = previewDiv.querySelector('.bg-gray-50');
        if (existingPreview) {
          existingPreview.remove();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        previewDiv.appendChild(contentPreview);
      }
    }
    
    function updateCompareButton() {
      const runCompareBtn = $('#runCompare');
      const compareStatus = $('#compareStatus');
      
      if (runCompareBtn && compareStatus) {
        const hasDocA = state.compare.docA !== null;
        const hasDocB = state.compare.docB !== null;
        
        if (hasDocA && hasDocB) {
          runCompareBtn.disabled = false;
          runCompareBtn.classList.remove('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
          compareStatus.textContent = '–ì–æ—Ç–æ–≤–æ –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é';
          compareStatus.classList.remove('text-gray-500', 'text-red-500');
          compareStatus.classList.add('text-green-600', 'font-bold');
        } else if (hasDocA || hasDocB) {
          runCompareBtn.disabled = true;
          runCompareBtn.classList.add('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
          compareStatus.textContent = hasDocA ? '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç B' : '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç A';
          compareStatus.classList.remove('text-green-600', 'text-red-500');
          compareStatus.classList.add('text-gray-500');
        } else {
          runCompareBtn.disabled = true;
          runCompareBtn.classList.add('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
          compareStatus.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è';
          compareStatus.classList.remove('text-green-600', 'text-gray-500');
          compareStatus.classList.add('text-red-500');
        }
      }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    function initCompare() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
      if (state.compare.docA) {
        updateCompareDocumentPreview('a', state.compare.docA);
      }
      
      if (state.compare.docB) {
        updateCompareDocumentPreview('b', state.compare.docB);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
      updateCompareButton();
    }

    // Contract compare
    async function runCompare() {
      console.log('–ó–∞–ø—É—Å–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤');
      console.log('state.compare:', state.compare);
      
      const a = state.compare.docA;
      const b = state.compare.docB;
      
      console.log('–î–æ–∫—É–º–µ–Ω—Ç A:', a ? a.name : '–Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
      console.log('–î–æ–∫—É–º–µ–Ω—Ç B:', b ? b.name : '–Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
      
      if (!a || !b) {
        console.log('–û–¥–∏–Ω –∏–ª–∏ –æ–±–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');
        return toast('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 'error');
      }
      
      console.log('–ù–∞—á–∏–Ω–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:', a.name, 'vs', b.name);
      $('#compareResult').innerHTML = `<div class="p-3 rounded bg-gray-50 text-center">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...</div>`;
      
      try {
        // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API
        const res = await fetch(API.compare, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ doc_a: a.content, doc_b: b.content })
        });
        
        if (res.ok) {
          const data = await res.json();
          
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          let html = '';
          data.diffs.forEach(diff => {
            if (diff.type === 'added') {
              html += `<div class="bg-green-50 py-1 px-2 border-l-4 border-green-500">${escapeHtml(diff.text)}</div>`;
            } else if (diff.type === 'removed') {
              html += `<div class="bg-red-50 py-1 px-2 border-l-4 border-red-500 line-through">${escapeHtml(diff.text)}</div>`;
            } else {
              html += `<div class="py-1 px-2">${escapeHtml(diff.text)}</div>`;
            }
          });
          
          $('#compareResult').innerHTML = `
            <div class="text-xs text-gray-500 mb-1">${a.name} ‚Üî ${b.name}</div>
            <div class="p-3 border rounded-lg max-h-64 overflow-auto">${html}</div>
            <div class="mt-2 text-xs text-gray-600">${data.summary}</div>
          `;
          return;
        }
      } catch (e) {
        console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ');
      }
      
      // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
      const result = compareDocumentsLocally(a, b);
      $('#compareResult').innerHTML = result;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      if (state.user) {
        saveUserHistory(state.user.id);
      }
      
      toast('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤', 'info');
    }
    
    function compareDocumentsLocally(docA, docB) {
      const contentA = docA.content || '';
      const contentB = docB.content || '';
      
      // –†–∞–∑–±–∏–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
      const linesA = contentA.split('\n').filter(line => line.trim());
      const linesB = contentB.split('\n').filter(line => line.trim());
      
      // –ù–∞—Ö–æ–¥–∏–º –æ–±—â–∏–µ –∏ —Ä–∞–∑–ª–∏—á–∞—é—â–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏
      const commonLines = [];
      const onlyInA = [];
      const onlyInB = [];
      
      // –ü—Ä–æ—Å—Ç–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
      linesA.forEach((lineA, indexA) => {
        const foundInB = linesB.findIndex(lineB => 
          lineA.toLowerCase().trim() === lineB.toLowerCase().trim()
        );
        
        if (foundInB !== -1) {
          commonLines.push({ text: lineA, type: 'common' });
        } else {
          onlyInA.push({ text: lineA, type: 'removed', line: indexA + 1 });
        }
      });
      
      linesB.forEach((lineB, indexB) => {
        const foundInA = linesA.findIndex(lineA => 
          lineA.toLowerCase().trim() === lineB.toLowerCase().trim()
        );
        
        if (foundInA === -1) {
          onlyInB.push({ text: lineB, type: 'added', line: indexB + 1 });
        }
      });
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      let html = `
        <div class="text-xs text-gray-500 mb-3 flex items-center justify-between">
          <span>${docA.name} ‚Üî ${docB.name}</span>
          <span class="text-xs">–ù–∞–π–¥–µ–Ω–æ —Ä–∞–∑–ª–∏—á–∏–π: ${onlyInA.length + onlyInB.length}</span>
        </div>
      `;
      
      if (onlyInA.length === 0 && onlyInB.length === 0) {
        html += `
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg text-center">
            <div class="text-green-700 font-medium">‚úÖ –î–æ–∫—É–º–µ–Ω—Ç—ã –∏–¥–µ–Ω—Ç–∏—á–Ω—ã</div>
            <div class="text-green-600 text-sm mt-1">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞–µ—Ç</div>
          </div>
        `;
      } else {
        html += `<div class="space-y-2 max-h-64 overflow-auto">`;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–∏—è
        if (onlyInA.length > 0) {
          html += `
            <div class="border-l-4 border-red-400 pl-3">
              <div class="text-sm font-medium text-red-700 mb-2">–¢–æ–ª—å–∫–æ –≤ "${docA.name}" (${onlyInA.length} —Å—Ç—Ä–æ–∫):</div>
          `;
          
          onlyInA.forEach(item => {
            html += `<div class="bg-red-50 py-1 px-2 rounded text-sm mb-1">
              <span class="text-red-600 line-through">${escapeHtml(item.text)}</span>
            </div>`;
          });
          
          html += `</div>`;
        }
        
        if (onlyInB.length > 0) {
          html += `
            <div class="border-l-4 border-green-400 pl-3">
              <div class="text-sm font-medium text-green-700 mb-2">–¢–æ–ª—å–∫–æ –≤ "${docB.name}" (${onlyInB.length} —Å—Ç—Ä–æ–∫):</div>
          `;
          
          onlyInB.forEach(item => {
            html += `<div class="bg-green-50 py-1 px-2 rounded text-sm mb-1">
              <span class="text-green-600">${escapeHtml(item.text)}</span>
            </div>`;
          });
          
          html += `</div>`;
        }
        
        html += `</div>`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        html += `
          <div class="mt-3 p-3 bg-gray-50 rounded-lg text-xs">
            <div class="font-medium text-gray-700 mb-1">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:</div>
            <div class="grid grid-cols-3 gap-2 text-center">
              <div>
                <div class="text-gray-500">–û–±—â–∏–µ —Å—Ç—Ä–æ–∫–∏</div>
                <div class="font-medium text-gray-700">${commonLines.length}</div>
              </div>
              <div>
                <div class="text-red-500">–£–¥–∞–ª–µ–Ω–æ</div>
                <div class="font-medium text-red-600">${onlyInA.length}</div>
              </div>
              <div>
                <div class="text-green-500">–î–æ–±–∞–≤–ª–µ–Ω–æ</div>
                <div class="font-medium text-green-600">${onlyInB.length}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      return html;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]) }

    // What-if Mermaid
    async function genFlow() {
      const q = ($('#whatIfInput').value || '').trim();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –¥–µ–ª–∞–µ–º –≤–∏–¥–∏–º—ã–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      const wrap = $('#flowWrap');
      wrap.classList.remove('hidden');
      wrap.innerHTML = '<div class="p-3 rounded bg-gray-50 text-center">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã...</div>';
      
      try {
        // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API
        if (q) {
          const res = await fetch(API.whatif, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ question: q })
          });
          
          if (res.ok) {
            const data = await res.json();
            
            // –°–æ–∑–¥–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
            const el = document.createElement('div');
            el.className = 'mermaid';
            el.textContent = data.diagram;
            wrap.innerHTML = '';
            wrap.appendChild(el);
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –¥–∏–∞–≥—Ä–∞–º–º—É
            if (window.mermaid && typeof window.mermaid.run === 'function') {
              try {
                await window.mermaid.run({ nodes:[el] });
              } catch (mermaidErr) {
                console.error('Mermaid rendering error:', mermaidErr);
                el.textContent = "–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã: " + mermaidErr.message;
              }
            } else {
              console.error('Mermaid library not properly loaded');
              el.textContent = "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Mermaid –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É.";
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'mt-3 text-sm p-3 bg-gray-50 rounded';
            explanationDiv.textContent = data.explanation;
            wrap.appendChild(explanationDiv);
            
            return;
          }
        }
        
        // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫
        throw new Error('–ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é');
      } catch (e) {
        // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫
        const diagram = q ? makeMermaidFromQuestion(q) : `flowchart TD
A[–ù–∞—Ä—É—à–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞] --> B{–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞?}
B -->|–î–∞| C[–ü–æ–ø—ã—Ç–∫–∞ —É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è]
B -->|–ù–µ—Ç| D[–†–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ/—à—Ç—Ä–∞—Ñ]
C --> E{–°–æ–≥–ª–∞—Å–∏–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ?}
E -->|–î–∞| F[–î–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ]
E -->|–ù–µ—Ç| D
D --> G[–°—É–¥–µ–±–Ω–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞]`;
        
        const id = 'm_' + Math.random().toString(36).slice(2,8);
        const el = document.createElement('div');
        el.className = 'mermaid';
        el.textContent = diagram;
        wrap.innerHTML = '';
        wrap.appendChild(el);
        if (window.mermaid && typeof window.mermaid.run === 'function') {
          try {
            await window.mermaid.run({ nodes:[el] });
          } catch (mermaidErr) {
            console.error('Mermaid rendering error:', mermaidErr);
            el.textContent = "–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã: " + mermaidErr.message;
          }
        } else {
          console.error('Mermaid library not properly loaded');
          el.textContent = "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Mermaid –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É.";
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ
        const explanationDiv = document.createElement('div');
        explanationDiv.className = 'mt-3 text-sm p-3 bg-gray-50 rounded';
        explanationDiv.textContent = '–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏ (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º).';
        wrap.appendChild(explanationDiv);
        
        if (q) toast('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è', 'info');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if (state.user) {
          saveUserHistory(state.user.id);
        }
      }
    }
    
    function makeMermaidFromQuestion(q) {
      // –º–∏–Ω–∏-—à–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä
      if (/gdpr|–ø–µ—Ä—Å–æ–Ω–∞–ª/i.test(q)) {
        return `flowchart TD
A[–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö] --> B{–ï—Å—Ç—å –æ—Å–Ω–æ–≤–∞–Ω–∏–µ?}
B -->|Consent/Contract| C[–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–∏ –∏ –æ–±—ä–µ–º]
B -->|–ù–µ—Ç| H[–ó–∞–ø—Ä–µ—Ç/–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å]
C --> D{–ü–µ—Ä–µ–¥–∞—á–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –ï–≠–ó?}
D -->|–î–∞| E[SCC/–ê–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å]
D -->|–ù–µ—Ç| F[–õ–æ–∫–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞]
C --> G[–ü—Ä–∞–≤–∞ —Å—É–±—ä–µ–∫—Ç–∞, —Å—Ä–æ–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è]`;
      }
      return `flowchart TD
A[–°—Ü–µ–Ω–∞—Ä–∏–π: ${q.slice(0,28)}] --> B{–†–∏—Å–∫?}
B -->|–í—ã—Å–æ–∫–∏–π| C[–≠—Å–∫–∞–ª–∞—Ü–∏—è/–Æ—Ä.–æ—Ü–µ–Ω–∫–∞]
B -->|–ù–∏–∑–∫–∏–π| D[–£—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ]
C --> E[–ú–µ—Ä—ã —Å–Ω–∏–∂–µ–Ω–∏—è —Ä–∏—Å–∫–∞]
D --> F[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥]`;
    }

    // Auth (demo)
    function showLoginModal(show=true){ 
      $('#loginModal').classList.toggle('hidden', !show); 
      $('#loginModal').classList.toggle('flex', show); 
      
      if (show) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        $('#loginFormContainer').classList.remove('hidden');
        $('#registerFormContainer').classList.add('hidden');
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º
        $('#loginForm').reset();
        $('#registerForm').reset();
      }
    }
    
    // Demo modal
    function showDemoModal(show=true){
      const modal = $('#demoModal');
      modal.classList.toggle('hidden', !show); 
      modal.classList.toggle('flex', show);
      
      if (show) {
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const handleClickOutside = function(e) {
          if (e.target === modal) {
            showDemoModal(false);
            modal.removeEventListener('click', handleClickOutside);
          }
        };
        modal.addEventListener('click', handleClickOutside);
      }
    }
    // –°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    function loginDemo() {
      const email = $('#loginEmail').value.trim();
      const password = $('#loginPassword').value;
      
      if (!email || !password) {
        toast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const users = JSON.parse(localStorage.getItem('explainer_users') || '[]');
      const user = users.find(u => u.email === email && u.password === password);
      
      if (user) {
        // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
        state.user = {
          id: user.id,
          email: user.email,
          name: user.name,
          createdAt: user.createdAt
        };
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        loadUserHistory(user.id);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateUserInterface();
      showLoginModal(false);
        toast(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.name}!`, 'success');
      saveState();
      showApp();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        setTimeout(() => {
          showWelcomeMessage(user.name);
        }, 500);
      } else {
        toast('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
      }
    }
    
    function registerUser() {
      const name = $('#registerName').value.trim();
      const email = $('#registerEmail').value.trim();
      const password = $('#registerPassword').value;
      const passwordConfirm = $('#registerPasswordConfirm').value;
      
      if (!name || !email || !password || !passwordConfirm) {
        toast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
      }
      
      if (password.length < 6) {
        toast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }
      
      if (password !== passwordConfirm) {
        toast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email
      const users = JSON.parse(localStorage.getItem('explainer_users') || '[]');
      if (users.find(u => u.email === email)) {
        toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const newUser = {
        id: generateUserId(),
        name: name,
        email: email,
        password: password,
        createdAt: new Date().toISOString()
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫
      users.push(newUser);
      localStorage.setItem('explainer_users', JSON.stringify(users));
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º
      state.user = {
        id: newUser.id,
        email: newUser.email,
        name: newUser.name,
        createdAt: newUser.createdAt
      };
      
      // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      initializeUserHistory(newUser.id);
      
              // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateUserInterface();
        showLoginModal(false);
        toast(`–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${name}!`, 'success');
        saveState();
        showApp();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        setTimeout(() => {
          showWelcomeMessage(name);
        }, 500);
    }
    
    function logoutDemo() {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
      if (state.user) {
        saveUserHistory(state.user.id);
      }
      
      state.user = null;
      saveState();
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
      $('#loginBtn').classList.remove('hidden');
      $('#userMenu').classList.add('hidden');
      $('#userEmail').textContent = '';
      $('#userInitial').textContent = '';
      
      toast('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
      showLanding();
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function generateUserId() {
      return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    function updateUserInterface() {
      if (state.user) {
        $('#userEmail').textContent = state.user.email;
        $('#userInitial').textContent = state.user.name.charAt(0).toUpperCase();
        $('#loginBtn').classList.add('hidden');
        $('#userMenu').classList.remove('hidden');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        const userInfo = document.createElement('div');
        userInfo.className = 'text-xs text-gray-500 mt-1';
        userInfo.textContent = `–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${new Date(state.user.createdAt).toLocaleDateString()}`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–¥ email –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
        const userEmail = $('#userEmail');
        if (userEmail && !userEmail.nextElementSibling?.classList.contains('text-xs')) {
          userEmail.parentNode.appendChild(userInfo);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º tooltip –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
        const userAvatar = $('#userInitial');
        if (userAvatar) {
          userAvatar.title = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${state.user.name}\nEmail: ${state.user.email}\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${new Date(state.user.createdAt).toLocaleDateString()}`;
        }
      }
    }
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function initializeUserHistory(userId) {
      const userHistory = {
        sessions: [],
        documents: [],
        translations: [],
        comparisons: [],
        whatIfScenarios: []
      };
      localStorage.setItem(`explainer_history_${userId}`, JSON.stringify(userHistory));
    }
    
    function saveUserHistory(userId) {
      if (!userId) return;
      
      const userHistory = {
        sessions: state.sessions || [],
        documents: state.docs || [],
        translations: state.translateFile ? [state.translateFile] : [],
        comparisons: state.compare || {},
        whatIfScenarios: state.whatIfFile ? [state.whatIfFile] : []
      };
      
      localStorage.setItem(`explainer_history_${userId}`, JSON.stringify(userHistory));
    }
    
    function loadUserHistory(userId) {
      if (!userId) return;
      
      const userHistory = JSON.parse(localStorage.getItem(`explainer_history_${userId}`) || '{}');
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏–∏
      if (userHistory.sessions && userHistory.sessions.length > 0) {
        state.sessions = userHistory.sessions;
        state.activeSessionId = userHistory.sessions[0].id;
      }
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
      if (userHistory.documents && userHistory.documents.length > 0) {
        state.docs = userHistory.documents;
      }
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ
      if (userHistory.translations && userHistory.translations.length > 0) {
        state.translateFile = userHistory.translations[0];
      }
      
      if (userHistory.comparisons) {
        state.compare = userHistory.comparisons;
      }
      
      if (userHistory.whatIfScenarios && userHistory.whatIfScenarios.length > 0) {
        state.whatIfFile = userHistory.whatIfScenarios[0];
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö
    function autoSaveUserHistory() {
      if (state.user) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º debounce –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —á–∞—Å—Ç—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
        clearTimeout(state.autoSaveTimeout);
        state.autoSaveTimeout = setTimeout(() => {
          saveUserHistory(state.user.id);
        }, 1000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function clearUserHistory(userId) {
      if (!userId) return;
      
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?\n\n‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!\n\nüí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–Ω–∞—á–∞–ª–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–Ω–æ–ø–∫–æ–π üì•')) {
                  localStorage.removeItem(`explainer_history_${userId}`);
          toast('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞! –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ. üóëÔ∏è –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º. üí° –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É üì§ (–∏–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏).', 'info');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        state.sessions = [];
        state.docs = [];
        state.translateFile = null;
        state.compare = {};
        state.whatIfFile = null;
        
                  // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
          newSession('–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è');
          renderSessions();
          renderChat();
          renderUploadedFiles();
          saveState();
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
          setTimeout(() => {
            toast('üí° –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –∫–Ω–æ–ø–∫–æ–π üì§ –∏–ª–∏ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞! üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º. üìù –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è. üîí –í–∞—à–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞—â–∏—â–µ–Ω—ã. üéØ –ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞! üí¨ –ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. üîé –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤ —Å–∞–π–¥–±–∞—Ä–µ. üåü –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –≤–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è.', 'info');
          }, 1000);
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function showUserStats() {
      if (!state.user) return;
      
      const userHistory = JSON.parse(localStorage.getItem(`explainer_history_${state.user.id}`) || '{}');
      
      let stats = `
        <div class="p-4 bg-white rounded-lg shadow-lg max-w-md">
          <h3 class="text-lg font-semibold mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span>–ò–º—è:</span>
              <span class="font-medium">${state.user.name}</span>
            </div>
            <div class="flex justify-between">
              <span>Email:</span>
              <span class="font-medium">${state.user.email}</span>
            </div>
            <div class="flex justify-between">
              <span>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
              <span class="font-medium">${new Date(state.user.createdAt).toLocaleDateString()}</span>
            </div>
            <div class="flex justify-between">
              <span>–°–µ—Å—Å–∏–π —á–∞—Ç–∞:</span>
              <span class="font-medium">${userHistory.sessions?.length || 0}</span>
            </div>
            <div class="flex justify-between">
              <span>–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:</span>
              <span class="font-medium">${userHistory.documents?.length || 0}</span>
            </div>
            <div class="flex justify-between">
              <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤:</span>
              <span class="font-medium">${userHistory.translations?.length || 0}</span>
            </div>
            <div class="flex justify-between">
              <span>–°—Ä–∞–≤–Ω–µ–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:</span>
              <span class="font-medium">${userHistory.comparisons?.docA ? 1 : 0}</span>
            </div>
            <div class="flex justify-between">
              <span>What-if —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:</span>
              <span class="font-medium">${userHistory.whatIfScenarios?.length || 0}</span>
            </div>
          </div>
        </div>
      `;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-md w-full">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <button class="text-gray-400 hover:text-gray-600 text-xl" data-action="close-modal">&times;</button>
          </div>
          ${stats}
          <div class="mt-4 flex justify-between items-center">
            <div class="text-xs text-gray-500">
              üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ üì• –∏ üì§ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏
            </div>
            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm" data-action="close-modal">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      `;
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è
      modal.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target === modal) {
          modal.remove();
        }
      });
      
      document.body.appendChild(modal);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function exportUserHistory() {
      if (!state.user) return;
      
      const userHistory = JSON.parse(localStorage.getItem(`explainer_history_${state.user.id}`) || '{}');
      
      // –°–æ–∑–¥–∞–µ–º JSON —Ñ–∞–π–ª —Å –∏—Å—Ç–æ—Ä–∏–µ–π
      const historyData = {
        user: {
          name: state.user.name,
          email: state.user.email,
          createdAt: state.user.createdAt
        },
        exportDate: new Date().toISOString(),
        history: userHistory
      };
      
      const blob = new Blob([JSON.stringify(historyData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `explainer-history-${state.user.name}-${new Date().toISOString().slice(0,10)}.json`;
      a.title = '–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏';
      a.click();
      URL.revokeObjectURL(url);
      
      toast('–ò—Å—Ç–æ—Ä–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞! –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ø–∞–ø–∫—É "–ó–∞–≥—Ä—É–∑–∫–∏". üíæ –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥—Ä—É–≥–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä. üìÅ –ò–º—è —Ñ–∞–π–ª–∞: ' + `explainer-history-${state.user.name}-${new Date().toISOString().slice(0,10)}.json` + ' üìä –†–∞–∑–º–µ—Ä: ' + (blob.size / 1024).toFixed(1) + ' KB. üîí –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ. üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ. üîÑ –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É üì§. üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º. üéØ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é! üóëÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É üóëÔ∏è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏. üí° –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö. üéâ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!', 'success');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function importUserHistory() {
      if (!state.user) return;
      
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.title = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ (.json) –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedData = JSON.parse(e.target.result);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (!importedData.history || !importedData.user) {
              toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –∏—Å—Ç–æ—Ä–∏–∏', 'error');
              return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏—Å—Ç–æ—Ä–∏—è —Ç–æ–≥–æ –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (importedData.user.email !== state.user.email) {
              toast('–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é', 'error');
              return;
            }
            
            // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é
            const userHistory = importedData.history;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏–∏
            if (userHistory.sessions && userHistory.sessions.length > 0) {
              state.sessions = userHistory.sessions;
              state.activeSessionId = userHistory.sessions[0].id;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
            if (userHistory.documents && userHistory.documents.length > 0) {
              state.docs = userHistory.documents;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ
            if (userHistory.translations && userHistory.translations.length > 0) {
              state.translateFile = userHistory.translations[0];
            }
            
            if (userHistory.comparisons) {
              state.compare = userHistory.comparisons;
            }
            
            if (userHistory.whatIfScenarios && userHistory.whatIfScenarios.length > 0) {
              state.whatIfFile = userHistory.whatIfScenarios[0];
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            renderSessions();
            renderChat();
            renderUploadedFiles();
            saveState();
            
            toast('–ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º. üéâ –í—Å–µ —Å–µ—Å—Å–∏–∏, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. üìä –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ' + (userHistory.sessions?.length || 0) + ' —Å–µ—Å—Å–∏–π, ' + (userHistory.documents?.length || 0) + ' –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. üíæ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ' + (file.size / 1024).toFixed(1) + ' KB. üîì –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. üí° –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. üîí –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è. üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ! üéØ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã. üí¨ –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤ —Å–∞–π–¥–±–∞—Ä–µ. üîç –í—Å–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. üéä –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'success');
            
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            toast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏—Å—Ç–æ—Ä–∏–∏', 'error');
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showWelcomeMessage(userName) {
      const welcomeModal = document.createElement('div');
      welcomeModal.className = 'fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4';
      welcomeModal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-md w-full text-center">
          <div class="text-6xl mb-4">üéâ</div>
          <h3 class="text-xl font-semibold mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ explAiner!</h3>
          <p class="text-gray-600 mb-4">–ü—Ä–∏–≤–µ—Ç, <strong>${userName}</strong>! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º —Å–∏—Å—Ç–µ–º—ã.</p>
          
          <div class="space-y-3 text-left text-sm">
            <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
              <span class="text-xl">üí¨</span>
              <div>
                <div class="font-medium">–ò–ò –ß–∞—Ç</div>
                <div class="text-gray-500">–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
              <span class="text-xl">üîé</span>
              <div>
                <div class="font-medium">–ö–æ–º–ø–ª–∞–µ–Ω—Å-—á–µ–∫–µ—Ä</div>
                <div class="text-gray-500">–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-amber-50 rounded-lg">
              <span class="text-xl">‚öñÔ∏è</span>
              <div>
                <div class="font-medium">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
                <div class="text-gray-500">–ù–∞—Ö–æ–¥–∏—Ç–µ —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-cyan-50 rounded-lg">
              <span class="text-xl">üåê</span>
              <div>
                <div class="font-medium">–ü–µ—Ä–µ–≤–æ–¥—ã</div>
                <div class="text-gray-500">–ü–µ—Ä–µ–≤–æ–¥–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —Ä–∞–∑–Ω—ã–µ —è–∑—ã–∫–∏</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-purple-50 rounded-lg">
              <span class="text-xl">üß≠</span>
              <div>
                <div class="font-medium">What-if —Å–∏–º—É–ª—è—Ç–æ—Ä</div>
                <div class="text-gray-500">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏</div>
              </div>
            </div>
          </div>
          
          <div class="mt-6">
            <div class="text-xs text-gray-500 mb-3">
              üíæ –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–π—Å—Ç–≤–∏–∏
            </div>
            <button class="px-6 py-3 bg-gradient-to-r from-brand-500 to-brand-600 text-white rounded-lg font-medium hover:from-brand-600 hover:to-brand-700 transition-all duration-300" data-action="close-welcome">
              –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É! üöÄ
            </button>
          </div>
        </div>
      `;
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è
      welcomeModal.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-welcome' || e.target === welcomeModal) {
          welcomeModal.remove();
        }
      });
      
      document.body.appendChild(welcomeModal);
    }

    // App/Landing toggle
    function showApp() { 
      $('#landing').classList.add('hidden'); 
      $('#app').classList.remove('hidden'); 
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —á–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
      togglePanel('panelChat');
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Å–∞–π–¥–±–∞—Ä–µ
      setTimeout(() => updateSidebarButtons(), 50);
    }
    function showLanding() { 
      $('#app').classList.add('hidden'); 
      $('#landing').classList.remove('hidden'); 
    }

    // –≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞
    function exportChat() {
      const s = getActive();
      if (!s || !s.messages.length) {
        toast('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
        return;
      }
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∞—Ç –≤ –ø—Ä–æ—Å—Ç–æ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
      let content = `${s.title}\n\n`;
      content += `–î–∞—Ç–∞: ${new Date(s.createdAt).toLocaleString()}\n\n`;
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –ø–∞—Ä–∞–º (–≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)
      for (let i = 0; i < s.messages.length; i += 2) {
        const userMsg = s.messages[i];
        const aiMsg = s.messages[i+1];
        
        if (userMsg && userMsg.role === 'user') {
          content += `–í–æ–ø—Ä–æ—Å: ${userMsg.content.trim()}\n\n`;
          
          if (aiMsg && aiMsg.role === 'assistant') {
            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç markdown-—Ä–∞–∑–º–µ—Ç–∫–∏
            let aiResponse = aiMsg.content.trim();
            // –£–¥–∞–ª—è–µ–º markdown –∑–∞–≥–æ–ª–æ–≤–∫–∏
            aiResponse = aiResponse.replace(/#{1,6}\s+/g, '');
            // –£–¥–∞–ª—è–µ–º markdown –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –∫—É—Ä—Å–∏–≤
            aiResponse = aiResponse.replace(/\*\*/g, '').replace(/\*/g, '');
            // –£–¥–∞–ª—è–µ–º markdown —Å—Å—ã–ª–∫–∏, –æ—Å—Ç–∞–≤–ª—è—è —Ç–µ–∫—Å—Ç
            aiResponse = aiResponse.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
            
            content += `–û—Ç–≤–µ—Ç: ${aiResponse}\n\n`;
          }
          
          content += `----------------------------------------\n\n`;
        }
      }
      
      // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `explainer-chat-${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      toast('–ß–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
    }
    
    // –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    async function analyzeDocument(doc, analysisType = 'general') {
      if (!doc || !doc.content) {
        toast('–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞', 'error');
        return;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞
      togglePanel('panelDocAnalysis');
      $('#docAnalysisName').textContent = doc.name;
      $('#docAnalysisResult').innerHTML = '<div class="p-3 rounded bg-gray-50 text-center">–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞...</div>';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–∏–ø–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
      $$('#panelDocAnalysis button').forEach(btn => {
        btn.classList.remove('bg-brand-500', 'text-white');
        btn.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-900');
      });
      $(`#analysis${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)}`).classList.add('bg-brand-500', 'text-white');
      $(`#analysis${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)}`).classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-900');
      
      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const res = await fetch(API.analyze, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            document_id: doc.id,
            document_text: doc.content,
            analysis_type: analysisType
          })
        });
        
        if (res.ok) {
          const data = await res.json();
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          let html = `<div class="p-4 border rounded-lg">
            <div class="font-medium mb-2">–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</div>
            <p class="text-sm">${data.summary}</p>
            
            <div class="font-medium mt-4 mb-2">–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã</div>
            <ul class="list-disc pl-5 text-sm">
              ${data.key_points.map(p => `<li>${p}</li>`).join('')}
            </ul>`;
          
          if (data.risks && data.risks.length > 0) {
            html += `
            <div class="font-medium mt-4 mb-2 text-red-600">–†–∏—Å–∫–∏</div>
            <ul class="list-disc pl-5 text-sm">
              ${data.risks.map(r => `<li>${r}</li>`).join('')}
            </ul>`;
          }
          
          if (data.recommendations && data.recommendations.length > 0) {
            html += `
            <div class="font-medium mt-4 mb-2 text-green-600">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
            <ul class="list-disc pl-5 text-sm">
              ${data.recommendations.map(r => `<li>${r}</li>`).join('')}
            </ul>`;
          }
          
          html += '</div>';
          $('#docAnalysisResult').innerHTML = html;
        } else {
          throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
      } catch (e) {
        // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫
        const html = `<div class="p-4 border rounded-lg">
          <div class="font-medium mb-2">–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</div>
          <p class="text-sm">–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ ${doc.content.split(/\s+/).length} —Å–ª–æ–≤ –∏ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.</p>
          
          <div class="font-medium mt-4 mb-2">–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã</div>
          <ul class="list-disc pl-5 text-sm">
            <li>–û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –∏—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</li>
            <li>–£–∫–∞–∑–∞–Ω—ã —Å—Ä–æ–∫–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã</li>
            <li>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è –æ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</li>
          </ul>
          
          <div class="font-medium mt-4 mb-2 text-gray-500">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div>
          <p class="text-sm text-gray-500">–≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ API —Å LLM.</p>
        </div>`;
        
        $('#docAnalysisResult').innerHTML = html;
        toast('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑', 'info');
      }
    }
    
    // Events
    function bindEvents() {
      // Add null checks for all element references
      const langToggle = $('#langToggle');
      if (langToggle) {
        langToggle.onclick = () => {
        const newLang = state.settings.language === 'ru' ? 'en' : 'ru';
        updateLanguage(newLang);
        toast(newLang === 'ru' ? '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫' : 'English language', 'success');
      };
      }
      
      const themeToggle = $('#themeToggle');
      if (themeToggle) themeToggle.onclick = () => setTheme(document.body.dataset.theme === 'light' ? 'dark':'light');
      
      const loginBtn = $('#loginBtn');
      if (loginBtn) loginBtn.onclick = () => showLoginModal(true);
      
      const loginCancel = $('#loginCancel');
      if (loginCancel) loginCancel.onclick = () => showLoginModal(false);
      
      const loginSubmit = $('#loginSubmit');
      if (loginSubmit) loginSubmit.onclick = loginDemo;
      
      const logoutBtn = $('#logoutBtn');
      if (logoutBtn) logoutBtn.onclick = logoutDemo;
      
      const playDemo = $('#playDemo');
      if (playDemo) playDemo.onclick = () => { showDemoModal(); };
      
      const newChatBtn = $('#newChatBtn');
      if (newChatBtn) newChatBtn.onclick = () => newSession(t('new_session') + ' ' + (state.sessions.length+1));
      
      const sendBtn = $('#sendBtn');
      if (sendBtn) sendBtn.onclick = sendMessage;
      
      const stopBtn = $('#stopBtn');
      if (stopBtn) stopBtn.onclick = () => { toast('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'); };
      
      const chatInput = $('#chatInput');
      if (chatInput) chatInput.addEventListener('keydown', (e) => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
      
      const attachBtn = $('#attachBtn');
      if (attachBtn) attachBtn.onclick = () => $('#fileInput').click();
      
      const voiceBtn = $('#voiceBtn');
      if (voiceBtn) voiceBtn.onclick = toggleVoice;
      
      const exportChatBtn = $('#exportChat');
      if (exportChatBtn) exportChatBtn.onclick = exportChat;
      
      const encryptToggle = $('#encryptToggle');
      if (encryptToggle) encryptToggle.onchange = (e) => { state.settings.encryption = e.target.checked; saveState(); toast(state.settings.encryption?'–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ':'–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ'); };
      bindDropzone();

      // toggles
      const toggleJargon = $('#toggleJargon');
      if (toggleJargon) toggleJargon.onchange = (e)=>{ state.settings.explainJargon = e.target.checked; saveState(); renderChat(); };
      
      const toggleFact = $('#toggleFact');
      if (toggleFact) toggleFact.onchange = (e)=>{ state.settings.factCheck = e.target.checked; saveState(); };
      
      const toggleLang = $('#toggleLang');
      if (toggleLang) toggleLang.onchange = (e)=>{ state.settings.multilingual = e.target.checked; saveState(); };

      // Tools panels
      const toolChat = $('#toolChat');
      if (toolChat) toolChat.onclick = ()=> togglePanel('panelChat');
      
      const toolCompliance = $('#toolCompliance');
      if (toolCompliance) toolCompliance.onclick = ()=> togglePanel('panelCompliance');
      
      const toolCompare = $('#toolCompare');
      if (toolCompare) toolCompare.onclick = ()=> togglePanel('panelCompare');
      
      const toolTranslate = $('#toolTranslate');
      if (toolTranslate) toolTranslate.onclick = ()=> togglePanel('panelTranslate');
      
      const toolWhatIf = $('#toolWhatIf');
      if (toolWhatIf) toolWhatIf.onclick = ()=> togglePanel('panelWhatIf');
      
      const toolSettings = $('#toolSettings');
      if (toolSettings) toolSettings.onclick = ()=> togglePanel('panelSettings');
      
      // Demo modal
      const demoClose = $('#demoClose');
      if (demoClose) demoClose.onclick = () => showDemoModal(false);
      
      const startDemo = $('#startDemo');
      if (startDemo) startDemo.onclick = () => { 
        showDemoModal(false); 
        setTimeout(() => showLoginModal(true), 100); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
      };
      
      const watchVideoDemo = $('#watchVideoDemo');
      if (watchVideoDemo) watchVideoDemo.onclick = () => {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
        const w = window.open('', '_blank');
        w.document.write(`
          <div style="font-family: system-ui; padding: 16px; max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 16px;">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π explAiner</h2>
            <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <p style="margin-top: 16px; color: #6b7280;">–í–∏–¥–µ–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã explAiner: –ò–ò —á–∞—Ç, –∫–æ–º–ø–ª–∞–µ–Ω—Å-—á–µ–∫–µ—Ä, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∏ what-if —Å–∏–º—É–ª—è—Ç–æ—Ä.</p>
          </div>
        `);
        toast('–û—Ç–∫—Ä—ã—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ', 'success');
      };
      
      // Logo button - clicking on explAiner logo returns to main page
      const logoBtn = $('#logoBtn');
      if (logoBtn) logoBtn.onclick = () => {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        showLanding();
        toast('–í–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É', 'info');
      };
      
      // Document analysis
      const analysisGeneral = $('#analysisGeneral');
      if (analysisGeneral) analysisGeneral.onclick = () => {
        const docAnalysisName = $('#docAnalysisName');
        if (docAnalysisName) {
          const doc = state.docs.find(d => d.name === docAnalysisName.textContent);
        if (doc) analyzeDocument(doc, 'general');
        }
      };
      
      const analysisLegal = $('#analysisLegal');
      if (analysisLegal) analysisLegal.onclick = () => {
        const docAnalysisName = $('#docAnalysisName');
        if (docAnalysisName) {
          const doc = state.docs.find(d => d.name === docAnalysisName.textContent);
        if (doc) analyzeDocument(doc, 'legal');
        }
      };
      
      const analysisRisks = $('#analysisRisks');
      if (analysisRisks) analysisRisks.onclick = () => {
        const docAnalysisName = $('#docAnalysisName');
        if (docAnalysisName) {
          const doc = state.docs.find(d => d.name === docAnalysisName.textContent);
        if (doc) analyzeDocument(doc, 'risks');
        }
      };
      
      const runCompliance = $('#runCompliance');
      if (runCompliance) runCompliance.onclick = runComplianceCheck;
      
      const fixCompliance = $('#fixCompliance');
      if (fixCompliance) fixCompliance.onclick = suggestComplianceFixes;
      
      const runCompareBtn = $('#runCompare');
      if (runCompareBtn) runCompareBtn.onclick = runCompare;
      
      const genFlowBtn = $('#genFlow');
      if (genFlowBtn) genFlowBtn.onclick = genFlow;

      // Document comparison upload handlers
      const uploadDocA = $('#uploadDocA');
      if (uploadDocA) uploadDocA.onclick = () => $('#fileInputA').click();
      
      const uploadDocB = $('#uploadDocB');
      if (uploadDocB) uploadDocB.onclick = () => $('#fileInputB').click();
      
      const fileInputA = $('#fileInputA');
      if (fileInputA) fileInputA.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleCompareFileUpload(e.target, 'docA');
        }
      });
      
      const fileInputB = $('#fileInputB');
      if (fileInputB) fileInputB.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleCompareFileUpload(e.target, 'docB');
        }
      });

      // settings
      if ($('#modelSelect')) $('#modelSelect').onchange = (e)=>{ 
        state.settings.model = e.target.value; 
        const modelLabel = $('#modelLabel');
        if (modelLabel) modelLabel.textContent = e.target.value;
        saveState(); 
      };
      if ($('#voiceSelect')) $('#voiceSelect').onchange = (e)=>{ state.settings.voice = e.target.value; saveState(); };
      if ($('#avatarSelect')) $('#avatarSelect').onchange = (e)=>{ state.settings.avatar = e.target.value; saveState(); };
      if ($('#ragSource')) $('#ragSource').onchange = (e)=>{ 
        state.settings.rag = e.target.value; 
        const ragStatus = $('#ragStatus');
        if (ragStatus) ragStatus.textContent = e.target.value;
        saveState(); 
      };

      // fill voices
      const populateVoices = () => {
        const sel = $('#voiceSelect'); 
        if (!sel) return;
        
      // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
      bindAuthEvents();
        
        const vs = speechSynthesis.getVoices();
        sel.innerHTML = '<option value="">–ë—Ä–∞—É–∑–µ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>' + vs.map(v=>`<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
        if (!state.settings.voice) return;
        const has = vs.find(v => v.name===state.settings.voice); if (!has) state.settings.voice = '';
      };
      if ('speechSynthesis' in window) {
        speechSynthesis.onvoiceschanged = populateVoices;
        setTimeout(populateVoices, 300);
      }
      
      // Translation panel events
      const uploadTranslateBtn = $('#uploadTranslateBtn');
      const translateFileInput = $('#translateFileInput');
      if (uploadTranslateBtn && translateFileInput) {
        uploadTranslateBtn.onclick = () => translateFileInput.click();
        translateFileInput.onchange = handleTranslateFileUpload;
      }
      
      const removeTranslateFile = $('#removeTranslateFile');
      if (removeTranslateFile) {
        removeTranslateFile.onclick = () => {
          $('#translateFilePreview').classList.add('hidden');
          $('#startTranslation').disabled = true;
          translateFileInput.value = '';
        };
      }
      
      const startTranslation = $('#startTranslation');
      if (startTranslation) startTranslation.onclick = performTranslation;
      
      const downloadTranslated = $('#downloadTranslated');
      if (downloadTranslated) downloadTranslated.onclick = downloadTranslatedFile;
      
      const copyTranslated = $('#copyTranslated');
      if (copyTranslated) copyTranslated.onclick = copyTranslatedText;
      
      // What-if panel file upload
      const uploadWhatIfBtn = $('#uploadWhatIfBtn');
      const whatIfFileInput = $('#whatIfFileInput');
      if (uploadWhatIfBtn && whatIfFileInput) {
        uploadWhatIfBtn.onclick = () => whatIfFileInput.click();
        whatIfFileInput.onchange = handleWhatIfFileUpload;
      }
      
      const removeWhatIfFile = $('#removeWhatIfFile');
      if (removeWhatIfFile) {
        removeWhatIfFile.onclick = () => {
          $('#whatIfFilePreview').classList.add('hidden');
          whatIfFileInput.value = '';
        };
      }
    }

    function togglePanel(id) {
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏
      ['panelChat','panelCompliance','panelCompare','panelTranslate','panelWhatIf','panelSettings','panelDocAnalysis'].forEach(i => {
        const panel = document.getElementById(i);
        if (panel) {
          panel.classList.add('hidden');
        }
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –ø–∞–Ω–µ–ª—å
      const targetPanel = document.getElementById(id);
      if (targetPanel) {
        targetPanel.classList.remove('hidden');
      }
      
      // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–∞–Ω–µ–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
      if (id === 'panelCompare') {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        initCompare();
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ —Å–∞–π–¥–±–∞—Ä–µ
      updateSidebarButtons();
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
      setTimeout(() => {
        updateSidebarButtons();
      }, 50);
    }
    
    function updateSidebarButtons() {
      const buttons = ['toolChat', 'toolCompliance', 'toolCompare', 'toolTranslate', 'toolWhatIf', 'toolSettings'];
      const panels = ['panelChat', 'panelCompliance', 'panelCompare', 'panelTranslate', 'panelWhatIf', 'panelSettings'];
      
      buttons.forEach((btnId, index) => {
        const btn = document.getElementById(btnId);
        const panel = document.getElementById(panels[index]);
        
        if (btn && panel) {
          // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π
          btn.classList.remove(
            // –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Å–∏–Ω–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç)
            'bg-gradient-to-r', 'from-brand-500', 'to-brand-600', 'text-white',
            // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            'bg-gray-100', 'bg-gray-200', 'text-gray-700',
            'hover:from-gray-200', 'hover:to-gray-300',
            'hover:from-emerald-100', 'hover:to-emerald-200', 'hover:text-emerald-800',
            'hover:from-amber-100', 'hover:to-amber-200', 'hover:text-amber-800',
            'hover:from-cyan-100', 'hover:to-cyan-200', 'hover:text-cyan-800',
            'hover:from-purple-100', 'hover:to-purple-200', 'hover:text-purple-800',
            'hover:from-blue-100', 'hover:to-blue-200', 'hover:text-blue-800'
          );
          
          if (!panel.classList.contains('hidden')) {
            // –ê–∫—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å - —Å–∏–Ω–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
            btn.classList.add('bg-gradient-to-r', 'from-brand-500', 'to-brand-600', 'text-white');
          } else {
            // –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞
            btn.classList.add('bg-gradient-to-r', 'from-gray-100', 'to-gray-200', 'text-gray-700');
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ hover —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            switch (btnId) {
              case 'toolCompliance':
                btn.classList.add('hover:from-emerald-100', 'hover:to-emerald-200', 'hover:text-emerald-800');
                break;
              case 'toolCompare':
                btn.classList.add('hover:from-amber-100', 'hover:to-amber-200', 'hover:text-amber-800');
                break;
              case 'toolTranslate':
                btn.classList.add('hover:from-cyan-100', 'hover:to-cyan-200', 'hover:text-cyan-800');
                break;
              case 'toolWhatIf':
                btn.classList.add('hover:from-purple-100', 'hover:to-purple-200', 'hover:text-purple-800');
                break;
              case 'toolSettings':
                btn.classList.add('hover:from-blue-100', 'hover:to-blue-200', 'hover:text-blue-800');
                break;
              default:
                btn.classList.add('hover:from-gray-200', 'hover:to-gray-300');
                break;
            }
          }
        }
      });
    }

    // –ù–æ–≤—ã–µ event listeners –¥–ª—è —Ñ–æ—Ä–º –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function bindAuthEvents() {
      // –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞
      const loginForm = $('#loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', (e) => {
          e.preventDefault();
          loginDemo();
        });
      }

      // –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      const registerForm = $('#registerForm');
      if (registerForm) {
        registerForm.addEventListener('submit', (e) => {
          e.preventDefault();
          registerUser();
        });
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞–º–∏
      const showRegister = $('#showRegister');
      if (showRegister) {
        showRegister.onclick = () => {
          $('#loginFormContainer').classList.add('hidden');
          $('#registerFormContainer').classList.remove('hidden');
          $('#registerFormContainer').classList.add('slide-in-right');
        };
      }

      const showLogin = $('#showLogin');
      if (showLogin) {
        showLogin.onclick = () => {
          $('#registerFormContainer').classList.add('hidden');
          $('#loginFormContainer').classList.remove('hidden');
          $('#loginFormContainer').classList.add('slide-in-left');
        };
      }

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      const loginClose = $('#loginClose');
      if (loginClose) {
        loginClose.onclick = () => showLoginModal(false);
      }

      const registerClose = $('#registerClose');
      if (registerClose) {
        registerClose.onclick = () => showLoginModal(false);
      }
      
      // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
      const clearHistoryBtn = $('#clearHistoryBtn');
      if (clearHistoryBtn) {
        clearHistoryBtn.onclick = () => {
          if (state.user) {
            clearUserHistory(state.user.id);
          }
        };
      }
      
      // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      const showStatsBtn = $('#showStatsBtn');
      if (showStatsBtn) {
        showStatsBtn.onclick = () => {
          if (state.user) {
            showUserStats();
          }
        };
      }
      
      // –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏
      const exportHistoryBtn = $('#exportHistoryBtn');
      if (exportHistoryBtn) {
        exportHistoryBtn.onclick = () => {
          if (state.user) {
            exportUserHistory();
          }
        };
      }
      
      // –ö–Ω–æ–ø–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏
      const importHistoryBtn = $('#importHistoryBtn');
      if (importHistoryBtn) {
        importHistoryBtn.onclick = () => {
          if (state.user) {
            importUserHistory();
          }
        };
      }
    }

    // Demo script
    async function demoScript() {
      const s = getActive() || newSession('–î–µ–º–æ');
      const demoQs = [
        '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —ç—Ç–æ NDA —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º GDPR?',
        '–°—Ä–∞–≤–Ω–∏—Ç–µ –¥–≤–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ SaaS: –∫–∞–∫–æ–π —Ä–∏—Å–∫ –ø–æ SLA –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏?',
        '–ß—Ç–æ –µ—Å–ª–∏ —è –Ω–∞—Ä—É—à—É –ø—É–Ω–∫—Ç –æ –Ω–µ–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤?'
      ];
      for (const q of demoQs) {
        $('#chatInput').value = q;
        await sendMessage();
        await sleep(600);
      }
      $('#whatIfInput').value = '–ß—Ç–æ –µ—Å–ª–∏ —è –Ω–∞—Ä—É—à—É –ø—É–Ω–∫—Ç –æ –Ω–µ–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤?';
      genFlow();
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function renderUploadedFiles() {
      const container = $('#uploadedFiles');
      if (state.docs && state.docs.length > 0) {
        container.classList.remove('hidden');
        container.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        state.docs.forEach(doc => {
          addFileToUploadedFiles(doc.id, doc.name, doc.size);
        });
      } else {
        container.classList.add('hidden');
      }
    }

    // Init
    function init() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º marked –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
      if (window.marked && typeof window.marked.setOptions === 'function') {
        window.marked.setOptions({
          breaks: true, // –í–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
          gfm: true,    // GitHub Flavored Markdown
        });
      }
      
      loadState();
      setTheme(document.body.dataset.theme || 'light');
      bindEvents();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (state.user) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        updateUserInterface();
      if (!state.sessions.length) newSession(t('new_session'));
      updateLanguage(state.settings.language || 'ru');
      renderSessions();
      renderChat();
        renderUploadedFiles();
        showApp(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      } else {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if (!state.sessions.length) newSession(t('new_session'));
        updateLanguage(state.settings.language || 'ru');
        renderSessions();
        renderChat();
        renderUploadedFiles();
        showLanding(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–µ–Ω–¥–∏–Ω–≥
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        const savedUsers = JSON.parse(localStorage.getItem('explainer_users') || '[]');
        if (savedUsers.length > 0) {
          console.log(`–ù–∞–π–¥–µ–Ω–æ ${savedUsers.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
        }
      }
    }

    // Translation functions
    function handleTranslateFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:', file.name, file.size, 'bytes');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', e.target.result.length, '—Å–∏–º–≤–æ–ª–æ–≤');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞
        $('#translateFileName').textContent = file.name;
        $('#translateFileSize').textContent = formatFileSize(file.size);
        $('#translateFilePreview').classList.remove('hidden');
        $('#startTranslation').disabled = false;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
        state.translateFile = {
          name: file.name,
          size: file.size,
          content: e.target.result,
          type: file.type
        };
        
        toast(`–§–∞–π–ª "${file.name}" –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞`, 'success');
      };
      
      reader.readAsText(file);
    }
    
    async function performTranslation() {
      if (!state.translateFile) {
        toast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞', 'error');
        return;
      }
      
      const sourceLanguage = $('#sourceLanguage').value;
      const targetLanguage = $('#targetLanguage').value;
      const preserveFormatting = $('#preserveFormatting').checked;
      const legalTerms = $('#legalTerms').checked;
      
      console.log('–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ Google Translate:', {
        source: sourceLanguage,
        target: targetLanguage,
        preserve: preserveFormatting,
        legal: legalTerms
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–≤–æ–¥–∞
      $('#translationStatus').classList.remove('hidden');
      $('#translationResult').classList.add('hidden');
      $('#translationProgress').style.width = '10%';
      
      try {
        // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        const originalText = state.translateFile.content;
        const textChunks = splitTextForTranslation(originalText, preserveFormatting);
        
        $('#translationProgress').style.width = '20%';
        
        // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å —á–µ—Ä–µ–∑ Google Translate
        const translatedChunks = [];
        for (let i = 0; i < textChunks.length; i++) {
          const chunk = textChunks[i];
          if (chunk.trim()) {
            const translatedChunk = await translateWithGoogle(chunk, sourceLanguage, targetLanguage);
            translatedChunks.push(translatedChunk);
          } else {
            translatedChunks.push(chunk); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          const progress = 20 + (i + 1) / textChunks.length * 70;
          $('#translationProgress').style.width = progress + '%';
        }
        
        $('#translationProgress').style.width = '95%';
        
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏
        const translatedText = translatedChunks.join('');
        
        // –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è
        const finalText = legalTerms ? 
          applyLegalTerminologyCorrections(translatedText, targetLanguage) : 
          translatedText;
        
        $('#translationProgress').style.width = '100%';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        setTimeout(() => {
          completeTranslation(finalText);
        }, 300);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
        $('#translationStatus').classList.add('hidden');
        
        // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –µ—Å–ª–∏ Google Translate –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        toast('Google Translate –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥', 'warning');
        setTimeout(() => {
          const fallbackTranslation = translateLocally(state.translateFile.content, sourceLanguage, targetLanguage, legalTerms);
          completeTranslation(fallbackTranslation);
        }, 500);
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–±–∏–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞—Å—Ç–∏
    function splitTextForTranslation(text, preserveFormatting) {
      if (preserveFormatting) {
        // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ —Å—Ç—Ä–æ–∫–∞–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        return text.split('\n');
      } else {
        // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        return text.split(/[.!?]+/).filter(chunk => chunk.trim().length > 0);
      }
    }
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ —á–µ—Ä–µ–∑ Google Translate
    async function translateWithGoogle(text, sourceLang, targetLang) {
      // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ Google Translate
      
      // –ú–µ—Ç–æ–¥ 1: –ü—Ä—è–º–æ–π API (–º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è CORS)
      try {
        const url = 'https://translate.googleapis.com/translate_a/single';
        const params = new URLSearchParams({
          client: 'gtx',
          sl: sourceLang === 'auto' ? 'auto' : sourceLang,
          tl: targetLang,
          dt: 't',
          q: text
        });
        
        const response = await fetch(`${url}?${params}`, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞ Google Translate
        let translatedText = '';
        if (data && data[0]) {
          for (const item of data[0]) {
            if (item[0]) {
              translatedText += item[0];
            }
          }
        }
        
        return translatedText || text;
        
      } catch (error) {
        console.error('–ü—Ä—è–º–æ–π Google Translate API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
        
        // –ú–µ—Ç–æ–¥ 2: –ß–µ—Ä–µ–∑ CORS-–ø—Ä–æ–∫—Å–∏
        try {
          return await translateWithCORSProxy(text, sourceLang, targetLang);
        } catch (proxyError) {
          console.error('CORS-–ø—Ä–æ–∫—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', proxyError);
          
          // –ú–µ—Ç–æ–¥ 3: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å
          return await translateWithAlternativeService(text, sourceLang, targetLang);
        }
      }
    }
    
    // –ü–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ CORS-–ø—Ä–æ–∫—Å–∏
    async function translateWithCORSProxy(text, sourceLang, targetLang) {
      const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
      const targetUrl = 'https://translate.googleapis.com/translate_a/single';
      const params = new URLSearchParams({
        client: 'gtx',
        sl: sourceLang === 'auto' ? 'auto' : sourceLang,
        tl: targetLang,
        dt: 't',
        q: text
      });
      
      const response = await fetch(`${proxyUrl}${targetUrl}?${params}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      if (!response.ok) {
        throw new Error(`CORS proxy error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      let translatedText = '';
      if (data && data[0]) {
        for (const item of data[0]) {
          if (item[0]) {
            translatedText += item[0];
          }
        }
      }
      
      return translatedText || text;
    }
    
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–≤–æ–¥–∞ (MyMemory API)
    async function translateWithAlternativeService(text, sourceLang, targetLang) {
      try {
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.responseStatus === 200 && data.responseData) {
          return data.responseData.translatedText;
        } else {
          throw new Error('MyMemory API error');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ API:', error);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –≤—Å–µ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
        return text;
      }
    }
    
    // –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
    function applyLegalTerminologyCorrections(text, targetLang) {
      let corrected = text;
      
      if (targetLang === 'ru') {
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
        corrected = corrected
          .replace(/–∫–æ–Ω—Ç—Ä–∞–∫—Ç/gi, '–¥–æ–≥–æ–≤–æ—Ä')
          .replace(/–∫–ª–∏–µ–Ω—Ç/gi, '–∑–∞–∫–∞–∑—á–∏–∫')
          .replace(/–ø–æ—Å—Ç–∞–≤—â–∏–∫ —É—Å–ª—É–≥/gi, '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å')
          .replace(/—é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ/gi, '—é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ')
          .replace(/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å/gi, '–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å');
      } else if (targetLang === 'en') {
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
        corrected = corrected
          .replace(/agreement/gi, 'contract')
          .replace(/customer/gi, 'client')
          .replace(/provider/gi, 'contractor')
          .replace(/legal entity/gi, 'legal entity')
          .replace(/liability/gi, 'responsibility');
      }
      
      return corrected;
    }
    
    // –õ–æ–∫–∞–ª—å–Ω—ã–π fallback –ø–µ—Ä–µ–≤–æ–¥ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π)
    function translateLocally(text, sourceLang, targetLang, legalTerms) {
      if (targetLang === 'en' && sourceLang !== 'en') {
        return translateToEnglish(text, legalTerms);
      } else if (targetLang === 'ru' && sourceLang !== 'ru') {
        return translateToRussian(text, legalTerms);
      } else {
        return text;
      }
    }
    
    function completeTranslation(translatedText) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
      state.translatedContent = translatedText;
      
      // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      $('#translationStatus').classList.add('hidden');
      $('#translationResult').classList.remove('hidden');
      $('#translatedContent').innerHTML = translatedText.replace(/\n/g, '<br>');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      if (state.user) {
        saveUserHistory(state.user.id);
      }
      
      toast('–ü–µ—Ä–µ–≤–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω —á–µ—Ä–µ–∑ Google Translate!', 'success');
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤
    function translateToEnglish(text, legalTerms) {
      // –°–∏–º—É–ª—è—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line; // –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–º–∏
        
        // –ë–∞–∑–æ–≤—ã–µ –∑–∞–º–µ–Ω—ã –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
        let translated = line
          .replace(/–¥–æ–≥–æ–≤–æ—Ä|–∫–æ–Ω—Ç—Ä–∞–∫—Ç/gi, 'contract')
          .replace(/—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ/gi, 'agreement')
          .replace(/—Å—Ç–æ—Ä–æ–Ω[–∞—ã]/gi, 'party/parties')
          .replace(/–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤[–∞–æ]/gi, 'obligation')
          .replace(/—É—Å–ª—É–≥[–∞–∏]/gi, 'service')
          .replace(/—Ä–∞–±–æ—Ç[–∞—ã]/gi, 'work')
          .replace(/–ø–ª–∞—Ç–µ–∂/gi, 'payment')
          .replace(/—Å—Ä–æ–∫/gi, 'term')
          .replace(/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å/gi, 'responsibility')
          .replace(/–Ω–∞—Ä—É—à–µ–Ω–∏–µ/gi, 'violation')
          .replace(/–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ/gi, 'performance')
          .replace(/–¥–æ–∫—É–º–µ–Ω—Ç/gi, 'document')
          .replace(/–ø—É–Ω–∫—Ç/gi, 'clause')
          .replace(/—Å—Ç–∞—Ç—å—è/gi, 'article')
          .replace(/—Ä–∞–∑–¥–µ–ª/gi, 'section')
          .replace(/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/gi, 'appendix')
          .replace(/–ø–æ–¥–ø–∏—Å—å/gi, 'signature')
          .replace(/–¥–∞—Ç–∞/gi, 'date')
          .replace(/–º–µ—Å—Ç–æ/gi, 'place')
          .replace(/–∫–æ–º–ø–∞–Ω–∏—è/gi, 'company')
          .replace(/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/gi, 'organization')
          .replace(/–ª–∏—Ü–æ/gi, 'person')
          .replace(/–ø—Ä–∞–≤–æ/gi, 'right')
          .replace(/–∑–∞–∫–æ–Ω/gi, 'law')
          .replace(/—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ/gi, 'requirement')
          .replace(/—É—Å–ª–æ–≤–∏–µ/gi, 'condition')
          .replace(/–ø–æ–ª–æ–∂–µ–Ω–∏–µ/gi, 'provision');
          
        if (legalTerms) {
          translated = translated
            .replace(/–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å/gi, 'in accordance with')
            .replace(/–Ω–∞—Å—Ç–æ—è—â–∏–º –¥–æ–≥–æ–≤–æ—Ä–æ–º/gi, 'this contract')
            .replace(/–≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É/gi, 'comes into effect')
            .replace(/–ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è/gi, 'terminates')
            .replace(/–∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ/gi, 'has the right')
            .replace(/–æ–±—è–∑—É–µ—Ç—Å—è/gi, 'undertakes')
            .replace(/–Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å/gi, 'bears responsibility');
        }
        
        return translated;
      });
      
      return translatedLines.join('\n');
    }
    
    function translateToRussian(text, legalTerms) {
      // –°–∏–º—É–ª—è—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line; // –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–º–∏
        
        // –ë–∞–∑–æ–≤—ã–µ –∑–∞–º–µ–Ω—ã –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–∞
        let translated = line
          .replace(/contract/gi, '–¥–æ–≥–æ–≤–æ—Ä')
          .replace(/agreement/gi, '—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ')
          .replace(/party|parties/gi, '—Å—Ç–æ—Ä–æ–Ω–∞/—Å—Ç–æ—Ä–æ–Ω—ã')
          .replace(/obligation/gi, '–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ')
          .replace(/service/gi, '—É—Å–ª—É–≥–∞')
          .replace(/work/gi, '—Ä–∞–±–æ—Ç–∞')
          .replace(/payment/gi, '–ø–ª–∞—Ç–µ–∂')
          .replace(/term/gi, '—Å—Ä–æ–∫')
          .replace(/responsibility/gi, '–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å')
          .replace(/violation/gi, '–Ω–∞—Ä—É—à–µ–Ω–∏–µ')
          .replace(/performance/gi, '–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ')
          .replace(/document/gi, '–¥–æ–∫—É–º–µ–Ω—Ç')
          .replace(/clause/gi, '–ø—É–Ω–∫—Ç')
          .replace(/article/gi, '—Å—Ç–∞—Ç—å—è')
          .replace(/section/gi, '—Ä–∞–∑–¥–µ–ª')
          .replace(/appendix/gi, '–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ')
          .replace(/signature/gi, '–ø–æ–¥–ø–∏—Å—å')
          .replace(/date/gi, '–¥–∞—Ç–∞')
          .replace(/place/gi, '–º–µ—Å—Ç–æ')
          .replace(/company/gi, '–∫–æ–º–ø–∞–Ω–∏—è')
          .replace(/organization/gi, '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è')
          .replace(/person/gi, '–ª–∏—Ü–æ')
          .replace(/right/gi, '–ø—Ä–∞–≤–æ')
          .replace(/law/gi, '–∑–∞–∫–æ–Ω')
          .replace(/requirement/gi, '—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ')
          .replace(/condition/gi, '—É—Å–ª–æ–≤–∏–µ')
          .replace(/provision/gi, '–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
          
        if (legalTerms) {
          translated = translated
            .replace(/in accordance with/gi, '–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å')
            .replace(/this contract/gi, '–Ω–∞—Å—Ç–æ—è—â–∏–º –¥–æ–≥–æ–≤–æ—Ä–æ–º')
            .replace(/comes into effect/gi, '–≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É')
            .replace(/terminates/gi, '–ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è')
            .replace(/has the right/gi, '–∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ')
            .replace(/undertakes/gi, '–æ–±—è–∑—É–µ—Ç—Å—è')
            .replace(/bears responsibility/gi, '–Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å');
        }
        
        return translated;
      });
      
      return translatedLines.join('\n');
    }
    
    function translateToChinese(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        return `[‰∏≠ÊñáÁøªËØë] ${line}`;
      });
      return translatedLines.join('\n');
    }
    
    function translateToSpanish(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        let translated = line
          .replace(/contract/gi, 'contrato')
          .replace(/agreement/gi, 'acuerdo')
          .replace(/document/gi, 'documento')
          .replace(/company/gi, 'empresa')
          .replace(/service/gi, 'servicio');
        return translated;
      });
      return translatedLines.join('\n');
    }
    
    function translateToFrench(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        let translated = line
          .replace(/contract/gi, 'contrat')
          .replace(/agreement/gi, 'accord')
          .replace(/document/gi, 'document')
          .replace(/company/gi, 'entreprise')
          .replace(/service/gi, 'service');
        return translated;
      });
      return translatedLines.join('\n');
    }
    
    function translateToGerman(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        let translated = line
          .replace(/contract/gi, 'Vertrag')
          .replace(/agreement/gi, 'Vereinbarung')
          .replace(/document/gi, 'Dokument')
          .replace(/company/gi, 'Unternehmen')
          .replace(/service/gi, 'Dienstleistung');
        return translated;
      });
      return translatedLines.join('\n');
    }
    
    function translateToJapanese(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        return `[Êó•Êú¨Ë™ûÁøªË®≥] ${line}`;
      });
      return translatedLines.join('\n');
    }
    
    function translateToKorean(text, legalTerms) {
      const lines = text.split('\n');
      const translatedLines = lines.map(line => {
        if (!line.trim()) return line;
        return `[ÌïúÍµ≠Ïñ¥ Î≤àÏó≠] ${line}`;
      });
      return translatedLines.join('\n');
    }
    
    function downloadTranslatedFile() {
      if (!state.translatedContent) {
        toast('–ù–µ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'error');
        return;
      }
      
      const blob = new Blob([state.translatedContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'translated_' + (state.translateFile?.name || 'document.txt');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      toast('–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω', 'success');
    }
    
    function copyTranslatedText() {
      if (!state.translatedContent) {
        toast('–ù–µ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
        return;
      }
      
      navigator.clipboard.writeText(state.translatedContent).then(() => {
        toast('–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
      }).catch(() => {
        toast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞', 'error');
      });
    }
    
    // What-if file upload functions
    function handleWhatIfFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ñ–∞–π–ª –¥–ª—è What-if:', file.name, file.size, 'bytes');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –¥–ª—è What-if –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', e.target.result.length, '—Å–∏–º–≤–æ–ª–æ–≤');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞
        $('#whatIfFileName').textContent = file.name;
        $('#whatIfFileSize').textContent = formatFileSize(file.size);
        $('#whatIfFilePreview').classList.remove('hidden');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
        state.whatIfFile = {
          name: file.name,
          size: file.size,
          content: e.target.result,
          type: file.type
        };
        
        toast(`–î–æ–∫—É–º–µ–Ω—Ç "${file.name}" –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤`, 'success');
      };
      
      reader.readAsText(file);
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    window.addEventListener('load', init);

    // Add this new function after other functions
    function formatText(text) {
      let formatted = text || '';
      
      // –ó–∞–º–µ–Ω—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã
      formatted = formatted.replace(/\\n/g, '\n'); // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ \n
      formatted = formatted.replace(/\n\n/g, '\n\n'); // –î–≤–æ–π–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
      
      // –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ marked.parse —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –ª—É—á—à–µ
      return formatted;
    }
  </script>
</body>
</html>
</html>